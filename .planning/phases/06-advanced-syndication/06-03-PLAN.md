---
phase: 06-advanced-syndication
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - blocks/bluesky-pre-publish-panel.js
  - classes/BlueSky_Syndication_Service.php
  - classes/BlueSky_Async_Handler.php
  - classes/BlueSky_API_Handler.php
autonomous: true

must_haves:
  truths:
    - "Pre-publish panel shows editable syndication text with character counter"
    - "Custom syndication text is used as post text when syndicating to Bluesky"
    - "Category rules filter prevents syndication to accounts whose rules exclude the post"
    - "Global pause prevents all syndication when enabled"
    - "Post edits never re-syndicate (once syndicated, stays syndicated)"
  artifacts:
    - path: "blocks/bluesky-pre-publish-panel.js"
      provides: "Editable text field + character counter in pre-publish panel"
      contains: "_bluesky_syndication_text"
    - path: "classes/BlueSky_Syndication_Service.php"
      provides: "Global pause check and category filtering before syndication"
      contains: "global_pause"
    - path: "classes/BlueSky_Async_Handler.php"
      provides: "Custom text and category filtering in async syndication path"
      contains: "should_syndicate_to_account"
  key_links:
    - from: "classes/BlueSky_Syndication_Service.php"
      to: "classes/BlueSky_Account_Manager.php"
      via: "should_syndicate_to_account call before scheduling"
      pattern: "should_syndicate_to_account"
    - from: "classes/BlueSky_Async_Handler.php"
      to: "post meta _bluesky_syndication_text"
      via: "get_post_meta for custom text before API call"
      pattern: "_bluesky_syndication_text"
    - from: "classes/BlueSky_Syndication_Service.php"
      to: "plugin options global_pause"
      via: "get_option check at entry point"
      pattern: "global_pause"
---

<objective>
Wire editable syndication text into the pre-publish panel and connect category filtering + global pause into all syndication entry points (sync, async, manual retry).

Purpose: This plan connects the UI and data layer from Plans 01 and 02 into the actual syndication execution flow. Without this wiring, the new features would exist in isolation without affecting syndication behavior.

Output: Extended pre-publish panel, wired syndication service with filtering and pause, custom text used in API calls.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-syndication/06-RESEARCH.md
@.planning/phases/06-advanced-syndication/06-01-SUMMARY.md
@.planning/phases/06-advanced-syndication/06-02-SUMMARY.md
@blocks/bluesky-pre-publish-panel.js
@classes/BlueSky_Syndication_Service.php
@classes/BlueSky_Async_Handler.php
@classes/BlueSky_API_Handler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add editable text + character counter to pre-publish panel</name>
  <files>
    blocks/bluesky-pre-publish-panel.js
  </files>
  <action>
    1. In bluesky-pre-publish-panel.js, add a new renderEditableSyndicationText() method to the BlueSkyPrePublishPanel class:
       - Read meta._bluesky_syndication_text from this.props.meta
       - If empty, generate default from this.props.title + this.props.excerpt (same logic as sidebar panel)
       - Create textarea element with value set to the text (or generated default)
       - On change: call this.props.updateMeta({ _bluesky_syndication_text: e.target.value })
       - Below textarea: render character count using window.BlueSkyCharacterCounter.getCountStatus(displayText, 300)
       - Show "{count} / 300" with color #d63638 when over limit, #757575 when under
       - Add a "Reset to default" small link that sets meta to '' (empty string)
       - Style consistently with existing panel: borderTop: '1px solid #ddd', marginTop: '12px', paddingTop: '12px'
       - Label: "Post text:" with fontWeight: 600, fontSize: '13px'
       - Add placeholder: "Auto-generated from title and excerpt"

    2. In the render() method, call this.renderEditableSyndicationText() AFTER this.renderAccountSelection() and BEFORE the preview section:
       - Only render when syndication is NOT disabled (dontSyndicate !== '1')
       - Position it between account selection and the preview loading/display area

    3. Update the withSelect to also read 'title' and 'excerpt' from 'core/editor'.getEditedPostAttribute() — these may already be available from the existing loadPreview props, but ensure they're in the withSelect mapping.

    4. Ensure bluesky-character-counter is a dependency of bluesky-pre-publish-panel in the assets enqueue (check BlueSky_Assets_Service.php — if not already added as dependency, add it).
  </action>
  <verify>
    Grep bluesky-pre-publish-panel.js for 'renderEditableSyndicationText' — method exists.
    Grep bluesky-pre-publish-panel.js for '_bluesky_syndication_text' — meta field used.
    Grep bluesky-pre-publish-panel.js for 'BlueSkyCharacterCounter' — counter used.
  </verify>
  <done>
    Pre-publish panel shows editable syndication text with live character counter, positioned between account selection and preview. Text syncs with same post meta as sidebar panel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire global pause, category filtering, and custom text into syndication flow</name>
  <files>
    classes/BlueSky_Syndication_Service.php
    classes/BlueSky_Async_Handler.php
    classes/BlueSky_API_Handler.php
  </files>
  <action>
    1. In BlueSky_Syndication_Service::syndicate_post_to_bluesky():
       - Add global pause check as FIRST check, before the publish status check:
         ```php
         $options = get_option(BLUESKY_PLUGIN_OPTIONS, []);
         if (!empty($options['global_pause'])) {
             return; // All syndication paused
         }
         ```
       - This goes BEFORE the existing `if ('publish' === $new_status ...)` block

    2. In BlueSky_Syndication_Service::syndicate_post_multi_account():
       - After getting selected_account_ids and before delegating to async handler:
       - Filter selected_account_ids through category rules:
         ```php
         $account_manager = new BlueSky_Account_Manager();
         $filtered_account_ids = array_filter($selected_account_ids, function($account_id) use ($post_id, $account_manager) {
             return $account_manager->should_syndicate_to_account($post_id, $account_id);
         });
         if (empty($filtered_account_ids)) {
             return; // No accounts match category rules
         }
         ```
       - Use $filtered_account_ids (not $selected_account_ids) when calling async_handler->schedule_syndication() and in the sync fallback path

    3. In BlueSky_Syndication_Service::syndicate_post_multi_account() synchronous fallback:
       - After preparing post data (title, excerpt, image_url), add custom text lookup:
         ```php
         $custom_text = get_post_meta($post_id, '_bluesky_syndication_text', true);
         ```
       - If $custom_text is not empty, pass it as the post title parameter to api_handler->syndicate_post_to_bluesky() instead of $post->post_title
       - The existing API handler uses the title as the post text body, so this replaces the auto-generated text

    4. In BlueSky_Async_Handler::process_syndication():
       - Add global pause check at the top (same pattern as Syndication_Service):
         ```php
         $options = get_option(BLUESKY_PLUGIN_OPTIONS, []);
         if (!empty($options['global_pause'])) {
             return; // All syndication paused
         }
         ```
       - Add category filtering before the per-account loop:
         ```php
         $account_manager = $this->account_manager ?: new BlueSky_Account_Manager();
         $account_ids = array_filter($account_ids, function($account_id) use ($post_id, $account_manager) {
             return $account_manager->should_syndicate_to_account($post_id, $account_id);
         });
         if (empty($account_ids)) {
             update_post_meta($post_id, '_bluesky_syndication_status', 'completed');
             return;
         }
         ```
       - Add custom text lookup before the per-account loop:
         ```php
         $custom_text = get_post_meta($post_id, '_bluesky_syndication_text', true);
         $post_title = !empty($custom_text) ? $custom_text : $post->post_title;
         ```
       - Use $post_title instead of $post->post_title in the api->syndicate_post_to_bluesky() call

    5. In the single-account path of syndicate_post_to_bluesky() (the non-multi-account path):
       - Add custom text lookup before the API call:
         ```php
         $custom_text = get_post_meta($post_id, '_bluesky_syndication_text', true);
         $post_title_for_bluesky = !empty($custom_text) ? $custom_text : $post->post_title;
         ```
       - Use $post_title_for_bluesky instead of $post->post_title in the api_handler->syndicate_post_to_bluesky() call

    6. Verify the existing re-syndication guard is in place: check for _bluesky_syndicated meta BEFORE proceeding with syndication in both sync and async paths. This should already exist from Phase 1/3 — confirm and do NOT modify.
  </action>
  <verify>
    Grep BlueSky_Syndication_Service.php for 'global_pause' — check exists at entry point.
    Grep BlueSky_Syndication_Service.php for 'should_syndicate_to_account' — category filtering applied.
    Grep BlueSky_Syndication_Service.php for '_bluesky_syndication_text' — custom text used.
    Grep BlueSky_Async_Handler.php for 'global_pause' — check exists in async path.
    Grep BlueSky_Async_Handler.php for 'should_syndicate_to_account' — category filtering in async path.
    Grep BlueSky_Async_Handler.php for '_bluesky_syndication_text' — custom text used in async path.
  </verify>
  <done>
    Global pause blocks all syndication across all entry points. Category rules filter accounts before syndication. Custom syndication text replaces auto-generated title when set. All three features work in both sync and async paths.
  </done>
</task>

</tasks>

<verification>
1. Grep bluesky-pre-publish-panel.js for 'renderEditableSyndicationText', '_bluesky_syndication_text', 'BlueSkyCharacterCounter'
2. Grep BlueSky_Syndication_Service.php for 'global_pause', 'should_syndicate_to_account', '_bluesky_syndication_text'
3. Grep BlueSky_Async_Handler.php for 'global_pause', 'should_syndicate_to_account', '_bluesky_syndication_text'
4. Confirm _bluesky_syndicated guard still exists (no re-syndication on edits)
</verification>

<success_criteria>
- Pre-publish panel shows editable text + character counter matching sidebar panel
- Global pause check at top of BOTH syndicate_post_to_bluesky() AND process_syndication()
- Category filtering applied before account syndication in BOTH sync and async paths
- Custom syndication text used as post body when set, falls back to auto-generated title
- Re-syndication guard preserved (no duplicate Bluesky posts on WP post edits)
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-syndication/06-03-SUMMARY.md`
</output>
