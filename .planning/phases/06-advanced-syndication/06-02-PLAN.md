---
phase: 06-advanced-syndication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Account_Manager.php
  - classes/BlueSky_Settings_Service.php
  - templates/admin/settings-page.php
  - templates/admin/settings-category-rules.php
autonomous: true

must_haves:
  truths:
    - "Dedicated Category Rules tab exists in settings showing all accounts with category checkboxes"
    - "Category rules save per-account with include/exclude category lists"
    - "Global syndication pause toggle exists in settings and can be enabled/disabled"
    - "When no category rules are set for an account, all categories syndicate (default behavior)"
  artifacts:
    - path: "templates/admin/settings-category-rules.php"
      provides: "Category rules tab UI with per-account category checkboxes"
      contains: "category_rules"
    - path: "classes/BlueSky_Account_Manager.php"
      provides: "category_rules field in account data structure"
      contains: "category_rules"
    - path: "classes/BlueSky_Settings_Service.php"
      provides: "Category rules save handler and global pause setting"
      contains: "global_pause"
  key_links:
    - from: "templates/admin/settings-category-rules.php"
      to: "classes/BlueSky_Settings_Service.php"
      via: "form POST processed by handle_category_rules_save"
      pattern: "bluesky_category_rules"
    - from: "classes/BlueSky_Settings_Service.php"
      to: "classes/BlueSky_Account_Manager.php"
      via: "update_account with category_rules data"
      pattern: "update_account.*category_rules"
---

<objective>
Create the Category Rules settings tab with per-account category include/exclude configuration, extend account data structure for category rules, and add a global syndication pause toggle.

Purpose: Users need to control which categories syndicate to which accounts (routing rules) and the ability to pause all syndication for maintenance. These are settings-level features that don't require editor integration.

Output: New settings tab with category rules UI, extended account data, and global pause toggle.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-syndication/06-RESEARCH.md
@classes/BlueSky_Account_Manager.php
@classes/BlueSky_Settings_Service.php
@templates/admin/settings-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Account Manager with category_rules and add global pause setting</name>
  <files>
    classes/BlueSky_Account_Manager.php
    classes/BlueSky_Settings_Service.php
  </files>
  <action>
    1. In BlueSky_Account_Manager.php:
       - The account data structure already has 'auto_syndicate' field. Ensure 'category_rules' is included in the default structure: 'category_rules' => ['include' => [], 'exclude' => []]
       - In the add_account() method, ensure new accounts include: 'category_rules' => ['include' => [], 'exclude' => []]
       - In the update_account() method, add handling for 'category_rules' key:
         ```php
         if (isset($data['category_rules'])) {
             $accounts[$account_id]['category_rules'] = [
                 'include' => array_map('intval', $data['category_rules']['include'] ?? []),
                 'exclude' => array_map('intval', $data['category_rules']['exclude'] ?? [])
             ];
         }
         ```
       - Add a new public method should_syndicate_to_account($post_id, $account_id):
         - Get account data via get_account() (or access from accounts array)
         - If no category_rules set (both include and exclude empty), return true (default = syndicate everything)
         - Get post categories via get_the_category($post_id)
         - Extract term_ids into array
         - Check exclude rules first (higher priority): if post has any excluded category, return false
         - Check include rules (OR logic): if include rules exist and post has at least one included category, return true; if include rules exist but post has none, return false
         - If only exclude rules exist and post passed exclude check, return true
         - Handle edge case: post with no categories + include rules = don't syndicate

    2. In BlueSky_Settings_Service.php:
       - Add global_pause to the sanitize_options method: $sanitized['global_pause'] = isset($input['global_pause']) ? 1 : 0;
       - Add a render_global_pause_field() method that renders a checkbox for global_pause option
       - Register the global_pause field in the settings registration (alongside auto_syndicate)
       - Add a handle_category_rules_save() method:
         - Called from handle_account_actions() (or render_settings_page before template load)
         - Check for $_POST['bluesky_save_category_rules'] submission
         - Verify nonce 'bluesky_category_rules_nonce'
         - Loop through $_POST['bluesky_category_rules'] array, keyed by account_id
         - For each account: extract include[] and exclude[] arrays, sanitize with array_map('intval', ...)
         - Call $this->account_manager->update_account($account_id, ['category_rules' => $rules])
         - Add admin notice for success
       - Register a new settings section for global pause (can be on Account Settings tab or its own section)
  </action>
  <verify>
    Grep BlueSky_Account_Manager.php for 'category_rules' — field exists in data structure and update_account handles it.
    Grep BlueSky_Account_Manager.php for 'should_syndicate_to_account' — filtering method exists.
    Grep BlueSky_Settings_Service.php for 'global_pause' — setting exists.
    Grep BlueSky_Settings_Service.php for 'handle_category_rules_save' — save handler exists.
  </verify>
  <done>
    Account data structure supports category_rules, category filtering logic works with OR logic, global pause setting is registered, and category rules save handler processes form submissions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Category Rules tab UI and global pause toggle in settings page</name>
  <files>
    templates/admin/settings-page.php
    templates/admin/settings-category-rules.php
  </files>
  <action>
    1. In templates/admin/settings-page.php:
       - Add a new tab link in the nav section (after Discussions, before Shortcodes):
         ```php
         <a href="#syndication" aria-controls="syndication" class="privacy-settings-tab">
             <?php esc_html_e('Syndication', 'social-integration-for-bluesky'); ?>
         </a>
         ```
       - Add a new tab content section with id="syndication" matching the existing tab content pattern:
         - Include the global pause toggle at the top of this tab (checkbox + description)
         - Include the category rules template below the global pause
         - Use: include plugin_dir_path(BLUESKY_PLUGIN_FILE) . 'templates/admin/settings-category-rules.php';

    2. Create templates/admin/settings-category-rules.php:
       - Wrap in a form with POST method, action pointing to current page
       - Add nonce field: wp_nonce_field('bluesky_category_rules_nonce', '_bluesky_category_rules_nonce')
       - Get accounts from $this->account_manager->get_accounts()
       - Get all categories with get_categories(['hide_empty' => false])
       - If no accounts: show message "Connect at least one Bluesky account to configure category rules."
       - If no categories: show message "Create categories in WordPress to set up syndication rules."
       - For each account, render a card/section:
         - Account name and handle as heading
         - "Include categories" section with checkboxes (checkbox name: bluesky_category_rules[{account_id}][include][])
         - "Exclude categories" section with checkboxes (checkbox name: bluesky_category_rules[{account_id}][exclude][])
         - Pre-check boxes based on existing account category_rules data
         - Add help text: "Include: Only syndicate posts with these categories. Exclude: Never syndicate posts with these categories. If no rules are set, all posts syndicate."
       - Submit button: "Save Category Rules" (name="bluesky_save_category_rules")
       - Style using WordPress admin patterns: .card class or bordered div with padding, clear labels

    3. In the global pause toggle section (inside the Syndication tab):
       - Render checkbox for global_pause option from BLUESKY_PLUGIN_OPTIONS
       - Label: "Pause all syndication"
       - Description: "When enabled, no posts will be syndicated to any Bluesky account. Use this for maintenance or troubleshooting."
       - Style with warning color when enabled (red/orange text or border)
       - Save as part of the main settings form (not the category rules form)
  </action>
  <verify>
    File templates/admin/settings-category-rules.php exists with account loop, category checkboxes, and form submission.
    Grep templates/admin/settings-page.php for '#syndication' — tab exists.
    Grep templates/admin/settings-page.php for 'global_pause' — toggle exists in syndication tab.
  </verify>
  <done>
    Category Rules tab renders in settings with per-account category checkboxes (include/exclude), and global pause toggle is visible and functional within the Syndication tab.
  </done>
</task>

</tasks>

<verification>
1. Grep classes/BlueSky_Account_Manager.php for 'category_rules' and 'should_syndicate_to_account'
2. Grep classes/BlueSky_Settings_Service.php for 'global_pause' and 'handle_category_rules_save'
3. File templates/admin/settings-category-rules.php exists with form, checkboxes, and nonce
4. Grep templates/admin/settings-page.php for 'syndication' tab and 'global_pause'
</verification>

<success_criteria>
- Category Rules tab shows in settings with all accounts and their category mappings
- Include/exclude checkboxes save per-account category rules
- should_syndicate_to_account() method applies OR logic for includes, priority for excludes
- Global pause toggle is available and saves to plugin options
- Default behavior (no rules) syndicates all categories
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-syndication/06-02-SUMMARY.md`
</output>
