---
phase: 06-advanced-syndication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Post_Metabox.php
  - assets/js/bluesky-character-counter.js
  - blocks/bluesky-sidebar-panel.js
  - classes/BlueSky_Assets_Service.php
autonomous: true

must_haves:
  truths:
    - "Post text is editable per-post via sidebar panel with live character counter"
    - "Character counter accurately counts grapheme clusters matching Bluesky's 300 limit"
    - "Sidebar panel appears in Gutenberg editor document settings"
  artifacts:
    - path: "assets/js/bluesky-character-counter.js"
      provides: "Grapheme cluster counting utility with Intl.Segmenter + fallback"
      contains: "countGraphemes"
    - path: "blocks/bluesky-sidebar-panel.js"
      provides: "Gutenberg sidebar panel with editable syndication text"
      contains: "PluginDocumentSettingPanel"
    - path: "classes/BlueSky_Post_Metabox.php"
      provides: "_bluesky_syndication_text post meta registration"
      contains: "_bluesky_syndication_text"
  key_links:
    - from: "blocks/bluesky-sidebar-panel.js"
      to: "core/editor meta"
      via: "withSelect/withDispatch reading _bluesky_syndication_text"
      pattern: "_bluesky_syndication_text"
    - from: "blocks/bluesky-sidebar-panel.js"
      to: "assets/js/bluesky-character-counter.js"
      via: "window.BlueSkyCharacterCounter.countGraphemes"
      pattern: "BlueSkyCharacterCounter"
---

<objective>
Register editable syndication text post meta, create a grapheme-accurate character counting utility, and build a Gutenberg sidebar panel for editing syndication text while writing.

Purpose: Users need to customize the text that accompanies their syndicated Bluesky post, with accurate character counting that matches Bluesky's 300 grapheme limit. The sidebar panel provides editing during the writing workflow.

Output: New post meta field, character counter JS utility, and sidebar panel component.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-syndication/06-RESEARCH.md
@classes/BlueSky_Post_Metabox.php
@classes/BlueSky_Assets_Service.php
@blocks/bluesky-pre-publish-panel.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register syndication text post meta and create character counter utility</name>
  <files>
    classes/BlueSky_Post_Metabox.php
    assets/js/bluesky-character-counter.js
  </files>
  <action>
    1. In BlueSky_Post_Metabox::register_post_meta(), add a new register_post_meta call for '_bluesky_syndication_text':
       - show_in_rest: true (CRITICAL for Gutenberg access)
       - single: true
       - type: 'string'
       - default: '' (empty = auto-generate from title + excerpt at syndication time)
       - sanitize_callback: 'sanitize_textarea_field'
       - auth_callback: function() { return current_user_can('edit_posts'); }

    2. Create new file assets/js/bluesky-character-counter.js with:
       - countGraphemes(text) function using Intl.Segmenter API (granularity: 'grapheme') as primary
       - Fallback to text.length for browsers without Intl.Segmenter (simple fallback, no polyfill dependency)
       - getCountStatus(text, maxLength) returning { count, max, remaining, isOverLimit, percentage }
       - maxLength defaults to 300 (Bluesky limit)
       - Expose as window.BlueSkyCharacterCounter global object
       - Wrap in IIFE for encapsulation
       - Return 0 for empty/null/undefined text
  </action>
  <verify>
    Grep for '_bluesky_syndication_text' in BlueSky_Post_Metabox.php — confirms meta registered.
    File assets/js/bluesky-character-counter.js exists with countGraphemes and getCountStatus functions.
  </verify>
  <done>
    Post meta '_bluesky_syndication_text' is registered with show_in_rest: true and character counter utility is available globally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Gutenberg sidebar panel and enqueue scripts</name>
  <files>
    blocks/bluesky-sidebar-panel.js
    classes/BlueSky_Assets_Service.php
  </files>
  <action>
    1. Create blocks/bluesky-sidebar-panel.js:
       - Use IIFE wrapping (function(wp) { ... })(window.wp) pattern matching existing blocks
       - Import from wp.plugins (registerPlugin), wp.editPost (PluginDocumentSettingPanel), wp.element (Component), wp.data (withSelect, withDispatch), wp.compose (compose), wp.i18n (__)
       - Create BlueSkyDocumentPanel class component:
         - Read meta._bluesky_syndication_text via withSelect from 'core/editor'.getEditedPostAttribute('meta')
         - Also read title and excerpt for generating default text when meta is empty
         - Generate default text: title + "\n\n" + excerpt (trimmed to fit), only when meta field is empty
         - Render PluginDocumentSettingPanel with name 'bluesky-syndication-panel' and title 'Bluesky Post Text'
         - Inside panel: render a textarea (not TextareaControl — use plain HTML textarea for consistency with pre-publish panel pattern) with the custom text value
         - On change: dispatch editPost({ meta: { _bluesky_syndication_text: newValue } })
         - Below textarea: render character count display using window.BlueSkyCharacterCounter.getCountStatus()
         - Character count shows "{count} / 300" with color change to #d63638 when over limit
         - When text is empty, show placeholder text "Auto-generated from title and excerpt" in the textarea placeholder attribute
         - Add a "Reset to default" link/button that clears the meta back to '' (empty)
       - Register plugin with registerPlugin('bluesky-document-panel', { render: ConnectedPanel })
       - Only show panel when syndication is not disabled: check meta._bluesky_dont_syndicate !== '1'

    2. In BlueSky_Assets_Service.php, find where bluesky-pre-publish-panel is enqueued and add enqueuing for:
       - 'bluesky-character-counter' script: assets/js/bluesky-character-counter.js, no dependencies, loaded in footer
       - 'bluesky-sidebar-panel' script: blocks/bluesky-sidebar-panel.js, dependencies: ['wp-plugins', 'wp-edit-post', 'wp-element', 'wp-data', 'wp-compose', 'wp-i18n', 'bluesky-character-counter']
       - Both scripts should load on post editor screens only (same condition as pre-publish panel)
  </action>
  <verify>
    File blocks/bluesky-sidebar-panel.js exists with registerPlugin, PluginDocumentSettingPanel, and BlueSkyCharacterCounter usage.
    Grep BlueSky_Assets_Service.php for 'bluesky-sidebar-panel' and 'bluesky-character-counter' — both enqueued.
  </verify>
  <done>
    Sidebar panel registers in Gutenberg editor showing editable syndication text with live character count, and all required scripts are properly enqueued with correct dependencies.
  </done>
</task>

</tasks>

<verification>
1. Grep classes/BlueSky_Post_Metabox.php for '_bluesky_syndication_text' with 'show_in_rest' => true
2. File assets/js/bluesky-character-counter.js exists and contains countGraphemes, getCountStatus, BlueSkyCharacterCounter
3. File blocks/bluesky-sidebar-panel.js exists and contains PluginDocumentSettingPanel, _bluesky_syndication_text
4. Grep classes/BlueSky_Assets_Service.php for 'bluesky-sidebar-panel' and 'bluesky-character-counter'
</verification>

<success_criteria>
- _bluesky_syndication_text post meta registered with REST API visibility
- Character counter utility accurately counts graphemes with Intl.Segmenter
- Sidebar panel renders in Gutenberg with textarea + live character count
- Scripts properly enqueued with correct dependency chain
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-syndication/06-01-SUMMARY.md`
</output>
