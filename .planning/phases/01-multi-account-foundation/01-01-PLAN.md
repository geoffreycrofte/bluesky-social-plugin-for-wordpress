---
phase: 01-multi-account-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Account_Manager.php
  - classes/BlueSky_Helpers.php
  - social-integration-for-bluesky.php
autonomous: true

must_haves:
  truths:
    - "Feature toggle 'enable_multi_account' exists in bluesky_settings and defaults to false"
    - "When multi-account is enabled, existing single-account data migrates to bluesky_accounts option"
    - "Migration is idempotent — running twice produces the same result"
    - "Each account has a secure UUID, handle, encrypted app_password, DID, auto_syndicate flag, and is_active flag"
    - "Account CRUD methods (add, remove, get, get_all, update, set_active) work correctly"
    - "Migration backfills _bluesky_account_id post meta for previously syndicated posts"
  artifacts:
    - path: "classes/BlueSky_Account_Manager.php"
      provides: "Account CRUD, migration, UUID generation, feature toggle checking"
      contains: "class BlueSky_Account_Manager"
    - path: "classes/BlueSky_Helpers.php"
      provides: "Secure UUID generation helper"
      contains: "bluesky_generate_secure_uuid"
    - path: "social-integration-for-bluesky.php"
      provides: "Account Manager instantiation and migration hook"
      contains: "BlueSky_Account_Manager"
  key_links:
    - from: "social-integration-for-bluesky.php"
      to: "classes/BlueSky_Account_Manager.php"
      via: "require_once and instantiation"
      pattern: "new BlueSky_Account_Manager"
    - from: "classes/BlueSky_Account_Manager.php"
      to: "bluesky_accounts option"
      via: "get_option/update_option"
      pattern: "get_option.*bluesky_accounts"
    - from: "classes/BlueSky_Account_Manager.php"
      to: "bluesky_settings option"
      via: "migration reads old settings"
      pattern: "get_option.*bluesky_settings"
---

<objective>
Create the Account Manager class that provides multi-account data storage, CRUD operations, version-gated migration, and feature toggle checking. This is the foundation all other Phase 1 plans build on.

Purpose: Establish the data model and management layer before any UI or syndication changes reference it. Without this, no multi-account feature can function.

Output: `BlueSky_Account_Manager` class file, updated helpers with UUID generation, updated main plugin file with manager instantiation and migration hook.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-multi-account-foundation/01-CONTEXT.md
@.planning/phases/01-multi-account-foundation/01-RESEARCH.md
@social-integration-for-bluesky.php
@classes/BlueSky_Helpers.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlueSky_Account_Manager class with CRUD, migration, and feature toggle</name>
  <files>classes/BlueSky_Account_Manager.php, classes/BlueSky_Helpers.php</files>
  <action>
Create `classes/BlueSky_Account_Manager.php` with class `BlueSky_Account_Manager`. This is the central multi-account data layer.

**Constructor:** Accept no arguments. Load `bluesky_settings` option into `$this->options`. Register migration hook: `add_action('plugins_loaded', [$this, 'maybe_run_migration'])`.

**Feature Toggle Methods:**

1. `is_multi_account_enabled()`: Returns `(bool)` from `$this->options['enable_multi_account']` ?? false. This is the master switch.

2. `maybe_run_migration()`: Only runs when `is_multi_account_enabled()` returns true. Implements version-gated migration per research pattern:
   - Check `BLUESKY_SKIP_MIGRATION` constant for emergency bypass
   - Read `bluesky_schema_version` option (default 1)
   - If version < 2, call `migrate_to_v2()`
   - On success, update schema version to 2
   - On failure (WP_Error returned), log via `error_log()` and add admin notice

3. `migrate_to_v2()`: Migrate single-account to multi-account structure:
   - Idempotency check: if `get_option('bluesky_accounts')` already exists, return true
   - Read `bluesky_settings` option
   - If empty or no handle/app_password, return true (fresh install, nothing to migrate)
   - Generate UUID via `BlueSky_Helpers::bluesky_generate_secure_uuid()`
   - Create account array with keys: `id`, `name` ('Primary Account'), `handle`, `app_password` (already encrypted, copy as-is), `did`, `is_active` (true), `auto_syndicate` (true), `owner_id` (0), `created_at` (time())
   - Save to `bluesky_accounts` option
   - Save UUID to `bluesky_active_account` option
   - Save global settings (everything from old settings except handle/app_password/did) to `bluesky_global_settings` option
   - Backup old settings: `bluesky_settings_backup` and `bluesky_settings_backup_date`
   - Call `backfill_post_account_associations($uuid)`
   - Return true on success, WP_Error on failure

4. `backfill_post_account_associations($primary_account_id)`: Use `$wpdb` to find all posts with `_bluesky_syndicated = '1'` meta. For each, add `_bluesky_account_id` meta (only if not already set — idempotency). Also transform existing `_bluesky_syndication_bs_post_info` from plain JSON to account-keyed structure: `{account_uuid: existing_data}`.

**Account CRUD Methods:**

5. `get_accounts()`: Returns `get_option('bluesky_accounts', [])`. If multi-account is disabled, returns array with single account constructed from current `bluesky_settings` (handle, app_password, did) with a deterministic ID like 'default'.

6. `get_account($account_id)`: Returns single account from accounts array, or null if not found.

7. `get_active_account()`: Returns the account marked as active via `bluesky_active_account` option. Falls back to first account if active ID not found.

8. `add_account($data)`: Validates required fields (handle, app_password). Generates UUID. Encrypts app_password using `BlueSky_Helpers->bluesky_encrypt()`. Creates account entry. If first account, marks as active. Saves to `bluesky_accounts`. Returns account ID on success, WP_Error on failure.

9. `remove_account($account_id)`: Removes account from array. If removing active account, switches active to first remaining. Clears account cache (calls `bluesky_clear_account_cache` action). Returns orphaned post count for display.

10. `set_active_account($account_id)`: Updates `is_active` flag on all accounts (only one active at a time). Updates `bluesky_active_account` option.

11. `update_account($account_id, $data)`: Partial update of account fields. Used to update DID after auth, toggle auto_syndicate, etc.

12. `get_discussion_account()`: Returns the account ID configured for discussion display. Reads from `bluesky_global_settings['discussion_account']`, falls back to active account.

13. `set_discussion_account($account_id)`: Saves discussion account preference to `bluesky_global_settings['discussion_account']`.

**In `BlueSky_Helpers.php`**, add a new PUBLIC STATIC method `bluesky_generate_secure_uuid()`:
- Use `random_bytes(16)` (PHP 7.0+) to generate 16 bytes
- Set version nibble to 0100 (UUID v4)
- Set variant bits to 10
- Format as standard UUID string using `vsprintf('%s%s-%s-%s-%s-%s%s%s', str_split(bin2hex($data), 4))`
- This is a static method so it can be called without instantiation

Follow existing code conventions: ABSPATH check at top, PHPDoc on all methods, snake_case methods, 4-space indentation, K&R brace style.
  </action>
  <verify>
Run: `php -l classes/BlueSky_Account_Manager.php` — no syntax errors.
Run: `php -l classes/BlueSky_Helpers.php` — no syntax errors.
Grep: `grep -c 'function' classes/BlueSky_Account_Manager.php` — should show 12+ functions.
Grep: `grep 'bluesky_generate_secure_uuid' classes/BlueSky_Helpers.php` — function exists.
  </verify>
  <done>
BlueSky_Account_Manager class exists with all CRUD methods, migration logic, feature toggle check, and discussion account preference. BlueSky_Helpers has secure UUID generation. All files pass PHP lint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Account Manager into plugin initialization</name>
  <files>social-integration-for-bluesky.php</files>
  <action>
Update `social-integration-for-bluesky.php` to load and instantiate the Account Manager.

1. Add `require_once "classes/BlueSky_Account_Manager.php";` AFTER the BlueSky_Helpers require (line 31) and BEFORE BlueSky_API_Handler. The Account Manager must load early because its `plugins_loaded` hook runs migration.

2. Add instantiation BEFORE the API handler instantiation (around line 44):
   ```php
   $bluesky_account_manager = new BlueSky_Account_Manager();
   ```

3. The existing `$bluesky_api_handler = new BlueSky_API_Handler(get_option(BLUESKY_PLUGIN_OPTIONS))` stays as-is for now. Multi-account API handler changes happen in Plan 03 when syndication is updated.

4. Add `enable_multi_account` to the settings registration in `BlueSky_Plugin_Setup`. This requires adding a new field to `register_settings()`. However, since that's in `BlueSky_Plugin_Setup.php` which Plan 02 will modify, for THIS task only add the require_once and instantiation lines to the main plugin file.

Do NOT modify any other file in this task. Keep changes minimal and focused on wiring.
  </action>
  <verify>
Run: `php -l social-integration-for-bluesky.php` — no syntax errors.
Grep: `grep 'BlueSky_Account_Manager' social-integration-for-bluesky.php` — shows require_once and new instantiation.
Verify load order: Account Manager loads after Helpers, before API Handler.
  </verify>
  <done>
Main plugin file loads and instantiates BlueSky_Account_Manager. Plugin boots without errors. Migration hook is registered on plugins_loaded.
  </done>
</task>

</tasks>

<verification>
1. `php -l classes/BlueSky_Account_Manager.php` passes
2. `php -l classes/BlueSky_Helpers.php` passes
3. `php -l social-integration-for-bluesky.php` passes
4. Account Manager class has methods: is_multi_account_enabled, maybe_run_migration, migrate_to_v2, backfill_post_account_associations, get_accounts, get_account, get_active_account, add_account, remove_account, set_active_account, update_account, get_discussion_account, set_discussion_account
5. UUID generation uses random_bytes(16) for security
6. Migration is idempotent (checks bluesky_accounts existence before running)
7. Migration preserves encrypted app_password as-is (no re-encryption)
8. Feature toggle defaults to false (opt-in per user decision)
</verification>

<success_criteria>
- BlueSky_Account_Manager class provides complete CRUD for multi-account data
- Migration transforms single-account bluesky_settings to multi-account bluesky_accounts
- Feature toggle gates migration (only runs when enabled per user decision)
- Post meta backfill associates existing syndicated posts with migrated account
- All PHP files pass syntax check
- Plugin loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-account-foundation/01-01-SUMMARY.md`
</output>
