---
phase: 01-multi-account-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - classes/BlueSky_Post_Metabox.php
  - classes/BlueSky_Plugin_Setup.php
  - classes/BlueSky_API_Handler.php
  - blocks/bluesky-pre-publish-panel.js
autonomous: true

must_haves:
  truths:
    - "When multi-account enabled, post editor shows checkboxes to select which accounts to syndicate to"
    - "Accounts with auto_syndicate=true are pre-checked on new posts"
    - "On publish, syndication loops over each selected account and creates a Bluesky post per account"
    - "Per-account syndication results stored in account-keyed structure in _bluesky_syndication_bs_post_info"
    - "When multi-account disabled, syndication works exactly as before (single account)"
    - "Gutenberg pre-publish panel shows account selection when multi-account enabled"
  artifacts:
    - path: "classes/BlueSky_Post_Metabox.php"
      provides: "Multi-account selection checkboxes in classic editor metabox"
      contains: "_bluesky_syndication_accounts"
    - path: "classes/BlueSky_Plugin_Setup.php"
      provides: "Updated syndicate_post_to_bluesky() that loops over selected accounts"
      contains: "_bluesky_syndication_accounts"
    - path: "classes/BlueSky_API_Handler.php"
      provides: "Factory method to create per-account API handler instances"
      contains: "create_for_account"
    - path: "blocks/bluesky-pre-publish-panel.js"
      provides: "Account selection checkboxes in Gutenberg pre-publish panel"
      contains: "bluesky_syndication_accounts"
  key_links:
    - from: "classes/BlueSky_Plugin_Setup.php"
      to: "classes/BlueSky_API_Handler.php"
      via: "Per-account API handler creation for syndication loop"
      pattern: "create_for_account|new BlueSky_API_Handler"
    - from: "classes/BlueSky_Plugin_Setup.php"
      to: "_bluesky_syndication_accounts post meta"
      via: "Reading selected accounts before syndication"
      pattern: "get_post_meta.*_bluesky_syndication_accounts"
    - from: "classes/BlueSky_Post_Metabox.php"
      to: "_bluesky_syndication_accounts post meta"
      via: "Saving selected accounts on post save"
      pattern: "update_post_meta.*_bluesky_syndication_accounts"
---

<objective>
Update syndication to support multiple accounts: per-post account selection in both classic editor and Gutenberg, syndication loop that creates Bluesky posts on each selected account, and per-account result storage in the account-keyed post meta structure.

Purpose: Users who connect multiple accounts expect to syndicate to all of them (per user decision). The selection UI and syndication execution must both be updated — not just the UI.

Output: Updated metabox with account checkboxes, updated syndication handler with per-account loop, API handler factory method, updated pre-publish panel.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-multi-account-foundation/01-CONTEXT.md
@.planning/phases/01-multi-account-foundation/01-RESEARCH.md
@.planning/phases/01-multi-account-foundation/01-01-SUMMARY.md
@.planning/phases/01-multi-account-foundation/01-02-SUMMARY.md
@classes/BlueSky_Post_Metabox.php
@classes/BlueSky_Plugin_Setup.php
@classes/BlueSky_API_Handler.php
@blocks/bluesky-pre-publish-panel.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-account API handler factory and update syndication loop</name>
  <files>classes/BlueSky_API_Handler.php, classes/BlueSky_Plugin_Setup.php</files>
  <action>
**In `BlueSky_API_Handler.php`**, add a static factory method:

1. `public static function create_for_account($account)`: Creates a new BlueSky_API_Handler instance configured for a specific account. The `$account` parameter is an account array from BlueSky_Account_Manager.
   - Build a minimal options array that the API handler needs: `['handle' => $account['handle'], 'app_password' => $account['app_password']]`
   - The app_password is already encrypted in storage — the API handler's authenticate() method must decrypt it. Check how the existing code handles this. If authenticate() expects plaintext, decrypt before passing. If it expects encrypted, pass as-is.
   - Return `new self($options)`.
   - This avoids modifying the API handler's core logic — just a factory to create per-account instances.

**In `BlueSky_Plugin_Setup.php`**, update `syndicate_post_to_bluesky()`:

2. At the top of the method (after the existing status/type checks), add multi-account branching:

   ```php
   $account_manager = new BlueSky_Account_Manager();

   if ($account_manager->is_multi_account_enabled()) {
       $this->syndicate_post_multi_account($post_id, $post);
       return;
   }

   // ... existing single-account syndication code remains unchanged ...
   ```

3. Add new method `syndicate_post_multi_account($post_id, $post)`:
   - Get selected accounts: `$selected_accounts = get_post_meta($post_id, '_bluesky_syndication_accounts', true)`
   - If empty, check for accounts with auto_syndicate=true: `$account_manager->get_accounts()` filtered by auto_syndicate
   - If still no accounts, return (nothing to syndicate)
   - Check `_bluesky_dont_syndicate` meta (same as existing logic)
   - Check `_bluesky_syndicated` meta (same as existing logic) — but for multi-account, this needs refinement: a post can be syndicated to some accounts but not others. Use `_bluesky_syndication_bs_post_info` keyed structure to check per-account.

   - For each selected account:
     a. Check if already syndicated to this specific account (key exists in `_bluesky_syndication_bs_post_info`)
     b. Create per-account API handler: `$api = BlueSky_API_Handler::create_for_account($account)`
     c. Prepare post data (same as existing: title, permalink, excerpt, image_url)
     d. Call `$api->syndicate_post_to_bluesky($title, $permalink, $excerpt, $image_url)`
     e. Store result in account-keyed structure

   - Build `$syndication_results` array keyed by account UUID:
     ```php
     $syndication_results[$account_id] = [
         'uri' => $result['uri'] ?? '',
         'cid' => $result['cid'] ?? '',
         'syndicated_at' => time(),
         'success' => ($result !== false)
     ];
     ```

   - Save results: `update_post_meta($post_id, '_bluesky_syndication_bs_post_info', wp_json_encode($syndication_results))`
   - Mark as syndicated: `update_post_meta($post_id, '_bluesky_syndicated', true)`
   - Also save `_bluesky_account_id` pointing to the first successful account (for backward compatibility with Discussion display)

   - Fire existing hooks: `do_action('bluesky_before_syndicating_post', $post_id)` before loop, `do_action('bluesky_after_syndicating_post', $post_id, ...)` after loop.

**Important:** The existing single-account syndication code must remain UNTOUCHED for when multi-account is disabled. The branching at the top ensures backward compatibility.
  </action>
  <verify>
Run: `php -l classes/BlueSky_API_Handler.php` — no syntax errors.
Run: `php -l classes/BlueSky_Plugin_Setup.php` — no syntax errors.
Grep: `grep 'create_for_account' classes/BlueSky_API_Handler.php` — factory method exists.
Grep: `grep 'syndicate_post_multi_account' classes/BlueSky_Plugin_Setup.php` — multi-account syndication method exists.
Grep: `grep '_bluesky_syndication_accounts' classes/BlueSky_Plugin_Setup.php` — reads selected accounts from post meta.
  </verify>
  <done>
API handler has factory method for per-account instances. Syndication branches on multi-account toggle: single-account path unchanged, multi-account path loops over selected accounts, creates per-account API handlers, stores account-keyed results in post meta. Backward compatible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add account selection UI in classic editor metabox and Gutenberg panel</name>
  <files>classes/BlueSky_Post_Metabox.php, blocks/bluesky-pre-publish-panel.js</files>
  <action>
**In `BlueSky_Post_Metabox.php`:**

1. **Update constructor** to accept optional Account Manager (or instantiate internally):
   ```php
   private $account_manager;

   public function __construct() {
       // existing code...
       $this->account_manager = new BlueSky_Account_Manager();
   }
   ```

2. **Register new post meta** in `register_post_meta()`:
   ```php
   register_post_meta('post', '_bluesky_syndication_accounts', [
       'show_in_rest' => true,
       'single' => true,
       'type' => 'string', // JSON-encoded array of account UUIDs
       'default' => '',
       'auth_callback' => function() { return current_user_can('edit_posts'); }
   ]);
   ```

3. **Update metabox rendering** in the method that renders the meta box HTML (likely `render_bluesky_meta_box` or `add_bluesky_meta_box`):
   - After the existing "Don't syndicate" checkbox, add conditional multi-account UI:
   ```php
   if ($this->account_manager->is_multi_account_enabled()) {
       $accounts = $this->account_manager->get_accounts();
       $selected = get_post_meta($post->ID, '_bluesky_syndication_accounts', true);
       $selected = $selected ? json_decode($selected, true) : [];

       // If new post and no selection yet, pre-select auto-syndicate accounts
       if (empty($selected) && get_post_status($post->ID) !== 'publish') {
           $selected = array_keys(array_filter($accounts, function($a) {
               return !empty($a['auto_syndicate']);
           }));
       }

       echo '<p><strong>' . esc_html__('Syndicate to:', 'social-integration-for-bluesky') . '</strong></p>';

       foreach ($accounts as $account) {
           $checked = in_array($account['id'], $selected) ? 'checked' : '';
           printf(
               '<label style="display:block;margin:4px 0;"><input type="checkbox" name="bluesky_syndication_accounts[]" value="%s" %s> %s (@%s)</label>',
               esc_attr($account['id']),
               $checked,
               esc_html($account['name']),
               esc_html($account['handle'])
           );
       }
   }
   ```

4. **Update save handler** in `save_bluesky_meta_box()`:
   ```php
   if (isset($_POST['bluesky_syndication_accounts'])) {
       $accounts = array_map('sanitize_text_field', $_POST['bluesky_syndication_accounts']);
       update_post_meta($post_id, '_bluesky_syndication_accounts', wp_json_encode($accounts));
   }
   ```

5. **Interaction with "Don't syndicate":** When "Don't syndicate" is checked, the account checkboxes should be visually disabled/grayed out. Add inline JS or CSS class toggle.

**In `blocks/bluesky-pre-publish-panel.js`:**

6. **Add account selection to Gutenberg pre-publish panel:**
   - The existing panel shows a "Don't syndicate" toggle. Add account checkboxes below it when multi-account is enabled.
   - Use `wp_localize_script()` to pass account data from PHP. In `BlueSky_Post_Metabox->enqueue_metabox_scripts()`, add:
     ```php
     if ($this->account_manager->is_multi_account_enabled()) {
         wp_localize_script('bluesky-pre-publish', 'blueskyAccounts', [
             'enabled' => true,
             'accounts' => array_values($this->account_manager->get_accounts())
         ]);
     }
     ```
   - In the JS, check `window.blueskyAccounts.enabled`. If true, render CheckboxControl for each account.
   - Read/write `_bluesky_syndication_accounts` post meta via `wp.data.select('core/editor').getEditedPostAttribute('meta')`.
   - Pre-select accounts with auto_syndicate=true for new posts.

Follow existing patterns: nonce field for classic editor, `useSelect`/`useDispatch` or `wp.data` for Gutenberg.
  </action>
  <verify>
Run: `php -l classes/BlueSky_Post_Metabox.php` — no syntax errors.
Grep: `grep '_bluesky_syndication_accounts' classes/BlueSky_Post_Metabox.php` — post meta registered and saved.
Grep: `grep 'bluesky_syndication_accounts' classes/BlueSky_Post_Metabox.php` — checkbox rendering exists.
Grep: `grep 'blueskyAccounts' blocks/bluesky-pre-publish-panel.js` — account data used in Gutenberg panel.
Grep: `grep 'blueskyAccounts' classes/BlueSky_Post_Metabox.php` — data localized for script.
  </verify>
  <done>
Classic editor metabox shows account selection checkboxes with auto-syndicate pre-selection. Gutenberg pre-publish panel shows same checkboxes via localized data. Selected accounts saved as JSON in _bluesky_syndication_accounts post meta. "Don't syndicate" disables account selection. All works only when multi-account is enabled; single-account mode unchanged.
  </done>
</task>

</tasks>

<verification>
1. `php -l classes/BlueSky_API_Handler.php` passes
2. `php -l classes/BlueSky_Plugin_Setup.php` passes
3. `php -l classes/BlueSky_Post_Metabox.php` passes
4. When multi-account disabled: syndication works identically to before (single account, no UI changes)
5. When multi-account enabled with 2+ accounts:
   - New post shows account checkboxes in metabox, auto-syndicate accounts pre-checked
   - Publishing syndicates to each selected account
   - Post meta `_bluesky_syndication_bs_post_info` contains account-keyed JSON structure
   - Each account's syndication result has uri, cid, syndicated_at, success
6. Gutenberg pre-publish panel shows account selection when multi-account enabled
7. "Don't syndicate" checkbox overrides and prevents all syndication
</verification>

<success_criteria>
- Syndication loops over selected accounts when multi-account enabled (per user decision: "syndication execution included in Phase 1")
- Per-account API handler instances created for syndication (not sharing auth state)
- Results stored in account-keyed structure (per user decision: post meta evolves from single blob)
- Auto-syndication pre-selects accounts with toggle on (per user decision)
- Single-account mode completely unchanged
- Both classic and Gutenberg editors support account selection
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-account-foundation/01-03-SUMMARY.md`
</output>
