---
phase: 01-multi-account-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - classes/BlueSky_Plugin_Setup.php
  - assets/js/bluesky-social-admin.js
  - assets/css/bluesky-social-admin.css
autonomous: true

must_haves:
  truths:
    - "Admin sees 'Enable Multi-Account' toggle on Account Settings tab"
    - "When multi-account disabled, settings page shows current single-account UI unchanged"
    - "When multi-account enabled, account management section appears with connected accounts list"
    - "Admin can add a new account with name, handle, and app password"
    - "Admin can remove a connected account with confirmation dialog"
    - "Each account shows connection status (authenticated, expired, error)"
    - "Admin can switch active display account"
    - "Admin can toggle auto-syndication per account"
    - "Discussion account dropdown appears in Discussions tab when multi-account enabled"
  artifacts:
    - path: "classes/BlueSky_Plugin_Setup.php"
      provides: "Multi-account toggle field, account CRUD form handlers, account list rendering, discussion account setting"
      contains: "enable_multi_account"
    - path: "assets/js/bluesky-social-admin.js"
      provides: "Progressive disclosure toggle, remove confirmation dialog"
      contains: "enable_multi_account"
    - path: "assets/css/bluesky-social-admin.css"
      provides: "Account list table styling, status badges, toggle styling"
      contains: "bluesky-account-list"
  key_links:
    - from: "classes/BlueSky_Plugin_Setup.php"
      to: "classes/BlueSky_Account_Manager.php"
      via: "Account Manager method calls for CRUD"
      pattern: "account_manager.*add_account|remove_account|get_accounts"
    - from: "assets/js/bluesky-social-admin.js"
      to: "Account Settings tab"
      via: "Toggle visibility of multi-account section"
      pattern: "enable_multi_account"
---

<objective>
Add multi-account UI to the WordPress settings page: feature toggle, account list with status indicators, add/remove account forms, active account switcher, auto-syndication toggles, and discussion account selector.

Purpose: Administrators need a UI to manage multiple Bluesky accounts. This plan provides the admin interface that calls BlueSky_Account_Manager (created in Plan 01) for all data operations.

Output: Updated settings page with multi-account management section, progressive disclosure based on toggle state.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-multi-account-foundation/01-CONTEXT.md
@.planning/phases/01-multi-account-foundation/01-RESEARCH.md
@.planning/phases/01-multi-account-foundation/01-01-SUMMARY.md
@classes/BlueSky_Plugin_Setup.php
@assets/js/bluesky-social-admin.js
@assets/css/bluesky-social-admin.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-account settings registration and form handling to Plugin Setup</name>
  <files>classes/BlueSky_Plugin_Setup.php</files>
  <action>
Modify `BlueSky_Plugin_Setup.php` to integrate multi-account management into the existing settings page.

**1. Store Account Manager reference:**
Update the constructor to accept and store the Account Manager instance. Add `private $account_manager;` property. Update constructor signature: `__construct(BlueSky_API_Handler $api_handler, BlueSky_Account_Manager $account_manager = null)`. Store it: `$this->account_manager = $account_manager;`. The null default preserves backward compatibility. Also update `social-integration-for-bluesky.php` to pass the account manager: `new BlueSky_Plugin_Setup($bluesky_api_handler, $bluesky_account_manager)`.

**2. Register the enable_multi_account setting:**
In `register_settings()`, add the `enable_multi_account` field to the `bluesky_settings` sanitization. It should be registered as a boolean checkbox in the Account Settings section. Add it to the settings field registration alongside existing fields. The field name in the option array: `bluesky_settings[enable_multi_account]`.

**3. Add account CRUD form processing:**
Add a new method `handle_account_actions()` called at the top of `render_settings_page()`. This method processes POST requests for:

a. **Add account** (`$_POST['bluesky_add_account']`):
   - Verify nonce: `check_admin_referer('bluesky_add_account')`
   - Validate: handle and app_password required
   - Call `$this->account_manager->add_account([name, handle, app_password])`
   - Test authentication immediately: create temp API handler with new credentials, call `authenticate()`
   - If auth succeeds, update account DID via `$this->account_manager->update_account($id, ['did' => $did])`
   - Show success/error admin notice

b. **Remove account** (`$_POST['bluesky_remove_account']`):
   - Verify nonce: `check_admin_referer('bluesky_remove_account_' . $account_id)`
   - Call `$this->account_manager->remove_account($account_id)`
   - Show notice with orphaned post count if any

c. **Switch active account** (`$_POST['bluesky_switch_account']`):
   - Verify nonce: `check_admin_referer('bluesky_switch_account_' . $account_id)`
   - Call `$this->account_manager->set_active_account($account_id)`
   - Clear content transients for the old account
   - Show success notice

d. **Toggle auto-syndication** (`$_POST['bluesky_toggle_auto_syndicate']`):
   - Verify nonce
   - Call `$this->account_manager->update_account($account_id, ['auto_syndicate' => $value])`

e. **Set discussion account** (`$_POST['bluesky_set_discussion_account']`):
   - Verify nonce
   - Call `$this->account_manager->set_discussion_account($account_id)`

**4. Render multi-account UI in settings page:**
In `render_settings_page()`, within the Account Settings tab content:

a. Add **Enable Multi-Account** checkbox after the existing account fields:
   ```html
   <h3>Multi-Account</h3>
   <label>
     <input type="checkbox" name="bluesky_settings[enable_multi_account]" value="1" {checked}>
     Enable Multi-Account Support
   </label>
   <p class="description">Connect multiple Bluesky accounts for syndication and display switching.</p>
   ```

b. Add **multi-account section** (wrapped in `<div id="bluesky-multi-account-section" style="display:none;">`) that shows/hides based on toggle:

   - **Connected Accounts Table**: `<table class="wp-list-table widefat fixed striped bluesky-account-list">` with columns: Name, Handle, Status, Auto-Syndicate, Actions.
   - Each row shows account data from `$this->account_manager->get_accounts()`.
   - Status column: Call the Bluesky API to check auth status (use a lightweight check, or show cached status). Display as badge: green checkmark for authenticated, yellow warning for expired, red X for error.
   - Auto-Syndicate column: Toggle checkbox per account.
   - Actions column: "Make Active" button (disabled if already active), "Remove" button with JS confirmation.
   - Active account shown with a visual indicator (dashicon or badge).

   - **Add New Account Form**: Standard WordPress form-table layout with fields: Account Name, Bluesky Handle, App Password. Submit button "Add Account".

c. In the **Discussions tab**, add a "Discussion Thread Account" dropdown when multi-account is enabled:
   ```html
   <h3>Discussion Thread Source</h3>
   <p>Choose which account's Bluesky thread to display for discussions.</p>
   <select name="bluesky_discussion_account">
     {foreach account as option}
   </select>
   ```

**Important per user decisions:**
- Keep one-page tab approach (no new admin pages)
- When multi-account disabled: identical to current UX, no new UI complexity
- When multi-account enabled: account management section appears within Account Settings tab
- Use progressive disclosure: multi-account section hidden by default, revealed by toggle
  </action>
  <verify>
Run: `php -l classes/BlueSky_Plugin_Setup.php` — no syntax errors.
Run: `php -l social-integration-for-bluesky.php` — no syntax errors.
Grep: `grep 'enable_multi_account' classes/BlueSky_Plugin_Setup.php` — found in registration and rendering.
Grep: `grep 'handle_account_actions' classes/BlueSky_Plugin_Setup.php` — form handler exists.
Grep: `grep 'bluesky_add_account' classes/BlueSky_Plugin_Setup.php` — add account processing exists.
Grep: `grep 'bluesky_remove_account' classes/BlueSky_Plugin_Setup.php` — remove account processing exists.
Grep: `grep 'bluesky_discussion_account' classes/BlueSky_Plugin_Setup.php` — discussion selector exists.
  </verify>
  <done>
Settings page renders multi-account toggle, account list table with status/actions, add/remove forms, auto-syndication toggles, and discussion account dropdown. All form actions use proper nonce verification. Progressive disclosure hides multi-account UI when toggle is off. PHP lint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add progressive disclosure JavaScript and account list CSS styling</name>
  <files>assets/js/bluesky-social-admin.js, assets/css/bluesky-social-admin.css</files>
  <action>
**In `assets/js/bluesky-social-admin.js`**, add to the existing IIFE (inside the `(function ($) { ... })(jQuery)` wrapper):

1. **Progressive disclosure for multi-account section:**
   - On page load, check if `#bluesky-enable-multi-account` checkbox is checked.
   - If checked, show `#bluesky-multi-account-section` with `slideDown()`.
   - If unchecked, hide it.
   - On checkbox change, toggle visibility with animation.
   - Example:
     ```javascript
     var multiAccountToggle = $('#bluesky-enable-multi-account');
     var multiAccountSection = $('#bluesky-multi-account-section');

     if (multiAccountToggle.length) {
         // Set initial state
         if (multiAccountToggle.is(':checked')) {
             multiAccountSection.show();
         } else {
             multiAccountSection.hide();
         }

         // Toggle on change
         multiAccountToggle.on('change', function() {
             multiAccountSection.slideToggle(200);
         });
     }
     ```

2. **Remove account confirmation:**
   - Attach to `.bluesky-remove-account-btn` click event.
   - Show `confirm()` dialog: "Remove this account? Discussion threads for posts syndicated with this account will no longer load."
   - If cancelled, prevent form submission.

3. **Auto-syndication toggle:**
   - Attach to `.bluesky-auto-syndicate-toggle` change event.
   - Submit the parent form via AJAX or standard POST to save the toggle immediately.
   - Use a small spinner or checkmark to indicate save status.

**In `assets/css/bluesky-social-admin.css`**, add styles for multi-account UI:

1. **Account list table:**
   ```css
   .bluesky-account-list { margin-top: 1em; }
   .bluesky-account-list .bluesky-account-active { font-weight: bold; }
   .bluesky-account-list .column-status { width: 140px; }
   .bluesky-account-list .column-auto-syndicate { width: 120px; text-align: center; }
   .bluesky-account-list .column-actions { width: 180px; }
   ```

2. **Status badges:**
   ```css
   .bluesky-status-authenticated { color: #00a32a; }
   .bluesky-status-expired { color: #dba617; }
   .bluesky-status-error { color: #d63638; }
   .bluesky-status-badge { display: inline-flex; align-items: center; gap: 4px; }
   .bluesky-status-badge .dashicons { font-size: 16px; width: 16px; height: 16px; }
   ```

3. **Active account indicator:**
   ```css
   .bluesky-active-indicator {
       display: inline-block;
       background: #2271b1;
       color: #fff;
       padding: 2px 8px;
       border-radius: 3px;
       font-size: 11px;
       margin-left: 8px;
   }
   ```

4. **Multi-account section:**
   ```css
   #bluesky-multi-account-section {
       margin-top: 1.5em;
       padding-top: 1.5em;
       border-top: 1px solid #c3c4c7;
   }
   ```

Follow existing code conventions: jQuery wrapped in IIFE, kebab-case CSS classes with bluesky- prefix.
  </action>
  <verify>
Open `assets/js/bluesky-social-admin.js` — JavaScript is syntactically valid (no console errors).
Open `assets/css/bluesky-social-admin.css` — CSS classes for account list, status badges, and multi-account section exist.
Grep: `grep 'multi-account' assets/js/bluesky-social-admin.js` — toggle logic exists.
Grep: `grep 'bluesky-account-list' assets/css/bluesky-social-admin.css` — table styling exists.
  </verify>
  <done>
JavaScript handles progressive disclosure of multi-account section, remove confirmation dialogs, and auto-syndication toggles. CSS provides clean styling for account list table, status badges, and active account indicators consistent with WordPress admin design.
  </done>
</task>

</tasks>

<verification>
1. `php -l classes/BlueSky_Plugin_Setup.php` passes
2. Settings page shows "Enable Multi-Account" checkbox in Account Settings tab
3. When unchecked, no multi-account UI visible (identical to current experience)
4. When checked, multi-account section appears with account list and add form
5. Add account form submits with nonce protection and validates fields
6. Remove account shows confirmation dialog before proceeding
7. Active account can be switched and visual indicator updates
8. Auto-syndication toggle per account saves correctly
9. Discussion account dropdown appears in Discussions tab when multi-account enabled
10. CSS styles render cleanly in WordPress admin
</verification>

<success_criteria>
- Multi-account feature toggle works as progressive disclosure (hidden by default per user decision)
- Account CRUD operations flow through settings page to Account Manager
- All form actions have CSRF protection via nonces
- Account status (authenticated/expired/error) displayed per account
- Discussion account global setting available in Discussions tab
- No visual regressions when multi-account is disabled
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-account-foundation/01-02-SUMMARY.md`
</output>
