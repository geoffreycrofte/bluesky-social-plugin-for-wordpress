---
phase: 01-multi-account-foundation
plan: 04
type: execute
wave: 4
depends_on: ["01-02", "01-03"]
files_modified:
  - classes/BlueSky_Plugin_Setup.php
  - classes/BlueSky_Discussion_Display.php
  - classes/BlueSky_Helpers.php
  - classes/BlueSky_Render_Front.php
  - assets/js/bluesky-async-loader.js
  - blocks/bluesky-profile-card.js
  - blocks/bluesky-posts-feed.js
  - classes/widgets/BlueSky_Profile_Widget.php
  - classes/widgets/BlueSky_Posts_Widget.php
autonomous: true

must_haves:
  truths:
    - "Switching accounts shows the correct account's profile and posts on the frontend"
    - "Frontend blocks display the selected account's data, not stale cached data from another account"
    - "Discussion thread loads from the configured discussion account's Bluesky post"
    - "User can select which account to display content from in Gutenberg block settings and classic widgets"
    - "When multi-account disabled, all frontend display and discussion work identically to before"
  artifacts:
    - path: "classes/BlueSky_Plugin_Setup.php"
      provides: "Async handlers updated with account_id parameter support"
      contains: "account_id"
    - path: "classes/BlueSky_Discussion_Display.php"
      provides: "Discussion display reads account-keyed syndication data"
      contains: "discussion_account"
    - path: "classes/BlueSky_Helpers.php"
      provides: "Account-scoped cache key generation"
      contains: "account_id"
    - path: "classes/BlueSky_Render_Front.php"
      provides: "Render methods accept account_id for per-account rendering"
      contains: "account_id"
    - path: "assets/js/bluesky-async-loader.js"
      provides: "Passes account_id from data-bluesky-params to AJAX requests"
      contains: "account_id"
    - path: "blocks/bluesky-profile-card.js"
      provides: "Account selector dropdown in profile card block inspector controls"
      contains: "account_id"
    - path: "blocks/bluesky-posts-feed.js"
      provides: "Account selector dropdown in posts feed block inspector controls"
      contains: "account_id"
    - path: "classes/widgets/BlueSky_Profile_Widget.php"
      provides: "Account dropdown in classic profile widget settings"
      contains: "account_id"
    - path: "classes/widgets/BlueSky_Posts_Widget.php"
      provides: "Account dropdown in classic posts widget settings"
      contains: "account_id"
  key_links:
    - from: "assets/js/bluesky-async-loader.js"
      to: "classes/BlueSky_Plugin_Setup.php (async handlers)"
      via: "AJAX POST with account_id in params JSON"
      pattern: "account_id"
    - from: "classes/BlueSky_Plugin_Setup.php"
      to: "classes/BlueSky_API_Handler.php"
      via: "Per-account API handler creation in async handlers"
      pattern: "create_for_account"
    - from: "classes/BlueSky_Discussion_Display.php"
      to: "classes/BlueSky_Account_Manager.php"
      via: "Get discussion account preference"
      pattern: "get_discussion_account"
    - from: "classes/BlueSky_Helpers.php"
      to: "transient keys"
      via: "Account ID embedded in cache key"
      pattern: "bluesky_.*account.*profile|bluesky_.*account.*posts"
---

<objective>
Thread account_id through the async loading pipeline, update cache keys for account scoping, and update Discussion display to work with the account-keyed syndication data structure.

Purpose: Without these changes, switching accounts would show stale cached data, async-loaded blocks would always show the default account, and discussion threads would break for multi-account syndicated posts.

Output: Updated async handlers, account-scoped cache keys, discussion display that reads account-keyed post info, render methods that accept account_id.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-multi-account-foundation/01-CONTEXT.md
@.planning/phases/01-multi-account-foundation/01-RESEARCH.md
@.planning/phases/01-multi-account-foundation/01-01-SUMMARY.md
@.planning/phases/01-multi-account-foundation/01-02-SUMMARY.md
@.planning/phases/01-multi-account-foundation/01-03-SUMMARY.md
@classes/BlueSky_Plugin_Setup.php
@classes/BlueSky_Discussion_Display.php
@classes/BlueSky_Helpers.php
@classes/BlueSky_Render_Front.php
@assets/js/bluesky-async-loader.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update cache keys, async handlers, and render methods for account scoping</name>
  <files>classes/BlueSky_Helpers.php, classes/BlueSky_Plugin_Setup.php, classes/BlueSky_Render_Front.php, assets/js/bluesky-async-loader.js</files>
  <action>
**In `BlueSky_Helpers.php`**, update transient key methods to include account_id:

1. Update `get_profile_transient_key()` to accept optional `$account_id` parameter:
   ```php
   public function get_profile_transient_key($account_id = null) {
       $base = BLUESKY_PLUGIN_TRANSIENT . '-profile';
       return $account_id ? $base . '-' . $account_id : $base;
   }
   ```

2. Update `get_posts_transient_key()` similarly — add optional `$account_id` as first parameter:
   ```php
   public function get_posts_transient_key($account_id = null, $limit = null, ...) {
       $base = BLUESKY_PLUGIN_TRANSIENT . '-posts-';
       if ($account_id) {
           $base .= $account_id . '-';
       }
       return $base . esc_attr($limit ?? ...) . '-' . ...;
   }
   ```

3. Update `get_access_token_transient_key()`, `get_refresh_token_transient_key()`, `get_did_transient_key()` similarly with optional `$account_id`.

4. Add new method `clear_account_cache($account_id)`:
   ```php
   public function clear_account_cache($account_id) {
       global $wpdb;
       $prefix = BLUESKY_PLUGIN_TRANSIENT . '-';
       // Delete all transients containing this account_id
       $wpdb->query($wpdb->prepare(
           "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
           '%' . $wpdb->esc_like($prefix . '%' . $account_id) . '%'
       ));
   }
   ```

**IMPORTANT:** All existing calls to these methods that DON'T pass account_id must continue working (null default = current behavior). Search the codebase for all callers and verify backward compatibility. The key callers are in `BlueSky_API_Handler.php` and `BlueSky_Render_Front.php`. With null defaults, they require NO changes for single-account mode.

**In `BlueSky_Plugin_Setup.php`**, update the three async AJAX handlers:

5. Update `ajax_async_posts()`:
   - Read `account_id` from params: `$account_id = sanitize_text_field($params['account_id'] ?? '');`
   - If account_id provided AND multi-account enabled:
     - Get account from manager: `$account = $account_manager->get_account($account_id);`
     - Create per-account API handler: `$api = BlueSky_API_Handler::create_for_account($account);`
     - Create render with per-account handler: `$render = new BlueSky_Render_Front($api);`
   - If no account_id, use existing `$this->api_handler` (backward compatible)

6. Update `ajax_async_profile()` the same way — read account_id from params, create per-account handler if provided.

7. Update `ajax_async_auth()`:
   - If `account_id` provided in POST params and multi-account enabled:
     - Get account, create per-account handler, authenticate with that handler
   - Otherwise, use existing handler (backward compatible)

**In `BlueSky_Render_Front.php`**, update render methods to pass account_id through for caching:

8. In shortcode methods (`bluesky_profile_card_shortcode`, `bluesky_last_posts_shortcode`), add `account_id` to accepted attributes. Default to empty/null. Pass through to fetch/cache methods. When rendering the skeleton placeholder for async loading, include `account_id` in the `data-bluesky-params` JSON.

9. In `render_bluesky_posts_list()` and `render_bluesky_profile_card()`, accept optional `account_id` in the `$attributes` array. Pass to helpers when generating cache keys.

**In `assets/js/bluesky-async-loader.js`:**

10. The loader already reads `data-bluesky-params` and sends them as `params` POST field. Account_id will be included in that JSON automatically when the PHP skeleton renderer puts it in `data-bluesky-params`. No changes needed to the JS loader logic itself — it already passes all params through.

    However, verify this is true by reading the loadElement function. If it only sends specific known fields, update it to pass all params through.

    Actually, looking at the code: the JS sends `paramsRaw` directly as a string. The PHP async handlers decode it with `json_decode`. So account_id in the params JSON will flow through automatically. **No JS changes needed for the params pipeline.**

    But for the auth async type, account_id needs to be sent. Currently auth sends no params. If we need per-account auth check, add account_id to the auth body:
    ```javascript
    if (type === "auth") {
        var params = JSON.parse(paramsRaw);
        if (params.account_id) {
            body.append("account_id", params.account_id);
        }
    }
    ```

Keep all changes backward compatible: when no account_id is provided, behavior is identical to current.
  </action>
  <verify>
Run: `php -l classes/BlueSky_Helpers.php` — no syntax errors.
Run: `php -l classes/BlueSky_Plugin_Setup.php` — no syntax errors.
Run: `php -l classes/BlueSky_Render_Front.php` — no syntax errors.
Grep: `grep 'account_id' classes/BlueSky_Helpers.php` — account_id parameter in cache key methods.
Grep: `grep 'account_id' classes/BlueSky_Plugin_Setup.php` — async handlers read account_id.
Grep: `grep 'account_id' classes/BlueSky_Render_Front.php` — render methods accept account_id.
Grep: `grep 'account_id' assets/js/bluesky-async-loader.js` — auth handler sends account_id if present.
  </verify>
  <done>
Cache keys are account-scoped (include account_id when provided). Async handlers create per-account API handlers when account_id is provided. Render methods pass account_id through to cache and skeleton placeholders. JS async loader forwards account_id for auth checks. All changes are backward compatible — null account_id produces identical behavior to current code.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Discussion Display for account-keyed syndication data</name>
  <files>classes/BlueSky_Discussion_Display.php</files>
  <action>
Update `BlueSky_Discussion_Display.php` to work with the account-keyed `_bluesky_syndication_bs_post_info` structure and the configurable discussion account.

**1. Add Account Manager reference:**
Update constructor to instantiate Account Manager:
```php
private $account_manager;

public function __construct($api_handler) {
    // existing code...
    $this->account_manager = new BlueSky_Account_Manager();
}
```

**2. Create helper method `get_syndication_info_for_discussion($post_id)`:**
This method abstracts the logic of extracting the correct Bluesky post info for discussion display:

```php
private function get_syndication_info_for_discussion($post_id) {
    $raw = get_post_meta($post_id, '_bluesky_syndication_bs_post_info', true);
    if (empty($raw)) {
        return null;
    }

    $data = json_decode($raw, true);
    if (!is_array($data)) {
        return null;
    }

    // Check if this is the OLD format (single blob with 'uri' key directly)
    // vs NEW format (account-keyed structure)
    if (isset($data['uri'])) {
        // Old format — return as-is for backward compatibility
        return $data;
    }

    // New account-keyed format: {account_uuid: {uri, cid, ...}, ...}
    if ($this->account_manager->is_multi_account_enabled()) {
        // Get configured discussion account
        $discussion_account_id = $this->account_manager->get_discussion_account();

        // Try the configured discussion account first
        if ($discussion_account_id && isset($data[$discussion_account_id])) {
            return $data[$discussion_account_id];
        }

        // Fall back to first successful syndication
        foreach ($data as $account_id => $info) {
            if (!empty($info['uri']) && (!isset($info['success']) || $info['success'])) {
                return $info;
            }
        }
    }

    // Final fallback: return first entry
    return reset($data) ?: null;
}
```

**3. Update all places that read `_bluesky_syndication_bs_post_info`:**
Search the file for all references to `_bluesky_syndication_bs_post_info` (there are at least 4 locations based on grep results: lines ~138, ~584, ~626, ~679). At each location:

- Replace the direct `get_post_meta()` + `json_decode()` pattern with a call to `$this->get_syndication_info_for_discussion($post_id)`.
- Ensure the returned data is used the same way (accessing `['uri']`, `['cid']`, etc.).

For example, if existing code is:
```php
$bs_post_info = get_post_meta($post_id, '_bluesky_syndication_bs_post_info', true);
$bs_post_data = json_decode($bs_post_info, true);
$post_uri = $bs_post_data['uri'] ?? '';
```

Replace with:
```php
$bs_post_data = $this->get_syndication_info_for_discussion($post_id);
$post_uri = $bs_post_data['uri'] ?? '';
```

**4. Update the discussion thread API handler to use per-account auth:**
When fetching the discussion thread from Bluesky API, if multi-account is enabled, create a per-account API handler for the discussion account:

```php
if ($this->account_manager->is_multi_account_enabled()) {
    $discussion_account_id = $this->account_manager->get_discussion_account();
    $account = $this->account_manager->get_account($discussion_account_id);
    if ($account) {
        $api = BlueSky_API_Handler::create_for_account($account);
        // Use $api instead of $this->api_handler for discussion thread fetch
    }
}
```

This ensures the discussion thread is fetched using the correct account's authentication.

**5. Update AJAX refresh handler:**
The `ajax_refresh_discussion()` method also reads post info. Apply the same pattern.

**Important:** All changes must be backward compatible. When multi-account is disabled OR when `_bluesky_syndication_bs_post_info` contains old format data, behavior must be identical to current.
  </action>
  <verify>
Run: `php -l classes/BlueSky_Discussion_Display.php` — no syntax errors.
Grep: `grep 'get_syndication_info_for_discussion' classes/BlueSky_Discussion_Display.php` — helper method exists and is called.
Grep: `grep 'discussion_account' classes/BlueSky_Discussion_Display.php` — reads discussion account preference.
Grep: `grep 'account_manager' classes/BlueSky_Discussion_Display.php` — Account Manager is used.
Count calls to get_post_meta for _bluesky_syndication_bs_post_info — should be 0 or 1 (centralized in helper). Old direct reads should be replaced.
  </verify>
  <done>
Discussion display reads account-keyed syndication data, selects the configured discussion account's thread, falls back gracefully for old format data. Per-account API handler used for discussion thread fetch when multi-account enabled. All 4+ references to _bluesky_syndication_bs_post_info centralized through helper method. Backward compatible with single-account mode.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add account selector UI to Gutenberg blocks and classic widgets</name>
  <files>blocks/bluesky-profile-card.js, blocks/bluesky-posts-feed.js, classes/BlueSky_Plugin_Setup.php, classes/widgets/BlueSky_Profile_Widget.php, classes/widgets/BlueSky_Posts_Widget.php</files>
  <action>
This task covers phase success criterion #6: "User can switch which account to display content from (profile cards, feeds)."

**In `BlueSky_Plugin_Setup.php` — pass account data to block scripts:**

1. In the method that registers/enqueues Gutenberg block scripts (likely `register_gutenberg_blocks()` or `enqueue_block_editor_assets()`), add `wp_localize_script` to pass account data to block JS:
   - Get accounts from `$this->account_manager->get_accounts()` (guard with `is_multi_account_enabled()`)
   - Build options array: `[['value' => '', 'label' => 'Active Account (default)'], ['value' => $id, 'label' => "$name (@$handle)"]]` for each account
   - Localize as `blueskyBlockData` with key `accounts` (the options array)
   - Apply to both block script handles (`bluesky-profile-card` and `bluesky-posts-feed`)

2. Add `accountId` to the block's `attributes` array in the PHP `register_block_type` calls:
   ```php
   'accountId' => ['type' => 'string', 'default' => '']
   ```

**In `blocks/bluesky-profile-card.js`:**

3. Add `accountId` attribute to block registration:
   ```javascript
   accountId: { type: 'string', default: '' }
   ```

4. Add `SelectControl` for account selection in `InspectorControls`:
   - Only show when `window.blueskyBlockData && window.blueskyBlockData.accounts.length > 2` (more than just the default option = 2+ real accounts)
   - Label: "Display Account"
   - Options: from `window.blueskyBlockData.accounts`
   - Value: `attributes.accountId`
   - onChange: `setAttributes({ accountId: value })`
   - Place in a separate `PanelBody` titled "Account" before existing display toggles
   - The `accountId` is automatically passed to `ServerSideRender` which sends it to PHP render callback

   **This file uses `wp.element.createElement` pattern (NOT JSX).** Follow existing code style exactly. `SelectControl` should already be available from `wp.components`.

**In `blocks/bluesky-posts-feed.js`:**

5. Same pattern as profile card: add `accountId` attribute and `SelectControl` in `InspectorControls`.

**In `classes/widgets/BlueSky_Profile_Widget.php`:**

6. Add `account_id` to widget instance fields (default: empty string = active account).
7. In `form()` method: add a `<select>` dropdown for account selection:
   - Get accounts from `BlueSky_Account_Manager` (instantiate or get global instance)
   - Only show dropdown when multi-account enabled AND 2+ accounts exist
   - Options: "Active Account (default)" + each account as `{name} (@{handle})`
   - Use `$this->get_field_id('account_id')` and `$this->get_field_name('account_id')` for the select element
8. In `update()` method: sanitize `account_id` from `$new_instance`
9. In `widget()` method: pass `account_id` from instance to the render shortcode/method

**In `classes/widgets/BlueSky_Posts_Widget.php`:**

10. Same pattern as Profile Widget: add account_id to instance, form dropdown, update sanitization, pass to render.

**Important:** When multi-account is disabled OR only 1 account exists, no account selector is shown (progressive disclosure). Default (empty) = uses global active account.
  </action>
  <verify>
1. Grep both JS block files for `accountId` attribute — exists in block registration
2. Grep both JS block files for `SelectControl` with account options — selector rendering exists
3. Grep both JS block files for `blueskyBlockData` — account data accessed
4. Grep Plugin_Setup for `blueskyBlockData` — localized script data
5. Grep Plugin_Setup for `accountId` in block registration attributes
6. `php -l classes/widgets/BlueSky_Profile_Widget.php` — no syntax errors
7. `php -l classes/widgets/BlueSky_Posts_Widget.php` — no syntax errors
8. Grep both widget files for `account_id` in form() and widget() methods
  </verify>
  <done>
Both Gutenberg blocks have account selector dropdown in inspector controls (visible only when 2+ accounts). Both classic widgets have account dropdown in their settings form. Account data passed from PHP to JS via wp_localize_script. accountId attribute registered in both JS and PHP block definitions. All backward compatible — no selector shown when multi-account disabled or single account.
  </done>
</task>

</tasks>

<verification>
1. `php -l` passes for all modified files
2. Cache keys include account_id when provided, exclude it when not (backward compatible)
3. Async AJAX handlers create per-account API handlers when account_id provided
4. Discussion display correctly reads account-keyed post info format
5. Discussion display falls back to old format for pre-migration posts
6. Discussion uses configured discussion account preference from settings
7. Frontend blocks can request specific account data via account_id in params
8. Account switching triggers cache clear for old account
9. Single-account mode: all behavior identical to pre-Phase-1
</verification>

<success_criteria>
- Async pipeline threads account_id through (per user decision: "AJAX handlers must accept and use account_id parameter")
- Cache prevents cross-account data pollution (per research pitfall #3)
- Discussion display works with account-keyed structure (per user decision: "one account selectable via global setting")
- Old/new post meta formats both handled (backward compatibility for pre-migration posts)
- No regressions in single-account mode
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-account-foundation/01-04-SUMMARY.md`
</output>
