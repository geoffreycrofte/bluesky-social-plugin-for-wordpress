---
phase: 04-error-handling-ux
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - classes/BlueSky_Health_Dashboard.php
  - social-integration-for-bluesky.php
  - classes/BlueSky_Plugin_Setup.php
  - templates/admin/settings-page.php
  - classes/BlueSky_Settings_Service.php
  - assets/css/bluesky-admin.css
autonomous: true

must_haves:
  truths:
    - "Admin dashboard widget shows account statuses, last syndication, API health, cache status, and pending retries"
    - "Dashboard widget has manual refresh button (no auto-refresh)"
    - "Settings page last tab cache status area is reworked into health section"
    - "Recent activity log (last 5-10 events) shown in health widget"
  artifacts:
    - path: "classes/BlueSky_Health_Dashboard.php"
      provides: "Dashboard widget with full health summary and manual refresh"
      contains: "register_widget"
    - path: "templates/admin/settings-page.php"
      provides: "Reworked health section replacing cache-only status"
      contains: "bluesky-health-section"
  key_links:
    - from: "classes/BlueSky_Health_Dashboard.php"
      to: "classes/BlueSky_Activity_Logger.php"
      via: "get_recent_events() for activity log display"
      pattern: "get_recent_events"
    - from: "classes/BlueSky_Health_Dashboard.php"
      to: "wp_ajax"
      via: "AJAX handler for manual refresh"
      pattern: "wp_ajax_bluesky_refresh_health"
---

<objective>
Create the admin dashboard health widget and rework the settings page cache status area into a comprehensive health section. The dashboard widget shows account statuses, last syndication, API health, cache status, pending retries, and recent activity log with a manual refresh button.

Purpose: Give admins immediate visibility into plugin health from the WordPress dashboard and the plugin settings page.
Output: New BlueSky_Health_Dashboard class + reworked settings page health section.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-handling-ux/04-RESEARCH.md
@.planning/phases/04-error-handling-ux/04-01-PLAN.md
@classes/BlueSky_Account_Manager.php
@classes/BlueSky_Circuit_Breaker.php
@classes/BlueSky_Rate_Limiter.php
@classes/BlueSky_Settings_Service.php
@templates/admin/settings-page.php
@classes/BlueSky_Plugin_Setup.php
@social-integration-for-bluesky.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlueSky_Health_Dashboard class with dashboard widget</name>
  <files>classes/BlueSky_Health_Dashboard.php, social-integration-for-bluesky.php, classes/BlueSky_Plugin_Setup.php</files>
  <action>
Create `classes/BlueSky_Health_Dashboard.php` — registers a WordPress admin dashboard widget showing plugin health.

Per user decisions:
- Dashboard widget shows full summary: account statuses, last syndication time/result, API health (circuit breaker state), cache status, and pending retries
- Dashboard widget uses manual refresh button (no auto-refresh via Heartbeat)
- Recent activity log (last 5-10 syndication events across posts) shown in health widget

Constructor registers hooks:
- `add_action('wp_dashboard_setup', [$this, 'register_widget']);`
- `add_action('wp_ajax_bluesky_refresh_health', [$this, 'handle_refresh']);`

Constructor accepts dependencies: `BlueSky_Account_Manager $account_manager`

**Methods:**

1. `register_widget()` — Calls `wp_add_dashboard_widget('bluesky_health_widget', __('Bluesky Integration Health', 'social-integration-for-bluesky'), [$this, 'render_widget'])`

2. `render_widget()` — Renders the widget HTML:
   - Get health data from transient first (5-min cache): `get_transient('bluesky_health_data')`
   - If no transient, call `collect_health_data()` and store in transient for 5 minutes
   - Sections (use `<div class="bluesky-health-section">` for each):
     a. **Account Status** — List each account with icon and status text:
        - Active (green dashicons-yes-alt), Paused/circuit open (yellow dashicons-clock), Rate limited (yellow dashicons-clock), Auth issue (red dashicons-warning)
     b. **Last Syndication** — Time + result of most recent syndication from activity log. "No recent syndication" if none.
     c. **API Health** — Circuit breaker status across accounts. "All systems operational" if all closed. Otherwise list affected accounts.
     d. **Cache Status** — Brief summary of transient cache state (profile cached/not, posts cached/not)
     e. **Pending Retries** — Count of posts with status 'pending', 'retrying', 'rate_limited', or 'circuit_open'
     f. **Recent Activity** — Last 5 events from BlueSky_Activity_Logger::get_recent_events(5), each showing time + message
   - Footer with manual refresh button and link to settings health section:
     ```html
     <p class="bluesky-widget-footer">
       <button type="button" class="button button-small" id="bluesky-refresh-health">
         <span class="dashicons dashicons-update"></span> Refresh
       </button>
       <a href="settings_url#health">View detailed health</a>
     </p>
     ```
   - Inline JavaScript for refresh button (keep it simple — inline `<script>` block):
     ```javascript
     jQuery('#bluesky-refresh-health').on('click', function(e) {
         e.preventDefault();
         var btn = jQuery(this);
         btn.prop('disabled', true).find('.dashicons').addClass('spin');
         jQuery.post(ajaxurl, {
             action: 'bluesky_refresh_health',
             nonce: '<?php echo wp_create_nonce("bluesky_refresh_health"); ?>'
         }, function(response) {
             if (response.success) location.reload();
         }).always(function() {
             btn.prop('disabled', false).find('.dashicons').removeClass('spin');
         });
     });
     ```

3. `private function collect_health_data()` — Gathers health data from various sources:
   - Account statuses from Account Manager + Circuit Breaker + Rate Limiter
   - Last syndication from Activity Logger
   - Cache status from transient checks (profile + posts transient keys)
   - Pending retries via WP_Query meta query for posts with _bluesky_syndication_status in ('pending', 'retrying', 'rate_limited', 'circuit_open')
   - Recent activity from Activity Logger

4. `handle_refresh()` — AJAX handler:
   - `check_ajax_referer('bluesky_refresh_health', 'nonce')`
   - `delete_transient('bluesky_health_data')`
   - `wp_send_json_success()`

Add `require_once "classes/BlueSky_Health_Dashboard.php";` to social-integration-for-bluesky.php after Activity Logger require.

Update Plugin_Setup constructor to instantiate: `$this->health_dashboard = new BlueSky_Health_Dashboard($account_manager);` Add property `private $health_dashboard;`.
  </action>
  <verify>
Run PHP syntax check: `/Users/CRG/Library/Application\ Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Health_Dashboard.php`
Run: `grep -c 'register_widget\|render_widget\|collect_health_data\|handle_refresh\|bluesky_health_widget' classes/BlueSky_Health_Dashboard.php` — should return 5+.
Run: `grep 'BlueSky_Health_Dashboard' classes/BlueSky_Plugin_Setup.php` — should show instantiation.
  </verify>
  <done>Dashboard widget registered with wp_add_dashboard_widget showing account statuses, last syndication, API health, cache status, pending retries, and recent activity log. Manual refresh button clears transient and reloads. Widget instantiated in Plugin_Setup.</done>
</task>

<task type="auto">
  <name>Task 2: Rework settings page cache status into health section</name>
  <files>templates/admin/settings-page.php, classes/BlueSky_Settings_Service.php, assets/css/bluesky-admin.css</files>
  <action>
Per user decision: "Rework the existing cache status area in the last settings tab into the health section (don't add a new tab, enhance what's there)"

The existing `display_cache_status()` in BlueSky_Settings_Service generates an `<aside class="bluesky-cache-status">` section on the settings page (rendered in `templates/admin/settings-page.php`).

**A. Update templates/admin/settings-page.php:**

Find the line `<?php echo $this->display_cache_status(); ?>` and replace with `<?php echo $this->display_health_section(); ?>`. This replaces the cache-only view with a comprehensive health section.

**B. Add `display_health_section()` method to BlueSky_Settings_Service:**

Create a new method `public function display_health_section()` that returns HTML string. This method replaces (does not call) the old `display_cache_status()` — keep the old method for backward compatibility but it won't be called.

The health section HTML structure (with id="health" for anchor linking from dashboard widget):

```html
<aside class="bluesky-health-section" id="health">
  <h3 class="bluesky-health-title">Plugin Health</h3>

  <!-- Account Status -->
  <div class="bluesky-health-block">
    <h4>Account Status</h4>
    <ul class="bluesky-health-accounts">
      <!-- For each account: icon + handle + status text -->
    </ul>
  </div>

  <!-- API Health -->
  <div class="bluesky-health-block">
    <h4>API Health</h4>
    <p>Circuit breaker status text</p>
  </div>

  <!-- Cache Status (preserved from original, slightly reformatted) -->
  <div class="bluesky-health-block">
    <h4>Cache Status</h4>
    <!-- Profile, Posts, Access Token, Refresh Token cache status -->
    <!-- Same data as original display_cache_status() but in health block format -->
  </div>

  <!-- Recent Activity -->
  <div class="bluesky-health-block">
    <h4>Recent Activity</h4>
    <ul class="bluesky-health-activity">
      <!-- Last 5 events from Activity Logger -->
    </ul>
    <p class="description">If empty: "No recent activity recorded."</p>
  </div>
</aside>
```

The method needs access to Account Manager, Circuit Breaker, Rate Limiter, and Activity Logger. Create new instances inside the method (consistent with how display_cache_status creates Helpers instances).

**C. Add minimal CSS** to `assets/css/bluesky-admin.css` (or create if doesn't exist):

If there's an existing admin CSS file, add to it. If not, check how existing styles are loaded. Add:

```css
.bluesky-health-section { margin-top: 20px; }
.bluesky-health-block { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
.bluesky-health-block:last-child { border-bottom: none; }
.bluesky-health-block h4 { margin: 0 0 8px; }
.bluesky-health-accounts { list-style: none; padding: 0; margin: 0; }
.bluesky-health-accounts li { padding: 4px 0; }
.bluesky-health-accounts .dashicons { font-size: 16px; width: 16px; height: 16px; margin-right: 4px; vertical-align: text-bottom; }
.bluesky-health-activity { list-style: none; padding: 0; margin: 0; }
.bluesky-health-activity li { padding: 3px 0; font-size: 13px; }
.bluesky-health-activity .bluesky-activity-time { color: #666; margin-right: 8px; }
```

Check where admin styles are enqueued in BlueSky_Assets_Service and ensure the CSS file is loaded on the settings page. If styles are currently inline or in an existing CSS file, add there instead.
  </action>
  <verify>
Run PHP syntax check: `/Users/CRG/Library/Application\ Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Settings_Service.php`
Run: `grep 'display_health_section\|bluesky-health-section' templates/admin/settings-page.php` — should show new method call.
Run: `grep 'bluesky-health-section\|bluesky-health-block' classes/BlueSky_Settings_Service.php` — should show health section HTML.
  </verify>
  <done>Settings page cache status area reworked into comprehensive health section showing account status, API health, cache status, and recent activity. Old cache-only view replaced. Accessible via #health anchor from dashboard widget link.</done>
</task>

</tasks>

<verification>
1. Dashboard widget appears on WordPress admin dashboard
2. Widget shows all required sections: accounts, last syndication, API health, cache, retries, activity
3. Manual refresh button clears transient and reloads
4. Settings page health section replaces old cache-only status
5. Health section has id="health" anchor for deep linking
6. CSS styles render health sections cleanly
</verification>

<success_criteria>
- wp_add_dashboard_widget registers 'bluesky_health_widget' on wp_dashboard_setup
- Health data cached in transient for 5 minutes with manual refresh override
- Settings page shows comprehensive health section (not just cache status)
- Activity log events displayed in both locations
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling-ux/04-03-SUMMARY.md`
</output>
