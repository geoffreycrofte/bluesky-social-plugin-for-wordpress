---
phase: 04-error-handling-ux
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Admin_Notices.php
  - assets/js/bluesky-syndication-notice.js
  - assets/js/bluesky-admin-notices.js
  - classes/BlueSky_Assets_Service.php
autonomous: true

must_haves:
  truths:
    - "Expired credentials trigger a persistent admin notice banner with link to settings page"
    - "Multiple broken accounts are grouped into a single notice"
    - "Notices are dismissible but return after 24 hours if issue persists"
    - "Partial syndication failures show per-account status on post edit screen"
    - "Failed/partial syndication notices use friendly tone with per-account detail"
  artifacts:
    - path: "classes/BlueSky_Admin_Notices.php"
      provides: "Enhanced admin notices with persistent dismissal and per-account status"
      contains: "expired_credentials_notice"
    - path: "assets/js/bluesky-admin-notices.js"
      provides: "AJAX persistent dismissal handler"
      contains: "bluesky_dismiss_notice"
  key_links:
    - from: "classes/BlueSky_Admin_Notices.php"
      to: "wp_options/user_meta"
      via: "get_user_meta for dismissal persistence"
      pattern: "get_user_meta.*bluesky_.*notice"
    - from: "assets/js/bluesky-admin-notices.js"
      to: "classes/BlueSky_Admin_Notices.php"
      via: "AJAX bluesky_dismiss_notice action"
      pattern: "wp_ajax_bluesky_dismiss_notice"
---

<objective>
Enhance BlueSky_Admin_Notices to add persistent dismissible notices for critical issues (expired credentials, circuit breaker), per-account syndication status on post edit screen, and AJAX-powered notice dismissal with 24-hour return.

Purpose: Users see actionable persistent notices for critical issues (not just post-edit screen notices) and get per-account detail when syndication partially fails.
Output: Enhanced BlueSky_Admin_Notices class + new admin notices JS file.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-handling-ux/04-RESEARCH.md
@classes/BlueSky_Admin_Notices.php
@classes/BlueSky_Account_Manager.php
@classes/BlueSky_Circuit_Breaker.php
@classes/BlueSky_Assets_Service.php
@assets/js/bluesky-syndication-notice.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add persistent notice system and per-account status to BlueSky_Admin_Notices</name>
  <files>classes/BlueSky_Admin_Notices.php</files>
  <action>
Enhance the existing BlueSky_Admin_Notices class to add three new capabilities:

**A. Persistent admin notice for expired credentials** (cross-page, not just post edit screen)

Add new method `expired_credentials_notice()` hooked to `admin_notices`:
- Check all accounts via BlueSky_Account_Manager for auth status. The Account Manager's `get_all_accounts()` returns accounts; check each account's stored auth data validity. For practical purposes, check if the account has a stored `last_auth_error` flag OR if the circuit breaker is open due to auth failures. Use `get_option('bluesky_account_auth_errors', [])` as a simple registry of account IDs with auth issues (this option gets set by the error translator integration in Plan 05).
- If no accounts have issues, return early.
- Check dismissal: `get_user_meta(get_current_user_id(), 'bluesky_expired_creds_dismissed', true)` — if set and `time() < $dismissed_until`, return early (still dismissed).
- Per user decision: Multiple broken accounts grouped into single notice. Show up to 5 account handles explicitly, then "...and X more" pattern.
- Render: `<div class="notice notice-error is-dismissible" data-dismissible="bluesky_expired_creds_dismissed">` with message like:
  - Single account: "The Bluesky account @handle needs re-authentication. <a href='settings_url'>Update credentials</a>"
  - Multiple: "Bluesky accounts @handle1, @handle2 need re-authentication. <a href='settings_url'>Update credentials</a>"
- Per user decision: No visible severity levels — use `notice-error` class (WordPress default) but the message text conveys urgency, not color.

**B. Persistent admin notice for circuit breaker open** (cross-page)

Add new method `circuit_breaker_notice()` hooked to `admin_notices`:
- Check if any accounts have open circuit breakers via BlueSky_Circuit_Breaker.
- If no open breakers, return early.
- Check dismissal via user meta key `bluesky_circuit_breaker_dismissed` (same 24-hour pattern).
- Per user decision: "Bluesky requests paused due to repeated errors. Will resume automatically." — friendly explanation.
- Render as `notice-warning is-dismissible` with `data-dismissible` attribute.

**C. Enhanced post edit screen notice with per-account detail**

Modify existing `syndication_status_notice()` method:
- For `failed` and `partial` statuses, show per-account breakdown.
- Per user decision: "Account A: Posted successfully. Account B: Failed — expired credentials."
- Get `_bluesky_syndication_accounts_completed` and `_bluesky_syndication_failed_accounts` post meta.
- For failed accounts, `_bluesky_syndication_failed_accounts` is an array keyed by account handle with error info as values. Display each with friendly status.
- For completed accounts, show "Posted successfully" next to each.
- Show retry button only after auto-retries exhaust (per research recommendation: ~6-8 min). Check `_bluesky_syndication_retry_count` — if >= 3 (max auto-retries), show retry button; otherwise show "Will retry automatically."
- Keep existing Heartbeat integration unchanged.

**D. AJAX handler for persistent notice dismissal**

Add new method `handle_notice_dismissal()`:
- Hook: `wp_ajax_bluesky_dismiss_notice`
- Verify nonce via `check_ajax_referer('bluesky_dismiss_notice', 'nonce')`
- Sanitize notice_key from POST: `sanitize_key($_POST['notice_key'] ?? '')`
- Validate notice_key is one of the allowed keys: 'bluesky_expired_creds_dismissed', 'bluesky_circuit_breaker_dismissed'
- Store dismissal: `update_user_meta(get_current_user_id(), $notice_key, time() + DAY_IN_SECONDS)`
- Return `wp_send_json_success()`

Register all new hooks in `__construct()`:
- `add_action('admin_notices', [$this, 'expired_credentials_notice']);`
- `add_action('admin_notices', [$this, 'circuit_breaker_notice']);`
- `add_action('wp_ajax_bluesky_dismiss_notice', [$this, 'handle_notice_dismissal']);`

The constructor currently takes `BlueSky_Async_Handler` — also accept an optional `BlueSky_Account_Manager` as second parameter for account lookups. Update the constructor signature: `public function __construct(BlueSky_Async_Handler $async_handler, BlueSky_Account_Manager $account_manager = null)`. Store as `$this->account_manager`.
  </action>
  <verify>
Run PHP syntax check: `/Users/CRG/Library/Application\ Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Admin_Notices.php`
Run: `grep -c 'expired_credentials_notice\|circuit_breaker_notice\|handle_notice_dismissal\|data-dismissible' classes/BlueSky_Admin_Notices.php` — should return 4+.
  </verify>
  <done>BlueSky_Admin_Notices has persistent cross-page notices for expired credentials (grouped multi-account) and circuit breaker status, with 24-hour dismissal via user meta. Post edit screen shows per-account syndication detail. Retry button shown only after auto-retries exhaust.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin notices JavaScript and update asset enqueuing</name>
  <files>assets/js/bluesky-admin-notices.js, classes/BlueSky_Assets_Service.php</files>
  <action>
**A. Create `assets/js/bluesky-admin-notices.js`** — handles persistent notice dismissal via AJAX.

This is a SEPARATE file from the existing `bluesky-syndication-notice.js` (which handles Heartbeat polling on post edit screens). This new file loads on ALL admin pages where persistent notices appear.

```javascript
(function($) {
    'use strict';

    // Handle dismissal of persistent notices
    $(document).on('click', '.notice[data-dismissible] .notice-dismiss', function() {
        var $notice = $(this).closest('.notice');
        var noticeKey = $notice.data('dismissible');

        if (!noticeKey) return;

        $.post(ajaxurl, {
            action: 'bluesky_dismiss_notice',
            notice_key: noticeKey,
            nonce: blueskyAdminNotices.dismissNonce
        });
    });
})(jQuery);
```

**B. Update BlueSky_Assets_Service.php** to enqueue the new script:

Add a new method or extend existing admin script enqueuing to load `bluesky-admin-notices.js` on all admin pages (not just post edit). This script is lightweight (< 1KB) so loading broadly is acceptable.

Find where admin scripts are enqueued (look for `admin_enqueue_scripts` hook). Add:

```php
wp_enqueue_script(
    'bluesky-admin-notices',
    BLUESKY_PLUGIN_FOLDER . 'assets/js/bluesky-admin-notices.js',
    ['jquery'],
    BLUESKY_PLUGIN_VERSION,
    true
);

wp_localize_script('bluesky-admin-notices', 'blueskyAdminNotices', [
    'dismissNonce' => wp_create_nonce('bluesky_dismiss_notice'),
]);
```

This should be enqueued on admin pages where the plugin's notices might appear. At minimum, enqueue on all admin pages (it's a tiny script). Use `admin_enqueue_scripts` hook.

IMPORTANT: Do NOT modify the existing `bluesky-syndication-notice.js` behavior. The new file is additive.
  </action>
  <verify>
Verify JS file exists: `ls assets/js/bluesky-admin-notices.js`
Run: `grep 'bluesky-admin-notices\|blueskyAdminNotices\|dismissNonce' classes/BlueSky_Assets_Service.php` — should show enqueue and localize calls.
Run PHP syntax check: `/Users/CRG/Library/Application\ Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Assets_Service.php`
  </verify>
  <done>New bluesky-admin-notices.js handles persistent notice dismissal via AJAX. Script is enqueued on admin pages with dismiss nonce localized. Existing syndication notice JS unchanged.</done>
</task>

</tasks>

<verification>
1. Persistent notice for expired credentials appears on all admin pages (not just post edit)
2. Multiple broken accounts grouped into single notice (not one per account)
3. Dismissing notice stores user meta with 24-hour expiry
4. Circuit breaker notice shows friendly message
5. Post edit screen shows per-account syndication detail for failed/partial
6. Retry button only visible after auto-retries exhaust (retry_count >= 3)
7. AJAX dismissal handler verifies nonce and validates notice key
</verification>

<success_criteria>
- Expired credential notices are persistent, dismissible, and return after 24 hours
- Per-account syndication status shown on post edit screen
- JavaScript handles AJAX dismissal on all admin pages
- No regression to existing Heartbeat-based syndication status polling
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling-ux/04-02-SUMMARY.md`
</output>
