---
phase: 04-error-handling-ux
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified:
  - classes/BlueSky_Syndication_Service.php
  - classes/BlueSky_Async_Handler.php
  - classes/BlueSky_API_Handler.php
  - classes/BlueSky_Admin_Notices.php
  - classes/BlueSky_Plugin_Setup.php
autonomous: false

must_haves:
  truths:
    - "Every API error shows user-friendly message explaining what happened and how to fix it"
    - "Expired authentication tokens trigger re-authentication prompt, not silent failure"
    - "Rate limit errors display user-friendly message with automatic retry indication"
    - "Syndication events are logged to the activity logger"
    - "Auth errors set the bluesky_account_auth_errors option for notice detection"
  artifacts:
    - path: "classes/BlueSky_Syndication_Service.php"
      provides: "Error translator and activity logger integration in syndication flow"
      contains: "BlueSky_Error_Translator"
    - path: "classes/BlueSky_Async_Handler.php"
      provides: "Activity logging on async syndication completion/failure"
      contains: "BlueSky_Activity_Logger"
  key_links:
    - from: "classes/BlueSky_Syndication_Service.php"
      to: "classes/BlueSky_Error_Translator.php"
      via: "translate_error() calls on API failures"
      pattern: "BlueSky_Error_Translator::translate_error"
    - from: "classes/BlueSky_Async_Handler.php"
      to: "classes/BlueSky_Activity_Logger.php"
      via: "log_event() calls on syndication completion"
      pattern: "log_event"
    - from: "classes/BlueSky_Syndication_Service.php"
      to: "wp_options"
      via: "bluesky_account_auth_errors option for notice detection"
      pattern: "bluesky_account_auth_errors"
---

<objective>
Wire the Error Translator and Activity Logger into the existing syndication pipeline, async handler, and API handler. This is the integration plan that connects Phase 4 foundation classes to existing Phase 3 infrastructure, plus a human verification checkpoint.

Purpose: Makes all error translation and activity logging actually work end-to-end, completing the Phase 4 requirements.
Output: Error translator and activity logger integrated into existing code paths + human verification.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-handling-ux/04-RESEARCH.md
@.planning/phases/04-error-handling-ux/04-01-PLAN.md
@.planning/phases/04-error-handling-ux/04-02-PLAN.md
@.planning/phases/04-error-handling-ux/04-03-PLAN.md
@.planning/phases/04-error-handling-ux/04-04-PLAN.md
@classes/BlueSky_Syndication_Service.php
@classes/BlueSky_Async_Handler.php
@classes/BlueSky_API_Handler.php
@classes/BlueSky_Admin_Notices.php
@classes/BlueSky_Plugin_Setup.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Error Translator and Activity Logger into syndication pipeline</name>
  <files>classes/BlueSky_Syndication_Service.php, classes/BlueSky_Async_Handler.php, classes/BlueSky_API_Handler.php, classes/BlueSky_Plugin_Setup.php</files>
  <action>
This task connects the Phase 4 foundation classes into the existing code paths. Three integration points:

**A. BlueSky_Syndication_Service — Error translation on syndication failures**

Find where syndication failures are handled (look for where `_bluesky_syndication_status` is set to 'failed' or where error messages are stored). At each failure point:
1. Pass the raw API error through `BlueSky_Error_Translator::translate_error($error_data, 'syndication')`
2. Store the translated message alongside the raw error in post meta `_bluesky_syndication_failed_accounts` — enhance the existing failed accounts array to include translated message per account:
   ```php
   $translated = BlueSky_Error_Translator::translate_error($error_data, 'syndication');
   // Store: ['handle' => ['error' => $raw_error, 'message' => $translated['message']]]
   ```
3. When auth errors are detected (401/AuthenticationRequired), update the auth errors registry:
   ```php
   $auth_errors = get_option('bluesky_account_auth_errors', []);
   $auth_errors[$account_id] = ['handle' => $handle, 'time' => time()];
   update_option('bluesky_account_auth_errors', $auth_errors);
   ```
4. When syndication succeeds for an account, clear that account from auth errors:
   ```php
   $auth_errors = get_option('bluesky_account_auth_errors', []);
   unset($auth_errors[$account_id]);
   update_option('bluesky_account_auth_errors', $auth_errors);
   ```

**B. BlueSky_Async_Handler — Activity logging on syndication events**

Find where async syndication completes (success callback) and fails (failure callback). At each point, log to Activity Logger:

1. On successful syndication:
   ```php
   $logger = new BlueSky_Activity_Logger();
   $logger->log_event('syndication_success', sprintf('Post "%s" syndicated to @%s', get_the_title($post_id), $handle), $post_id, $account_id);
   ```

2. On failed syndication (after all retries exhausted):
   ```php
   $logger = new BlueSky_Activity_Logger();
   $logger->log_event('syndication_failed', sprintf('Post "%s" failed for @%s', get_the_title($post_id), $handle), $post_id, $account_id);
   ```

3. On rate limit hit:
   ```php
   $logger = new BlueSky_Activity_Logger();
   $logger->log_event('rate_limited', sprintf('Rate limited while syndicating to @%s', $handle), $post_id, $account_id);
   ```

4. On circuit breaker opening:
   ```php
   $logger = new BlueSky_Activity_Logger();
   $logger->log_event('circuit_opened', sprintf('Circuit breaker opened for @%s', $handle), null, $account_id);
   ```

**C. BlueSky_Admin_Notices — Use translated messages in post edit notices**

Update the `syndication_status_notice()` method's `failed` and `partial` cases to display the translated error messages stored in post meta (from integration A above), instead of just the raw account names. For each failed account, show:
"@handle: [translated message]"

**D. BlueSky_Plugin_Setup — Pass Account Manager to Admin Notices**

Update the Admin Notices instantiation to pass the account_manager:
```php
$this->admin_notices = new BlueSky_Admin_Notices($async_handler, $account_manager);
```

IMPORTANT: Read each file carefully before modifying. Identify the exact lines where errors are currently handled and add the translation/logging calls there. Do not restructure existing error handling — add to it.
  </action>
  <verify>
Run PHP syntax check on all modified files.
Run: `grep 'BlueSky_Error_Translator' classes/BlueSky_Syndication_Service.php` — should show translate_error calls.
Run: `grep 'BlueSky_Activity_Logger\|log_event' classes/BlueSky_Async_Handler.php` — should show activity logging.
Run: `grep 'bluesky_account_auth_errors' classes/BlueSky_Syndication_Service.php` — should show auth error registry updates.
  </verify>
  <done>Error Translator integrated into syndication failure paths. Activity Logger integrated into async handler completion/failure callbacks. Auth error registry maintained for persistent notice detection. Translated messages displayed in admin notices. Account Manager passed to Admin Notices constructor.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Phase 4 Error Handling and UX end-to-end</name>
  <files>N/A</files>
  <action>
Human verification of the complete Phase 4 Error Handling and UX system:
1. Error Translator converts all API errors to friendly messages
2. Activity Logger tracks recent syndication events
3. Persistent admin notices for expired credentials and circuit breaker (cross-page, dismissible, 24h return)
4. Per-account syndication status on post edit screen
5. Dashboard widget with account status, last syndication, API health, cache status, pending retries, recent activity
6. Settings page health section replacing old cache-only status
7. Site Health integration with 3 pass/fail tests and debug info section
8. All components wired together through syndication pipeline
  </action>
  <verify>
1. Dashboard Widget: Go to wp-admin/ dashboard, find "Bluesky Integration Health" widget, verify sections (Account Status, Last Syndication, API Health, Cache Status, Recent Activity), click Refresh button, click "View detailed health" link.
2. Settings Page Health Section: Go to Settings then Bluesky Social Settings, navigate to last tab, verify comprehensive health section replaces old cache-only status.
3. Admin Notices: If any accounts have issues, verify persistent notice banner appears on admin pages, is dismissible, does not reappear after dismissal, and groups multiple broken accounts in single notice.
4. Site Health: Go to Tools then Site Health then Status, look for Bluesky checks. Go to Info tab, find "Bluesky Integration" debug section with Plugin Version, Connected Accounts, API Endpoint, Cache Duration, Action Scheduler status.
5. Post Edit Screen: Edit a syndicated post, verify per-account detail shown for failed/partial status with friendly error messages.
  </verify>
  <done>Human has verified all Phase 4 components work end-to-end: dashboard widget, settings health section, persistent notices, Site Health integration, and per-account syndication status with friendly error messages.</done>
</task>

</tasks>

<verification>
1. Error Translator called in syndication failure paths
2. Activity Logger called in async handler completion paths
3. Auth errors tracked in bluesky_account_auth_errors option
4. Translated messages shown in admin notices (not raw errors)
5. All PHP files pass syntax check
6. Human verifies end-to-end functionality
</verification>

<success_criteria>
- Every API error surfaces with user-friendly message (UX-01)
- Expired tokens trigger re-auth prompt notice (UX-02)
- Rate limit errors show friendly message with auto-retry indication (UX-03)
- Dashboard widget shows plugin health summary (UX-04)
- Settings page health section replaces old cache status
- Site Health shows Bluesky checks and debug info
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling-ux/04-05-SUMMARY.md`
</output>
