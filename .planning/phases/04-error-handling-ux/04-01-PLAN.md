---
phase: 04-error-handling-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Error_Translator.php
  - classes/BlueSky_Activity_Logger.php
  - social-integration-for-bluesky.php
autonomous: true

must_haves:
  truths:
    - "API error codes are translated to plain-language user-friendly messages"
    - "Error messages follow explain + action pattern with friendly tone"
    - "Auth errors include action link to settings; transient errors do not"
    - "Recent syndication events are logged in a circular buffer"
  artifacts:
    - path: "classes/BlueSky_Error_Translator.php"
      provides: "Centralized API error to user-friendly message translation"
      contains: "translate_error"
    - path: "classes/BlueSky_Activity_Logger.php"
      provides: "Recent syndication activity tracking with circular buffer"
      contains: "log_event"
  key_links:
    - from: "classes/BlueSky_Error_Translator.php"
      to: "admin_url"
      via: "action links for critical errors"
      pattern: "admin_url.*BLUESKY_PLUGIN_SETTING_PAGENAME"
    - from: "classes/BlueSky_Activity_Logger.php"
      to: "wp_options"
      via: "get_option/update_option circular buffer"
      pattern: "update_option.*bluesky_activity_log"
---

<objective>
Create two foundational classes: BlueSky_Error_Translator (maps raw API errors to user-friendly messages) and BlueSky_Activity_Logger (tracks recent syndication events in a circular buffer). These are standalone utility classes that other Phase 4 plans depend on.

Purpose: Establishes the error messaging vocabulary and activity tracking infrastructure that the health dashboard, admin notices, and Site Health integration will consume.
Output: Two new PHP classes registered in the main plugin file.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-handling-ux/04-RESEARCH.md
@classes/BlueSky_API_Handler.php
@social-integration-for-bluesky.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlueSky_Error_Translator class</name>
  <files>classes/BlueSky_Error_Translator.php, social-integration-for-bluesky.php</files>
  <action>
Create `classes/BlueSky_Error_Translator.php` — a static utility class that translates raw Bluesky API errors into user-friendly messages following the "explain + action" pattern.

Per user decisions:
- Friendly and plain tone: "We couldn't post to Bluesky right now. Your credentials may have expired." — approachable, no jargon
- Action links (e.g., "Go to Settings" button) included ONLY for critical errors like auth failures and config issues
- Transient errors (rate limits, timeouts) just describe the situation — NO action links
- No visible severity levels — all errors look the same visually

Methods to implement:

1. `public static function translate_error($error_data, $context = 'general')` — Main translation method
   - Input: `$error_data` array with keys `code`, `message`, `status` (from API handler responses), and `$context` string ('auth', 'syndication', 'fetch', 'general')
   - Output: associative array `['message' => string, 'action' => array|null]` where action has `label` and `url` keys
   - Error mappings (use text domain 'social-integration-for-bluesky' for all strings):
     - HTTP 401 / code 'AuthenticationRequired' / code 'InvalidToken' / code 'ExpiredToken' → "We couldn't connect to Bluesky. Your credentials may have expired." + action link to settings page
     - HTTP 429 / code 'RateLimitExceeded' → "Bluesky is temporarily rate limiting requests. Your post will be retried automatically." + NO action
     - HTTP 0 / HTTP 503 / code 'NetworkError' → "Couldn't reach Bluesky right now. This is usually temporary. Your post will be retried automatically." + NO action
     - Code 'InvalidHandle' → "The Bluesky handle appears to be invalid. Please check that you entered it correctly." + action link to settings page
     - HTTP 400 → "Bluesky couldn't process this request. The post content may have an issue." + NO action
     - HTTP 403 → "You don't have permission for this action on Bluesky. Your account settings may need updating." + action link to settings
     - HTTP 500+ → "Bluesky is experiencing issues right now. Your post will be retried automatically." + NO action
     - Default/unknown → context-specific generic message (see below)

2. `private static function generic_error($context)` — Fallback messages by context
   - 'auth' → "Something went wrong while connecting to Bluesky. Please try again."
   - 'syndication' → "We couldn't post to Bluesky right now. Your post will be retried automatically."
   - 'fetch' → "We couldn't load Bluesky content right now. Please try refreshing the page."
   - 'general' → "Something went wrong with the Bluesky connection. Please try again."
   - All return `['message' => ..., 'action' => null]`

3. `public static function circuit_breaker_message($is_open)` — Returns friendly circuit breaker status string
   - Open: "Bluesky requests are paused due to repeated errors. They'll resume automatically."
   - Closed: "Bluesky connection is healthy."

4. `public static function syndication_status_message($status, $extra_data = [])` — Returns friendly syndication status text
   - 'pending' → "Syndicating to Bluesky..."
   - 'retrying' → "Retrying syndication to Bluesky..."
   - 'rate_limited' → "Rate limited — will retry automatically."
   - 'circuit_open' → "Bluesky requests paused due to repeated errors. Will resume automatically."
   - 'completed' → "Successfully posted to Bluesky."
   - 'failed' → "Couldn't post to Bluesky." (caller adds per-account details)
   - 'partial' → "Posted to some Bluesky accounts. Some accounts had issues."

5. `public static function format_action_link($action)` — Helper to render action as HTML link
   - Input: action array `['label' => ..., 'url' => ...]` or null
   - Output: HTML string `<a href="..." class="bluesky-error-action">label</a>` or empty string

Settings URL construction: `admin_url('options-general.php?page=' . BLUESKY_PLUGIN_SETTING_PAGENAME)`

Follow existing codebase pattern: ABSPATH guard at top, standard class structure matching other classes/ files.

Add `require_once "classes/BlueSky_Error_Translator.php";` to social-integration-for-bluesky.php in the requires block (after BlueSky_Rate_Limiter.php, before BlueSky_Async_Handler.php — keeps utility classes together).
  </action>
  <verify>
Run: `grep -c 'translate_error\|circuit_breaker_message\|syndication_status_message\|generic_error\|format_action_link' classes/BlueSky_Error_Translator.php` — should return 5+ (all methods present).
Run: `grep 'BlueSky_Error_Translator' social-integration-for-bluesky.php` — should show require_once line.
Run PHP syntax check: `/Users/CRG/Library/Application\ Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Error_Translator.php`
  </verify>
  <done>BlueSky_Error_Translator class exists with translate_error(), circuit_breaker_message(), syndication_status_message(), generic_error(), and format_action_link() methods. All error types mapped to friendly messages. Auth/config errors have action links; transient errors do not. Class registered in main plugin file.</done>
</task>

<task type="auto">
  <name>Task 2: Create BlueSky_Activity_Logger class</name>
  <files>classes/BlueSky_Activity_Logger.php, social-integration-for-bluesky.php</files>
  <action>
Create `classes/BlueSky_Activity_Logger.php` — stores recent syndication events in a circular buffer using the WordPress Options API.

Per user decisions:
- Recent activity log (last 5-10 syndication events across posts) shown in health widget for diagnosing recurring issues
Per research recommendations:
- Use single option with circular array buffer (rotate when > 10 entries)

Storage: Single option key `bluesky_activity_log` containing a JSON-encoded array of event objects. Maximum 10 entries; when full, oldest entry is removed (FIFO).

Each event is an associative array:
```php
[
    'time'       => int,     // Unix timestamp
    'type'       => string,  // 'syndication_success', 'syndication_failed', 'syndication_partial', 'auth_expired', 'rate_limited', 'circuit_opened', 'circuit_closed'
    'message'    => string,  // Human-readable summary
    'post_id'    => int|null, // WordPress post ID if applicable
    'account_id' => string|null, // Account UUID if applicable
]
```

Methods:

1. `public function log_event($type, $message, $post_id = null, $account_id = null)` — Add event to log
   - Creates event array with current timestamp
   - Appends to existing log
   - Trims to max 10 entries (remove oldest first)
   - Saves via update_option()

2. `public function get_recent_events($count = 10)` — Get recent events (newest first)
   - Returns array of event arrays, sorted by time descending
   - $count limits how many to return (default 10, max 10)

3. `public function get_events_by_type($type)` — Filter events by type
   - Returns events matching the given type string

4. `public function clear_log()` — Clear all events
   - Deletes the option entirely

5. `public static function format_event_time($timestamp)` — Format timestamp for display
   - Uses WordPress `human_time_diff()` + __(' ago', 'social-integration-for-bluesky') for recent events (< 24h)
   - Uses `wp_date(get_option('date_format') . ' ' . get_option('time_format'), $timestamp)` for older events

The class should NOT auto-register hooks. It's a utility class that other classes call into (the Syndication_Service, Async_Handler, etc. will call `log_event()` after operations complete — that wiring happens in Plan 05).

Add `require_once "classes/BlueSky_Activity_Logger.php";` to social-integration-for-bluesky.php right after BlueSky_Error_Translator.php require.

Follow existing codebase pattern: ABSPATH guard, standard class structure.
  </action>
  <verify>
Run: `grep -c 'log_event\|get_recent_events\|get_events_by_type\|clear_log\|format_event_time' classes/BlueSky_Activity_Logger.php` — should return 5+ (all methods present).
Run: `grep 'BlueSky_Activity_Logger' social-integration-for-bluesky.php` — should show require_once line.
Run PHP syntax check: `/Users/CRG/Library/Application\ Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Activity_Logger.php`
  </verify>
  <done>BlueSky_Activity_Logger class exists with circular buffer storage (max 10 events) via WordPress Options API. log_event(), get_recent_events(), get_events_by_type(), clear_log(), and format_event_time() methods all present. Class registered in main plugin file.</done>
</task>

</tasks>

<verification>
1. Both new class files exist and pass PHP syntax check
2. Both classes are require_once'd in social-integration-for-bluesky.php
3. Error Translator covers all documented error types (401, 429, 503, 400, 403, 500+, generic)
4. Activity Logger uses circular buffer with max 10 entries
5. No new WordPress hooks registered (utility classes only)
</verification>

<success_criteria>
- BlueSky_Error_Translator::translate_error() returns friendly messages for all Bluesky API error types
- BlueSky_Activity_Logger stores and retrieves up to 10 recent events with FIFO rotation
- Both classes follow existing codebase patterns and pass PHP lint
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling-ux/04-01-SUMMARY.md`
</output>
