---
phase: 04-error-handling-ux
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - classes/BlueSky_Health_Monitor.php
  - social-integration-for-bluesky.php
  - classes/BlueSky_Plugin_Setup.php
autonomous: true

must_haves:
  truths:
    - "Site Health shows pass/fail checks for Bluesky connection, credentials, and circuit breaker"
    - "Site Health debug info section shows plugin version, account count, API endpoint, cache duration, Action Scheduler status, and per-account circuit breaker/rate limit state"
    - "Health checks use correct WordPress Site Health API return format"
  artifacts:
    - path: "classes/BlueSky_Health_Monitor.php"
      provides: "WordPress Site Health integration with tests and debug info"
      contains: "register_health_tests"
  key_links:
    - from: "classes/BlueSky_Health_Monitor.php"
      to: "WordPress Site Health"
      via: "site_status_tests and debug_information filters"
      pattern: "site_status_tests|debug_information"
    - from: "classes/BlueSky_Health_Monitor.php"
      to: "classes/BlueSky_Account_Manager.php"
      via: "get_all_accounts() for health checks"
      pattern: "get_all_accounts"
---

<objective>
Create WordPress Site Health integration with pass/fail status checks and debug information section. Appears in Tools > Site Health for diagnostics and troubleshooting.

Purpose: Integrates with WordPress core troubleshooting workflow so users checking Site Health see Bluesky plugin status alongside other health checks.
Output: New BlueSky_Health_Monitor class with site_status_tests and debug_information filters.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-handling-ux/04-RESEARCH.md
@classes/BlueSky_Account_Manager.php
@classes/BlueSky_Circuit_Breaker.php
@classes/BlueSky_Rate_Limiter.php
@classes/BlueSky_Plugin_Setup.php
@social-integration-for-bluesky.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlueSky_Health_Monitor with Site Health tests</name>
  <files>classes/BlueSky_Health_Monitor.php</files>
  <action>
Create `classes/BlueSky_Health_Monitor.php` — integrates with WordPress Site Health API (available since WP 5.2).

Per user decisions:
- WP Site Health integration includes pass/fail status checks ("Bluesky connection active", "API responding", "Credentials valid") plus a debug info section with API version, rate limit state, cache stats, account count

Constructor registers filters:
- `add_filter('site_status_tests', [$this, 'register_health_tests']);`
- `add_filter('debug_information', [$this, 'register_debug_info']);`

**Method: register_health_tests($tests)**

Register three `direct` tests (no async needed — these check local state, not live API):

1. `bluesky_accounts_configured` — Checks if accounts are set up:
   - No accounts → status: 'recommended', label: "No Bluesky accounts configured", badge: Performance/blue, description suggests adding accounts, action link to settings
   - Has accounts → status: 'good', label: "Bluesky accounts configured", description shows count

2. `bluesky_credentials_valid` — Checks for known auth errors:
   - Check `get_option('bluesky_account_auth_errors', [])` registry
   - Errors found → status: 'critical', label: "Bluesky accounts need re-authentication", badge: Security/red, list affected handles, action link to settings
   - No errors → status: 'good', label: "All Bluesky credentials valid", badge: Security/blue

3. `bluesky_circuit_breaker` — Checks circuit breaker state:
   - Any account has open breaker → status: 'recommended', label: "Bluesky API requests paused", badge: Performance/orange, description explains cooldown, lists affected accounts
   - All breakers closed → status: 'good', label: "Bluesky API connections healthy", badge: Performance/blue

Each test method returns the standard WP Site Health array:
```php
[
    'label'       => string,
    'status'      => 'good'|'recommended'|'critical',
    'badge'       => ['label' => string, 'color' => 'blue'|'red'|'orange'],
    'description' => '<p>...</p>',
    'actions'     => '<a href="...">link text</a>' (optional),
    'test'        => 'test_id_string'
]
```

All strings use text domain 'social-integration-for-bluesky'. Use `_n()` for pluralized account counts.

**Method: register_debug_info($info)**

Add a 'bluesky' section to debug info:

```php
$info['bluesky'] = [
    'label' => __('Bluesky Integration', 'social-integration-for-bluesky'),
    'fields' => [...]
];
```

Fields:
- `plugin_version` — BLUESKY_PLUGIN_VERSION constant
- `account_count` — Count of configured accounts
- `api_endpoint` — 'https://bsky.social/xrpc/'
- `cache_duration` — From plugin options (total_seconds), formatted as "X minutes"
- `action_scheduler` — Whether function_exists('as_schedule_single_action') ? 'Available' : 'Not available'
- Per-account fields (keyed as `account_{id}_status`): "Circuit: Closed/Open | Rate Limited: Yes/No" with `'private' => true`

Follow existing codebase pattern: ABSPATH guard, standard class structure.
  </action>
  <verify>
Run PHP syntax check: `/Users/CRG/Library/Application\ Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Health_Monitor.php`
Run: `grep -c 'register_health_tests\|register_debug_info\|site_status_tests\|debug_information\|bluesky_accounts_configured\|bluesky_credentials_valid\|bluesky_circuit_breaker' classes/BlueSky_Health_Monitor.php` — should return 7+.
  </verify>
  <done>Site Health shows 3 pass/fail tests (accounts configured, credentials valid, circuit breaker) and debug info section with plugin version, account count, API endpoint, cache duration, Action Scheduler status, and per-account resilience state.</done>
</task>

<task type="auto">
  <name>Task 2: Register Health Monitor in plugin bootstrap</name>
  <files>social-integration-for-bluesky.php, classes/BlueSky_Plugin_Setup.php</files>
  <action>
1. Add `require_once "classes/BlueSky_Health_Monitor.php";` to social-integration-for-bluesky.php after BlueSky_Health_Dashboard.php require.

2. Update BlueSky_Plugin_Setup constructor to instantiate:
   - Add property: `private $health_monitor;`
   - In constructor: `$this->health_monitor = new BlueSky_Health_Monitor();`
   - The Health Monitor creates its own Account Manager, Circuit Breaker, and Rate Limiter instances internally (no constructor dependency injection needed since it only reads data).

Verify Plugin_Setup constructor still works with existing dependencies.
  </action>
  <verify>
Run: `grep 'BlueSky_Health_Monitor' social-integration-for-bluesky.php classes/BlueSky_Plugin_Setup.php` — should show require + instantiation.
Run PHP syntax check on both files.
  </verify>
  <done>BlueSky_Health_Monitor is required in main plugin file and instantiated in Plugin_Setup. Site Health tests and debug info registered on WordPress hooks.</done>
</task>

</tasks>

<verification>
1. site_status_tests filter adds 3 Bluesky checks
2. debug_information filter adds 'bluesky' section with all specified fields
3. Health tests return correct WP Site Health array format
4. Per-account debug fields marked as private
5. Class instantiated in Plugin_Setup
</verification>

<success_criteria>
- Tools > Site Health > Status shows Bluesky health checks (accounts, credentials, circuit breaker)
- Tools > Site Health > Info shows Bluesky Integration debug section
- All test results use correct status values (good/recommended/critical)
- No PHP errors when no accounts are configured
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling-ux/04-04-SUMMARY.md`
</output>
