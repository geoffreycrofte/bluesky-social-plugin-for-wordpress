---
phase: 05-profile-content-display
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Render_Front.php
  - templates/frontend/posts-list.php
  - assets/css/bluesky-social-posts.css
  - assets/css/bluesky-profile-banner.css
  - templates/frontend/skeleton-profile-banner.php
  - templates/frontend/skeleton-posts-list.php
autonomous: true

must_haves:
  truths:
    - "GIF images in posts render as inline animated images, not as embedded link cards"
    - "Skeleton shimmer placeholders display while profile banner and posts feed are loading"
    - "Empty feed shows friendly message with Bluesky butterfly icon"
    - "Stale cached content displays with 'Content may be outdated' banner when API is down"
    - "Existing reply/repost filter toggles continue working seamlessly"
  artifacts:
    - path: "templates/frontend/posts-list.php"
      provides: "GIF detection rendering and bookmark indicator in post template"
      contains: "is-gif"
    - path: "templates/frontend/skeleton-profile-banner.php"
      provides: "Skeleton loader for profile banner"
      contains: "bluesky-skeleton"
    - path: "templates/frontend/skeleton-posts-list.php"
      provides: "Skeleton loader for posts list"
      contains: "bluesky-skeleton"
    - path: "assets/css/bluesky-social-posts.css"
      provides: "GIF rendering styles and skeleton shimmer animation"
      contains: "shimmer"
  key_links:
    - from: "classes/BlueSky_Render_Front.php"
      to: "templates/frontend/posts-list.php"
      via: "template include in render_bluesky_posts_list()"
      pattern: "posts-list.php"
    - from: "templates/frontend/posts-list.php"
      to: "is_gif flag"
      via: "conditional CSS class on gallery images"
      pattern: "is.gif"
---

<objective>
Enhance the existing feed display with GIF detection, skeleton loaders, empty/stale states, and bookmark indicator.

Purpose: Polishes the posts feed UX with loading states, GIF inline rendering, and graceful degradation when API is unavailable (DISP-04 preserved).
Output: Updated posts template, skeleton loader templates, enhanced CSS with shimmer animations.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-content-display/05-RESEARCH.md
@classes/BlueSky_Render_Front.php
@templates/frontend/posts-list.php
@templates/frontend/stale-indicator.php
@assets/css/bluesky-social-posts.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GIF detection to API data transformation and update posts template</name>
  <files>
classes/BlueSky_Render_Front.php
templates/frontend/posts-list.php
  </files>
  <action>
**GIF Detection in Render_Front:**

In `render_bluesky_posts_list()` (or wherever post data is transformed before template inclusion), add GIF detection logic. Find where `$post['images']` array is built from API response. For each image in the embed data:
- Check if `$image['image']['mimeType'] === 'image/gif'` (authoritative MIME type from Bluesky API blob data).
- Add `'is_gif' => true` flag to the image array entry when detected.
- Do NOT rely on URL file extension — use MIME type only.

If the image transformation happens in `BlueSky_API_Handler`, add the `is_gif` flag there instead. Search for where `embed.images` are processed (likely in `fetch_bluesky_posts()` or a transform method). The flag must be available in the template's `$post['images']` array.

**Posts Template GIF Rendering:**

In `templates/frontend/posts-list.php`, find the image gallery rendering loop (where `$post['images']` are iterated). Modify the `<a>` wrapper and `<img>` tag:
- Add CSS class `is-gif` to the gallery image link when `$image['is_gif']` is truthy.
- GIF images should NOT open in lightbox — add `data-no-lightbox="true"` attribute to the link.
- Ensure GIF `<img>` tags do NOT have `loading="lazy"` (GIFs should load eagerly to start animation).
- Non-GIF images remain unchanged (preserve existing behavior per user decision).

**Bookmark Indicator:**

Per research, Bluesky API does NOT expose public bookmark counts — only `viewer.bookmark` boolean. The user decision says "add bookmark counter alongside" engagement counters. Since only boolean is available:
- In the engagement counters section of `posts-list.php`, add a bookmark icon alongside like/repost/reply counters.
- Show bookmark icon only when the viewer has bookmarked (if `viewer.bookmark` data is available in the transformed post data).
- If the API response doesn't include bookmark data, skip the bookmark display gracefully (don't show broken counter).
- Same toggle controls all counters (existing `nocounters` attribute).

**Empty State Enhancement:**

Update the empty state in `posts-list.php`. The template likely already has an empty state — enhance it:
- Use the Bluesky butterfly SVG icon (existing pattern from lines 497-510 per research).
- Message: "No posts yet" (friendly, per user decision).
- Centered layout with subdued styling.

**Stale Content Banner:**

In `render_bluesky_posts_list()`, the stale-while-revalidate logic already exists (from Phase 3). Ensure the stale indicator template is included when serving stale cached data. If not already showing, add the "Content may be outdated" message by including `templates/frontend/stale-indicator.php` before the posts output when `$is_stale` is true.

**CRITICAL:** Do NOT modify the reply/repost filter logic. Existing `noreplies` and `noreposts` toggles must continue working exactly as before. Only ADD new features around the existing filters.
  </action>
  <verify>
Grep for `is-gif` or `is_gif` in `templates/frontend/posts-list.php` — GIF class must be present.
Grep for `data-no-lightbox` in `templates/frontend/posts-list.php` — lightbox prevention attribute present.
Grep for `No posts` in `templates/frontend/posts-list.php` — empty state message present.
Verify `noreplies` and `noreposts` logic is unchanged by diffing before/after.
  </verify>
  <done>
GIF images in posts render inline with `is-gif` class and lightbox prevention. Empty feed shows friendly butterfly icon with "No posts yet" message. Stale content shows indicator banner. Existing reply/repost filters unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create skeleton loader templates and CSS shimmer animation</name>
  <files>
templates/frontend/skeleton-profile-banner.php
templates/frontend/skeleton-posts-list.php
assets/css/bluesky-social-posts.css
assets/css/bluesky-profile-banner.css
  </files>
  <action>
**Skeleton Profile Banner Template** (`templates/frontend/skeleton-profile-banner.php`):
- Matches full banner layout shape: banner placeholder (aspect-ratio 3/1), circular avatar placeholder (overlapping), 2 text line placeholders (name, handle), bio placeholder (2 lines), stats row placeholder (3 items).
- All elements use class `bluesky-skeleton` for shimmer animation.
- Wrapped in `.bluesky-profile-banner.bluesky-profile-banner-loading`.
- Match real layout dimensions to minimize CLS (Cumulative Layout Shift).

**Skeleton Posts List Template** (`templates/frontend/skeleton-posts-list.php`):
- 3 placeholder post cards matching existing post card layout: avatar circle (40x40), name line, handle line, 3 content text lines, engagement counters row.
- Each card wrapped in `.bluesky-post-skeleton`.
- Use `bluesky-skeleton` class on each placeholder element.

**CSS Shimmer Animation** (append to `assets/css/bluesky-social-posts.css`):
```css
@keyframes bluesky-shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

.bluesky-skeleton {
  background: linear-gradient(90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
  background-size: 1000px 100%;
  animation: bluesky-shimmer 2s infinite;
  border-radius: 4px;
}
```
- Add skeleton element sizes: `.bluesky-skeleton-avatar` (circle), `.bluesky-skeleton-text` (16px height), `.bluesky-skeleton-text-short` (60% width), `.bluesky-skeleton-text-long` (100% width), `.bluesky-skeleton-banner` (aspect-ratio 3/1).

**Also add to `assets/css/bluesky-profile-banner.css`:**
- `.bluesky-profile-banner-loading` container styles matching real banner dimensions.
- Loading state skeleton element positioning to match real layout.

**GIF-specific CSS** (append to `assets/css/bluesky-social-posts.css`):
- `.bluesky-gallery-image.is-gif` — cursor default, optional "GIF" badge overlay via `::after` pseudo-element.
- `.bluesky-gallery-image.is-gif img` — ensure `image-rendering: auto` for smooth GIF playback.

**Empty state CSS** (append to `assets/css/bluesky-social-posts.css`):
- `.bluesky-social-integration-empty-state` — centered, padding 40px 20px, subdued color.
- `.bluesky-empty-state-message` — 16px font, inherit color.
- SVG icon at 0.5 opacity, margin-bottom 16px.

**Dark mode support:**
- Skeleton gradient for dark: `linear-gradient(90deg, #2a2a2a 0%, #3a3a3a 50%, #2a2a2a 100%)`.
- Use `.bluesky-social-integration-dark .bluesky-skeleton` or `@media (prefers-color-scheme: dark)` depending on existing theme pattern.

**Load More button:**
- If "Load More" button exists in template, ensure it shows simple "Load More" text only (no count, per user decision).
- On click loading state: button text changes to "Loading..." (simple, per recommendation).
  </action>
  <verify>
Files exist: `templates/frontend/skeleton-profile-banner.php`, `templates/frontend/skeleton-posts-list.php`.
Grep for `bluesky-shimmer` in `assets/css/bluesky-social-posts.css` — shimmer keyframes present.
Grep for `bluesky-skeleton` in both skeleton templates — class applied to placeholder elements.
Grep for `is-gif` in `assets/css/bluesky-social-posts.css` — GIF-specific styles present.
  </verify>
  <done>
Skeleton loader templates match real layout dimensions for both profile banner and posts list. CSS shimmer animation runs smoothly with dark mode support. GIF, empty state, and Load More button styles complete.
  </done>
</task>

</tasks>

<verification>
1. GIF images render inline with `is-gif` class and lightbox is prevented
2. Skeleton loaders match layout shape of real content (minimal CLS)
3. Shimmer animation is smooth CSS-only with dark mode support
4. Empty feed shows Bluesky butterfly icon with "No posts yet" message
5. Stale content indicator displays when serving cached data
6. Reply/repost filter toggles continue working identically to before
7. Load More button shows simple "Load More" text
</verification>

<success_criteria>
- Posts with GIF embeds render as inline animated images (not link cards)
- Skeleton placeholders visible during loading with shimmer effect
- Empty feed displays friendly message with icon
- Existing noreplies/noreposts filter attributes produce same filtering behavior as before
- All new CSS integrates with existing theme system (light/dark)
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-content-display/05-02-SUMMARY.md`
</output>
