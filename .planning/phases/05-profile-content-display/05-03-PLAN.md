---
phase: 05-profile-content-display
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - classes/BlueSky_Blocks_Service.php
  - blocks/bluesky-profile-banner.js
  - classes/widgets/BlueSky_Profile_Banner_Widget.php
  - classes/BlueSky_Render_Front.php
  - classes/BlueSky_Assets_Service.php
  - assets/js/bluesky-profile-banner-gradient.js
autonomous: true

must_haves:
  truths:
    - "Profile banner is available as Gutenberg block with layout variant selector in inspector controls"
    - "Profile banner is available as [bluesky_profile_banner] shortcode with layout attribute"
    - "Profile banner is available as classic widget with layout dropdown in widget form"
    - "All three interfaces call the same render_profile_banner() method"
    - "Gradient fallback extracts dominant color from avatar and applies as banner background"
  artifacts:
    - path: "blocks/bluesky-profile-banner.js"
      provides: "Gutenberg block registration with ServerSideRender and inspector controls"
      contains: "bluesky-social/profile-banner"
    - path: "classes/widgets/BlueSky_Profile_Banner_Widget.php"
      provides: "Classic widget extending WP_Widget"
      contains: "BlueSky_Profile_Banner_Widget"
    - path: "classes/BlueSky_Blocks_Service.php"
      provides: "Block registration and render callback for profile banner"
      contains: "profile-banner"
    - path: "assets/js/bluesky-profile-banner-gradient.js"
      provides: "Color Thief integration for gradient fallback"
      contains: "ColorThief"
  key_links:
    - from: "blocks/bluesky-profile-banner.js"
      to: "classes/BlueSky_Blocks_Service.php"
      via: "ServerSideRender calls block render callback"
      pattern: "bluesky-social/profile-banner"
    - from: "classes/BlueSky_Blocks_Service.php"
      to: "classes/BlueSky_Render_Front.php"
      via: "render callback calls render_profile_banner()"
      pattern: "render_profile_banner"
    - from: "classes/widgets/BlueSky_Profile_Banner_Widget.php"
      to: "classes/BlueSky_Render_Front.php"
      via: "widget() calls render_profile_banner()"
      pattern: "render_profile_banner"
---

<objective>
Wire the profile banner renderer into all three WordPress interfaces (Gutenberg block, shortcode, classic widget) and implement the gradient fallback color extraction.

Purpose: Makes the profile banner available to users through every standard WordPress content insertion method (PROF-02 + PROF-03), and completes the gradient fallback for profiles without header images.
Output: Gutenberg block JS, classic widget class, shortcode registration, gradient JS with Color Thief.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-content-display/05-RESEARCH.md
@.planning/phases/05-profile-content-display/05-01-SUMMARY.md
@classes/BlueSky_Blocks_Service.php
@classes/widgets/BlueSky_Profile_Widget.php
@classes/BlueSky_Assets_Service.php
@classes/BlueSky_Render_Front.php
@blocks/bluesky-profile-card.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Gutenberg block, shortcode, and classic widget for profile banner</name>
  <files>
classes/BlueSky_Blocks_Service.php
blocks/bluesky-profile-banner.js
classes/widgets/BlueSky_Profile_Banner_Widget.php
classes/BlueSky_Render_Front.php
  </files>
  <action>
**Gutenberg Block Registration** (`classes/BlueSky_Blocks_Service.php`):

In `register_gutenberg_blocks()`, add a third block registration section for profile banner. Follow the exact pattern of the existing profile card and posts feed blocks:

1. `wp_register_script('bluesky-profile-banner-block', BLUESKY_PLUGIN_FOLDER . 'blocks/bluesky-profile-banner.js', ['wp-blocks', 'wp-element', 'wp-block-editor', 'wp-components', 'wp-server-side-render'], BLUESKY_PLUGIN_VERSION, ['in_footer' => true, 'strategy' => 'defer'])`.
2. `wp_localize_script('bluesky-profile-banner-block', 'blueskyBlockData', ['accounts' => $account_options])`.
3. `register_block_type('bluesky-social/profile-banner', [...])` with attributes:
   - `layout`: type string, default 'full'
   - `accountId`: type string, default ''
   - `theme`: type string, default 'system'
4. `editor_script`: 'bluesky-profile-banner-block'
5. `render_callback`: `[$this, 'bluesky_profile_banner_block_render']`

Add `bluesky_profile_banner_block_render($attributes)` method to BlueSky_Blocks_Service:
- Convert camelCase `accountId` to `account_id`.
- Resolve API handler via existing `resolve_api_handler()`.
- Create `new BlueSky_Render_Front($api_handler)`.
- Return `$render_front->render_profile_banner($attributes)`.

**Gutenberg Block JS** (`blocks/bluesky-profile-banner.js`):

ES5 IIFE pattern matching existing `bluesky-profile-card.js`. Use `wp.serverSideRender` (NOT deprecated `wp.editor.ServerSideRender`).

Inspector controls:
- `SelectControl` for layout variant: Full Banner / Compact Card (values: 'full', 'compact')
- `SelectControl` for account (using `blueskyBlockData.accounts` from localized data)
- `SelectControl` for theme: System / Light / Dark

Block registration:
- `title`: 'Bluesky Profile Banner'
- `icon`: 'admin-users' (same as profile card)
- `category`: 'widgets'
- `edit` function returns InspectorControls + ServerSideRender
- `save` returns null (server-side rendered)

**Shortcode** (`classes/BlueSky_Render_Front.php`):

In `init_hooks()`, add: `add_shortcode('bluesky_profile_banner', [$this, 'bluesky_profile_banner_shortcode'])`.

Add `bluesky_profile_banner_shortcode($atts)` method:
- `shortcode_atts(['layout' => 'full', 'account_id' => '', 'theme' => ''], $atts, 'bluesky_profile_banner')`.
- Return `$this->render_profile_banner($atts)`.

**Classic Widget** (`classes/widgets/BlueSky_Profile_Banner_Widget.php`):

New file. Follow `BlueSky_Profile_Widget` pattern exactly:

1. `__construct()`: parent widget ID 'bluesky_profile_banner_widget', title 'Bluesky Profile Banner'.
2. `widget($args, $instance)`:
   - Extract `$layout` and `$account_id` from `$instance`.
   - Create API handler with per-account support (same pattern as Profile_Widget).
   - Create `BlueSky_Render_Front` instance.
   - Call `render_profile_banner(['layout' => $layout, 'account_id' => $account_id])`.
   - Optional title field: if `!empty($instance['title'])`, output `$args['before_title'] . $title . $args['after_title']`.
3. `form($instance)`:
   - Title text input (default 'Bluesky Profile Banner', allow blank to hide).
   - Layout select: Full Banner / Compact Card.
   - Account select (same multi-account pattern as Profile_Widget).
4. `update($new_instance, $old_instance)`: sanitize title, layout, account_id.

**Register the widget** in `BlueSky_Blocks_Service::register_widgets()`:
- Add `register_widget('BlueSky_Profile_Banner_Widget')`.

**Require the widget file** wherever `BlueSky_Profile_Widget` is required (likely in main plugin file or autoloader).
  </action>
  <verify>
Grep for `bluesky-social/profile-banner` in `classes/BlueSky_Blocks_Service.php` — block registered.
File exists: `blocks/bluesky-profile-banner.js` with `registerBlockType`.
File exists: `classes/widgets/BlueSky_Profile_Banner_Widget.php` with `extends WP_Widget`.
Grep for `bluesky_profile_banner` in `classes/BlueSky_Render_Front.php` — shortcode registered.
Grep for `BlueSky_Profile_Banner_Widget` in `classes/BlueSky_Blocks_Service.php` — widget registered.
  </verify>
  <done>
Profile banner available via Gutenberg block (with layout/account/theme inspector controls), [bluesky_profile_banner] shortcode (with layout/account_id attributes), and classic widget (with title/layout/account dropdowns). All three call render_profile_banner().
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement gradient fallback with Color Thief and enqueue banner assets</name>
  <files>
assets/js/bluesky-profile-banner-gradient.js
classes/BlueSky_Assets_Service.php
  </files>
  <action>
**Gradient Fallback JS** (`assets/js/bluesky-profile-banner-gradient.js`):

ES5 compatible, IIFE wrapped. Runs on DOMContentLoaded:

1. Find all elements with class `bluesky-banner-gradient-pending`.
2. For each element, read `data-avatar-url` attribute.
3. Create offscreen Image, set `crossOrigin = 'Anonymous'` (needed for Color Thief canvas access).
4. On image load:
   - Create `new ColorThief()`.
   - Extract dominant color: `colorThief.getColor(img)` returns `[r, g, b]`.
   - Build gradient: `linear-gradient(135deg, rgb(r,g,b), rgb(r2,g2,b2))` where second color is 20% brighter.
   - Apply gradient as CSS background on the banner header element (`.bluesky-profile-banner-header` for full, the container itself for compact).
   - Remove `bluesky-banner-gradient-pending` class.
5. On image error (CORS failure or network error):
   - Fall back to a hash-based gradient from the avatar URL string.
   - Generate two colors from URL hash: use charCode-based algorithm to produce deterministic RGB values.
   - Apply hash-based gradient (always produces a unique-looking result per account).
   - Remove `bluesky-banner-gradient-pending` class.
6. Include `adjustBrightness(r, g, b, percent)` helper that brightens RGB values by a percentage.

**Important CORS note:** Bluesky CDN may or may not support CORS. The error handler provides a graceful fallback so the feature works regardless. Document this in code comments.

**Asset Enqueuing** (`classes/BlueSky_Assets_Service.php`):

Add frontend asset enqueuing for profile banner:

1. In the frontend styles enqueue method, add:
   - `wp_enqueue_style('bluesky-profile-banner', BLUESKY_PLUGIN_FOLDER . 'assets/css/bluesky-profile-banner.css', [], BLUESKY_PLUGIN_VERSION)`.

2. In the frontend scripts enqueue method, add:
   - `wp_enqueue_script('color-thief', 'https://cdn.jsdelivr.net/npm/colorthief@2.4.0/dist/color-thief.min.js', [], '2.4.0', true)`.
   - `wp_enqueue_script('bluesky-profile-banner-gradient', BLUESKY_PLUGIN_FOLDER . 'assets/js/bluesky-profile-banner-gradient.js', ['color-thief'], BLUESKY_PLUGIN_VERSION, true)`.

3. Only enqueue these when profile banner content is being rendered (conditionally, or always on frontend if conditional detection isn't practical — profile banner CSS is small).

**Lightbox GIF Prevention** — also add to existing lightbox JS:

In `assets/js/bluesky-social-lightbox.js`, add a check: skip lightbox initialization for elements with `data-no-lightbox="true"` or class `is-gif`. This prevents GIFs from opening in the lightbox when clicked.
  </action>
  <verify>
File exists: `assets/js/bluesky-profile-banner-gradient.js` with `ColorThief`.
Grep for `color-thief` in `classes/BlueSky_Assets_Service.php` — CDN script enqueued.
Grep for `bluesky-profile-banner` in `classes/BlueSky_Assets_Service.php` — CSS and JS enqueued.
Grep for `is-gif` or `no-lightbox` in `assets/js/bluesky-social-lightbox.js` — GIF lightbox prevention.
  </verify>
  <done>
Gradient fallback extracts dominant avatar color via Color Thief (with CORS error fallback to hash-based gradient). Profile banner CSS and JS assets enqueued on frontend. GIF images excluded from lightbox behavior.
  </done>
</task>

</tasks>

<verification>
1. Gutenberg block editor shows "Bluesky Profile Banner" block with layout/account inspector controls
2. `[bluesky_profile_banner layout="compact"]` shortcode renders compact variant
3. Classic widget form shows title, layout, and account fields
4. All three interfaces produce identical HTML output for same parameters
5. Gradient fallback activates on profiles without header images
6. Color Thief CDN script loads on frontend
7. GIF images in posts don't trigger lightbox
</verification>

<success_criteria>
- Profile banner block insertable from Gutenberg editor with live preview via ServerSideRender
- Shortcode and widget produce same rendered output as block
- Gradient fallback works (or gracefully falls back to hash-based gradient) when no header image exists
- Banner CSS stylesheet loads on frontend pages
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-content-display/05-03-SUMMARY.md`
</output>
