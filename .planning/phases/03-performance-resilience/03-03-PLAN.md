---
phase: 03-performance-resilience
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - classes/BlueSky_Async_Handler.php
  - social-integration-for-bluesky.php
  - classes/BlueSky_Syndication_Service.php
autonomous: true

must_haves:
  truths:
    - "Post publish triggers an async background job instead of blocking the user"
    - "Syndication retries up to 3 times with 60s/120s/300s delays on failure"
    - "After 3 failed retries, post is marked as failed with status in post meta"
    - "Circuit breaker is checked before each syndication attempt"
    - "When circuit breaker is open, syndication is queued for retry after cooldown"
    - "Multi-account syndication processes accounts sequentially"
    - "Syndication status tracked in post meta (_bluesky_syndication_status)"
  artifacts:
    - path: "classes/BlueSky_Async_Handler.php"
      provides: "Action Scheduler job scheduling and processing for async syndication"
      contains: "class BlueSky_Async_Handler"
    - path: "classes/BlueSky_Syndication_Service.php"
      provides: "Modified syndication that delegates to async handler"
  key_links:
    - from: "classes/BlueSky_Syndication_Service.php"
      to: "classes/BlueSky_Async_Handler.php"
      via: "schedule_syndication() call on post publish"
      pattern: "schedule_syndication"
    - from: "classes/BlueSky_Async_Handler.php"
      to: "classes/BlueSky_Circuit_Breaker.php"
      via: "is_available() check before API call"
      pattern: "BlueSky_Circuit_Breaker.*is_available"
    - from: "classes/BlueSky_Async_Handler.php"
      to: "Action Scheduler"
      via: "as_schedule_single_action() for job scheduling"
      pattern: "as_schedule_single_action"
---

<objective>
Create the async syndication handler that uses Action Scheduler for background job processing, and modify the existing Syndication_Service to delegate to it instead of syndicating synchronously.

Purpose: Post publish should return instantly. Syndication happens in background via Action Scheduler with retry logic (3 attempts at 60s/120s/300s) and circuit breaker integration. This is the core async infrastructure that makes syndication non-blocking.

Output: BlueSky_Async_Handler class + modified Syndication_Service that schedules instead of executing.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-performance-resilience/03-RESEARCH.md
@.planning/phases/03-performance-resilience/03-01-SUMMARY.md
@classes/BlueSky_Syndication_Service.php
@classes/BlueSky_API_Handler.php
@classes/BlueSky_Account_Manager.php
@social-integration-for-bluesky.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlueSky_Async_Handler with Action Scheduler integration</name>
  <files>classes/BlueSky_Async_Handler.php, social-integration-for-bluesky.php</files>
  <action>
Create classes/BlueSky_Async_Handler.php:

Constructor takes $api_handler (BlueSky_API_Handler), $account_manager (BlueSky_Account_Manager optional).
Register Action Scheduler hooks in constructor:
- add_action('bluesky_async_syndicate', [$this, 'process_syndication'], 10, 3)
- add_action('bluesky_retry_syndicate', [$this, 'process_syndication'], 10, 3)

**schedule_syndication($post_id, $account_ids):**
- Check if Action Scheduler is available (function_exists('as_schedule_single_action'))
- If not available, fall back to synchronous syndication via existing code path
- Schedule immediate job: as_schedule_single_action(time(), 'bluesky_async_syndicate', ['post_id' => $post_id, 'account_ids' => $account_ids, 'attempt' => 1], 'bluesky-syndication')
- Set post meta: _bluesky_syndication_status = 'pending'
- Set post meta: _bluesky_syndication_scheduled = current time()

**process_syndication($post_id, $account_ids, $attempt = 1):**
- Process accounts SEQUENTIALLY (loop, not parallel) per discretion choice
- For each account_id:
  1. Check circuit breaker: $breaker = new BlueSky_Circuit_Breaker($account_id); if (!$breaker->is_available()) → queue_for_cooldown()
  2. Check rate limiter: $limiter = new BlueSky_Rate_Limiter(); if ($limiter->is_rate_limited($account_id)) → schedule_retry with rate limit delay
  3. Get account data from account_manager, create API handler via factory method
  4. Call existing syndicate_post_to_bluesky() on the API handler
  5. On success: $breaker->record_success(), mark account as completed in post meta
  6. On failure: $breaker->record_failure(), check rate limit on response
     - If attempt < 3: schedule_retry($post_id, [$account_id], $attempt + 1)
     - If attempt >= 3: mark_failed($post_id, $account_id)
- After processing all accounts, update overall status (completed if all succeed, partial if some failed, failed if all failed)

**schedule_retry($post_id, $account_ids, $attempt):**
- Delays: [60, 120, 300] seconds for attempts 1, 2, 3
- as_schedule_single_action(time() + $delay, 'bluesky_retry_syndicate', [...], 'bluesky-syndication')
- Update post meta _bluesky_syndication_status = 'retrying'

**queue_for_cooldown($post_id, $account_id):**
- Get cooldown remaining from circuit breaker state
- Schedule retry after cooldown: as_schedule_single_action(time() + cooldown_remaining, 'bluesky_retry_syndicate', [...], 'bluesky-syndication')
- No data loss: request is queued, not dropped

**mark_failed($post_id, $account_id):**
- Update _bluesky_syndication_status = 'failed'
- Store failed account IDs in _bluesky_syndication_failed_accounts post meta (JSON array)

**mark_success($post_id, $account_id, $result):**
- Add account to _bluesky_syndication_accounts_completed post meta (JSON array)
- Store syndication result (URI, CID) in existing _bluesky_syndication_bs_post_info format

Add require_once for BlueSky_Async_Handler.php in social-integration-for-bluesky.php (after BlueSky_Syndication_Service.php).

**Action Scheduler bundling:** Check if Action Scheduler is already available (WooCommerce or other plugin provides it). If not, the plugin will gracefully fall back to synchronous execution. Do NOT bundle Action Scheduler in this plan — we use function_exists() guard for graceful degradation. A future plan or admin notice can recommend installing it.
  </action>
  <verify>File exists with all methods. PHP syntax check: `/Users/CRG/Library/Application Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Async_Handler.php`</verify>
  <done>BlueSky_Async_Handler.php exists with schedule_syndication, process_syndication, retry logic, circuit breaker integration, and graceful fallback when Action Scheduler unavailable.</done>
</task>

<task type="auto">
  <name>Task 2: Modify Syndication_Service to delegate to async handler</name>
  <files>classes/BlueSky_Syndication_Service.php</files>
  <action>
Modify the existing BlueSky_Syndication_Service.php to delegate to BlueSky_Async_Handler instead of syndicating synchronously.

**Changes to constructor:**
- Add optional $async_handler parameter (BlueSky_Async_Handler instance)
- Store as $this->async_handler

**Changes to syndicate_post_to_bluesky($new_status, $old_status, $post):**
- Keep ALL existing validation logic (check status transitions, check user auth, check syndication enabled, check post age, check "don't syndicate" flag)
- After validation passes, instead of directly calling API:
  - If $this->async_handler is set: call $this->async_handler->schedule_syndication($post->ID, $account_ids)
  - Else: fall back to existing synchronous syndication code (preserve backward compatibility)
- The existing synchronous syndication methods remain in the class as fallback (do NOT delete them)
- For multi-account path: collect account_ids from post meta or default accounts, pass to async handler

**Key principle:** The Syndication_Service becomes a thin dispatcher. Validation stays here, execution moves to Async_Handler. The old synchronous path remains as fallback for when Action Scheduler is not available.

**Wiring in Plugin_Setup:** The async handler needs to be instantiated in Plugin_Setup and passed to Syndication_Service. Add this wiring — create BlueSky_Async_Handler instance and pass it when constructing Syndication_Service. Check Plugin_Setup.php constructor to see current instantiation pattern and follow it.
  </action>
  <verify>PHP syntax check on modified file. Verify existing syndication validation logic is preserved by reading the file.</verify>
  <done>Syndication_Service delegates to Async_Handler for execution while preserving all validation logic and backward-compatible synchronous fallback.</done>
</task>

</tasks>

<verification>
1. PHP syntax check on all modified files
2. Read BlueSky_Async_Handler.php and verify: schedule_syndication, process_syndication, retry logic, circuit breaker check, rate limit check
3. Read BlueSky_Syndication_Service.php and verify: validation logic preserved, delegates to async handler, synchronous fallback exists
4. Run existing test suite (may need minor updates if Syndication_Service constructor signature changed):
```bash
"/Users/CRG/Library/Application Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php" tests/phpunit.phar --configuration tests/phpunit.xml
```
</verification>

<success_criteria>
- Post publish triggers async job scheduling (not synchronous API call)
- Retry logic: 3 attempts at 60s/120s/300s delays
- Circuit breaker checked before each attempt
- Rate limiter checked before each attempt
- Graceful fallback to synchronous when Action Scheduler unavailable
- No existing validation logic removed from Syndication_Service
- Sequential multi-account processing
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-resilience/03-03-SUMMARY.md`
</output>
