---
phase: 03-performance-resilience
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-03"]
files_modified:
  - classes/BlueSky_Admin_Notices.php
  - assets/js/bluesky-syndication-notice.js
  - classes/BlueSky_Plugin_Setup.php
autonomous: true

must_haves:
  truths:
    - "After publishing a post, admin sees 'Syndicating to Bluesky...' notice (non-blocking)"
    - "Notice updates to success or failure status via Heartbeat API without page reload"
    - "Failed syndication shows 'Retry' link that triggers re-syndication"
    - "Heartbeat listener only active when syndication is pending (no unnecessary polling)"
    - "Post list column shows syndication status for posts"
  artifacts:
    - path: "classes/BlueSky_Admin_Notices.php"
      provides: "Admin notice display, Heartbeat integration, retry AJAX handler"
      contains: "class BlueSky_Admin_Notices"
    - path: "assets/js/bluesky-syndication-notice.js"
      provides: "Heartbeat send/receive hooks and retry button handler"
  key_links:
    - from: "classes/BlueSky_Admin_Notices.php"
      to: "WordPress Heartbeat API"
      via: "heartbeat_received filter"
      pattern: "heartbeat_received.*bluesky"
    - from: "assets/js/bluesky-syndication-notice.js"
      to: "classes/BlueSky_Admin_Notices.php"
      via: "Heartbeat data exchange and AJAX retry"
      pattern: "heartbeat-send.*bluesky_check_syndication"
    - from: "classes/BlueSky_Admin_Notices.php"
      to: "classes/BlueSky_Async_Handler.php"
      via: "Retry triggers schedule_syndication()"
      pattern: "schedule_syndication"
---

<objective>
Create the admin notification system that shows syndication progress, updates via Heartbeat API, and provides retry capability for failed syndications.

Purpose: Users need immediate feedback that syndication is happening (non-blocking notice), live updates on completion/failure (Heartbeat), and a way to retry failures (Retry button). This is the user-facing companion to the async backend from Plan 03.

Output: Admin notice class + JavaScript for Heartbeat integration + retry AJAX endpoint.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-performance-resilience/03-RESEARCH.md
@.planning/phases/03-performance-resilience/03-03-SUMMARY.md
@classes/BlueSky_Plugin_Setup.php
@classes/BlueSky_Assets_Service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlueSky_Admin_Notices class with Heartbeat integration</name>
  <files>classes/BlueSky_Admin_Notices.php, social-integration-for-bluesky.php</files>
  <action>
Create classes/BlueSky_Admin_Notices.php:

**Constructor:** Register hooks:
- add_action('admin_notices', [$this, 'syndication_status_notice'])
- add_filter('heartbeat_received', [$this, 'check_syndication_status'], 10, 2)
- add_action('wp_ajax_bluesky_retry_syndication', [$this, 'handle_retry'])

Store $async_handler reference (BlueSky_Async_Handler) for retry functionality.

**syndication_status_notice():**
- Only show on post edit screens (get_current_screen()->id === 'post' or similar)
- Check global $post for _bluesky_syndication_status meta
- Status 'pending': Show info notice with spinner + "Syndicating to Bluesky..." text + data-post-id attribute for JS
- Status 'completed': Show success notice (dismissible) with account count
- Status 'failed': Show error notice with "Retry now" link (data-post-id attribute, nonce in data attribute)
- Status 'retrying': Show info notice "Retrying syndication to Bluesky (attempt X)..."
- No status or empty: Show nothing

**check_syndication_status($response, $data):**
- If $data['bluesky_check_syndication'] is empty, return $response unchanged
- Get post_id from the data, verify it's a valid post and user can edit it (current_user_can('edit_post', $post_id))
- Read _bluesky_syndication_status from post meta
- Add to $response: 'bluesky_syndication' => ['post_id' => $post_id, 'status' => $status, 'timestamp' => time()]
- If completed, include account count from _bluesky_syndication_accounts_completed
- If failed, include failed account names from _bluesky_syndication_failed_accounts

**handle_retry():**
- Verify nonce: check_ajax_referer('bluesky_retry_syndication', 'nonce')
- Get post_id from $_POST, verify current_user_can('edit_post', $post_id)
- Get account_ids: from _bluesky_syndication_failed_accounts meta, or all configured accounts if not set
- Clear failed status: delete relevant post meta
- Call $this->async_handler->schedule_syndication($post_id, $account_ids)
- Return JSON success response

**Post list integration (bonus):**
- add_filter('manage_posts_columns', [$this, 'add_syndication_column'])
- add_action('manage_posts_custom_column', [$this, 'render_syndication_column'], 10, 2)
- Column shows: checkmark for completed, spinner for pending, X with retry link for failed, dash for not syndicated

Add require_once for BlueSky_Admin_Notices.php in social-integration-for-bluesky.php.

Use text domain 'social-integration-for-bluesky' for all translatable strings.
  </action>
  <verify>PHP syntax check: `/Users/CRG/Library/Application Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php -l classes/BlueSky_Admin_Notices.php`</verify>
  <done>BlueSky_Admin_Notices class handles admin notice display for all syndication states, Heartbeat API integration for live updates, AJAX retry endpoint with nonce verification, and post list syndication status column.</done>
</task>

<task type="auto">
  <name>Task 2: Create Heartbeat JavaScript and wire assets</name>
  <files>assets/js/bluesky-syndication-notice.js, classes/BlueSky_Plugin_Setup.php</files>
  <action>
Create assets/js/bluesky-syndication-notice.js:

**Heartbeat integration:**
- On document ready, check if .bluesky-syndication-notice exists
- If it does, extract post-id from data attribute
- Hook into 'heartbeat-send': add bluesky_check_syndication = postId to data
- Hook into 'heartbeat-tick': check data.bluesky_syndication response
  - If status === 'completed': Replace notice with success notice (green, dismissible, account count message)
  - If status === 'failed': Replace notice with error notice (red, with retry link)
  - If status === 'retrying': Update notice text to show retry attempt
  - On completed or failed: REMOVE the heartbeat-send listener (stop polling once final state reached)

**Retry button handler:**
- Delegate click handler on .bluesky-retry-syndication links
- On click: prevent default, get post-id and nonce from data attributes
- POST to ajaxurl with action: 'bluesky_retry_syndication', post_id, nonce
- On success: Replace error notice with pending notice (spinner + "Retrying..."), re-attach heartbeat listener
- On failure: Show inline error message

**Wire into Plugin_Setup or Assets_Service:**
- Enqueue bluesky-syndication-notice.js only on post edit screens (admin_enqueue_scripts with screen check)
- Use wp_localize_script to pass: ajaxurl, nonce (wp_create_nonce('bluesky_retry_syndication')), i18n strings
- i18n strings: 'syndicating', 'completed', 'failed', 'retrying', 'retry_now'
- Only enqueue when post has _bluesky_syndication_status meta set (performance optimization)

Use jQuery (available in WordPress admin) for Heartbeat API compatibility. Keep the JS minimal and focused.
  </action>
  <verify>JS file exists. Check Plugin_Setup or Assets_Service for enqueue hook. Verify nonce is passed via wp_localize_script.</verify>
  <done>JavaScript handles Heartbeat send/receive for live syndication status updates, retry button triggers AJAX re-syndication, and script is only loaded on relevant admin pages.</done>
</task>

</tasks>

<verification>
1. PHP syntax check on BlueSky_Admin_Notices.php
2. Verify JS file exists at assets/js/bluesky-syndication-notice.js
3. Verify script enqueue is conditional (post edit screens only)
4. Verify nonce creation and verification match
5. Run existing test suite for regressions:
```bash
"/Users/CRG/Library/Application Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php" tests/phpunit.phar --configuration tests/phpunit.xml
```
</verification>

<success_criteria>
- Admin notice shows syndication status (pending/completed/failed/retrying) on post edit screen
- Heartbeat API updates notice in real-time without page reload
- Heartbeat listener stops polling after reaching final state (completed/failed)
- Retry button works with proper nonce verification
- Post list shows syndication status column
- Script only loaded on relevant admin pages
- All strings use proper text domain for i18n
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-resilience/03-04-SUMMARY.md`
</output>
