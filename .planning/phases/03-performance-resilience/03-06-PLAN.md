---
phase: 03-performance-resilience
plan: 06
type: execute
wave: 4
depends_on: ["03-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Post syndication happens asynchronously after publish (doesn't block user)"
    - "Multiple Bluesky blocks on same page make only one API call per account"
    - "Plugin detects HTTP 429 rate limit responses and backs off exponentially"
    - "After 3 consecutive API failures, plugin stops requests for 15 minutes (circuit breaker)"
    - "Stale cached data served with 'last updated' indicator when cache expired"
    - "Failed syndication shows retry button in admin"
    - "All existing functionality still works (no regressions)"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of the complete Performance & Resilience phase. Run all automated tests and verify the full integration works together.

Purpose: Confirm that all resilience components (circuit breaker, rate limiter, request cache, async syndication, admin notices, stale-while-revalidate) work together correctly and no existing functionality has regressed.

Output: Verified phase completion or identified gaps for follow-up.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-performance-resilience/03-01-SUMMARY.md
@.planning/phases/03-performance-resilience/03-02-SUMMARY.md
@.planning/phases/03-performance-resilience/03-03-SUMMARY.md
@.planning/phases/03-performance-resilience/03-04-SUMMARY.md
@.planning/phases/03-performance-resilience/03-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run automated verification suite</name>
  <files></files>
  <action>
Run the complete PHPUnit test suite and verify all tests pass:

```bash
"/Users/CRG/Library/Application Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php" tests/phpunit.phar --configuration tests/phpunit.xml
```

If any tests fail:
1. Identify the failing test and root cause
2. Fix the issue (likely integration wiring or mock updates)
3. Re-run until all pass

Then perform static analysis verification:
1. PHP syntax check on all new files:
   - classes/BlueSky_Circuit_Breaker.php
   - classes/BlueSky_Rate_Limiter.php
   - classes/BlueSky_Request_Cache.php
   - classes/BlueSky_Async_Handler.php
   - classes/BlueSky_Admin_Notices.php

2. Verify all new classes are required in social-integration-for-bluesky.php

3. Verify no PHP errors in modified files:
   - classes/BlueSky_API_Handler.php
   - classes/BlueSky_Syndication_Service.php
   - classes/BlueSky_Render_Front.php
   - classes/BlueSky_Plugin_Setup.php

4. Check for common issues:
   - Undefined class references
   - Missing method calls
   - Incorrect hook registrations
  </action>
  <verify>All PHPUnit tests pass. All PHP files pass syntax check.</verify>
  <done>Full automated test suite passes with zero failures. All PHP files have valid syntax.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of resilience features</name>
  <files></files>
  <action>
Present the verification checklist to the user. The following was built across Plans 03-01 through 03-05:
- BlueSky_Circuit_Breaker: per-account circuit breaker (3 failures = 15-min cooldown, half-open recovery)
- BlueSky_Rate_Limiter: HTTP 429 detection, Retry-After header parsing, exponential backoff (60/120/300s)
- BlueSky_Request_Cache: static in-memory cache for same-page request deduplication
- BlueSky_Async_Handler: Action Scheduler job scheduling with retry logic (3 attempts)
- BlueSky_Admin_Notices: Heartbeat-powered live syndication status + retry button
- API Handler integration: 3-layer cache (request → transient → API) with resilience checks
- Stale-while-revalidate: serve stale cached data with "last updated X ago" indicator

Verification steps for the user:

1. **Async Syndication:**
   - Create a new post in WordPress editor
   - Check "Syndicate to Bluesky" and publish
   - VERIFY: Page does not hang/block during syndication
   - VERIFY: Admin notice shows "Syndicating to Bluesky..."
   - VERIFY: After 15-60 seconds, notice updates to success (green) or failure (red) without page reload

2. **Retry on Failure:**
   - If syndication failed (or simulate by temporarily using wrong credentials):
   - VERIFY: Error notice shows with "Retry now" link
   - Click retry link
   - VERIFY: Notice changes to pending state

3. **Post List Status:**
   - Go to Posts list (wp-admin/edit.php)
   - VERIFY: Syndication status column shows for syndicated posts (checkmark, X, spinner)

4. **Request Deduplication (check browser dev tools):**
   - Create a page with multiple [bluesky_last_posts] shortcodes for the same account
   - View the page
   - VERIFY: Only one API call made (check Network tab or server logs) — subsequent shortcodes use cached data

5. **Stale Cache Indicator:**
   - Wait for cache to expire (or temporarily set very short cache duration in settings)
   - View a page with Bluesky content
   - VERIFY: Content still displays (stale data served)
   - VERIFY: "Last updated X ago" indicator appears below content

6. **General Regression Check:**
   - VERIFY: Profile card shortcode/block still renders correctly
   - VERIFY: Posts feed shortcode/block still renders correctly
   - VERIFY: Settings page still works
   - VERIFY: Multi-account features from Phase 1 still work
  </action>
  <verify>User confirms all 6 verification steps pass or identifies specific issues.</verify>
  <done>Human verification confirms async syndication, retry, request dedup, stale cache, and no regressions. Phase 3 complete.</done>
</task>

</tasks>

<verification>
Phase 3 success criteria from ROADMAP.md:
1. Post syndication happens asynchronously after publish (doesn't block user) - verified by Task 2 step 1
2. Multiple Bluesky blocks on same page make only one API call per account - verified by Task 2 step 4
3. Plugin detects HTTP 429 rate limit responses and backs off exponentially - verified by unit tests (Task 1)
4. After 3 consecutive API failures, plugin stops requests for 15 minutes (circuit breaker) - verified by unit tests (Task 1)
</verification>

<success_criteria>
- All automated tests pass
- Human verification confirms async syndication works
- Human verification confirms retry works
- Human verification confirms no regressions
- Phase 3 success criteria from ROADMAP.md all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-resilience/03-06-SUMMARY.md`
</output>
