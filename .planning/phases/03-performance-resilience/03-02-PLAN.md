---
phase: 03-performance-resilience
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Request_Cache.php
  - tests/test-request-cache.php
autonomous: true

must_haves:
  truths:
    - "Multiple blocks/shortcodes on the same page result in only one API call per unique parameter set"
    - "Request cache returns cached value for identical parameters within same PHP request"
    - "Cache keys are deterministic based on method + parameters"
  artifacts:
    - path: "classes/BlueSky_Request_Cache.php"
      provides: "Static in-memory cache for same-page request deduplication"
      contains: "class BlueSky_Request_Cache"
    - path: "tests/test-request-cache.php"
      provides: "Unit tests for request cache operations"
  key_links:
    - from: "classes/BlueSky_Request_Cache.php"
      to: "classes/BlueSky_API_Handler.php"
      via: "Static method calls before API requests"
      pattern: "BlueSky_Request_Cache::get|::set|::has"
---

<objective>
Create the request-level deduplication cache using TDD. This lightweight static cache prevents duplicate API calls when multiple Bluesky blocks/shortcodes render on the same page.

Purpose: When a page has 3 profile cards and 2 post feeds for the same account, only 2 API calls should be made (one for profile, one for posts) instead of 5. The static variable cache lives only for the current PHP request and costs zero database queries.

Output: Fully tested BlueSky_Request_Cache class ready for integration.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-performance-resilience/03-RESEARCH.md
@tests/bootstrap.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BlueSky_Request_Cache with TDD</name>
  <files>classes/BlueSky_Request_Cache.php, tests/test-request-cache.php</files>
  <action>
RED: Write tests first in tests/test-request-cache.php covering:
- get() returns null for non-existent key
- set() stores value, get() returns it
- has() returns false for non-existent key, true after set()
- build_key() returns deterministic key for same method + params
- build_key() returns different keys for different params
- build_key() returns different keys for different methods
- flush() clears all cached data
- Cache survives within same test method (simulating same request)
- After flush(), previously cached data is gone

Note: No Brain Monkey needed for this class â€” it's pure PHP with static variables and no WordPress function calls.

GREEN: Implement classes/BlueSky_Request_Cache.php:
- Private static $cache = [] (in-memory store)
- public static get($key): return cached value or null
- public static set($key, $value): store in static array
- public static has($key): check if key exists in cache
- public static build_key($method, $params): create deterministic key from 'bluesky_' . $method . '_' . md5(serialize($params))
- public static flush(): reset $cache to empty array (useful for testing and edge cases)

IMPORTANT: The setUp() method in the test class MUST call BlueSky_Request_Cache::flush() to ensure test isolation (static state persists across tests).

REFACTOR: Clean up if needed.

Run tests: `/Users/CRG/Library/Application Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php tests/phpunit.phar --configuration tests/phpunit.xml --filter RequestCache`
  </action>
  <verify>All request cache tests pass with zero failures.</verify>
  <done>BlueSky_Request_Cache class provides static in-memory caching with deterministic key building, and all tests pass.</done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
"/Users/CRG/Library/Application Support/Local/lightning-services/php-8.3.8+0/bin/darwin/bin/php" tests/phpunit.phar --configuration tests/phpunit.xml
```
All tests pass including new request cache tests.
</verification>

<success_criteria>
- BlueSky_Request_Cache.php provides static get/set/has/flush/build_key methods
- Cache is request-scoped (static variable, not database)
- Key generation is deterministic for identical inputs
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-resilience/03-02-SUMMARY.md`
</output>
