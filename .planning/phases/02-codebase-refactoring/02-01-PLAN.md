---
phase: 02-codebase-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - phpunit.xml
  - tests/bootstrap.php
  - tests/unit/.gitkeep
  - classes/BlueSky_Helpers.php
autonomous: true
must_haves:
  truths:
    - "PHPUnit can run with Brain Monkey mocking WP functions"
    - "normalize_bluesky_handle is available as a static Helpers method"
  artifacts:
    - path: "phpunit.xml"
      provides: "PHPUnit configuration"
      contains: "bootstrap"
    - path: "tests/bootstrap.php"
      provides: "Test bootstrap with Brain Monkey"
      contains: "Brain\\Monkey"
    - path: "classes/BlueSky_Helpers.php"
      provides: "normalize_handle static method"
      contains: "normalize_handle"
  key_links:
    - from: "phpunit.xml"
      to: "tests/bootstrap.php"
      via: "bootstrap attribute"
      pattern: 'bootstrap="tests/bootstrap.php"'
    - from: "tests/bootstrap.php"
      to: "classes/"
      via: "require_once for classes under test"
      pattern: "require_once.*classes/"
---

<objective>
Set up PHPUnit + Brain Monkey test infrastructure and move normalize_bluesky_handle to Helpers.

Purpose: Test infrastructure must exist before service extraction so tests can be written for extracted services. Moving normalize_bluesky_handle to Helpers resolves a cross-cutting concern before the main extraction.
Output: Working test runner, updated Helpers class.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-codebase-refactoring/02-RESEARCH.md
@classes/BlueSky_Helpers.php
@classes/BlueSky_Plugin_Setup.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up PHPUnit + Brain Monkey test infrastructure</name>
  <files>phpunit.xml, tests/bootstrap.php, tests/unit/.gitkeep, .gitignore</files>
  <action>
1. Install PHPUnit 9 PHAR to project root:
   ```
   curl -L https://phar.phpunit.de/phpunit-9.phar -o phpunit.phar && chmod +x phpunit.phar
   ```

2. Create tests/ directory with composer.json for Brain Monkey dev dependency:
   ```
   cd tests && composer require --dev brain-wp/brain-monkey:^2
   ```

3. Create `tests/bootstrap.php`:
   - Define WP constants: ABSPATH, BLUESKY_PLUGIN_OPTIONS, BLUESKY_PLUGIN_VERSION, BLUESKY_PLUGIN_FILE, BLUESKY_PLUGIN_BASENAME, BLUESKY_PLUGIN_FOLDER, BLUESKY_PLUGIN_DIRECTORY_NAME, BLUESKY_PLUGIN_SETTING_PAGENAME, BLUESKY_PLUGIN_TRANSIENT
   - Require `__DIR__ . '/vendor/autoload.php'` (Brain Monkey autoloader)
   - Require class files under test via require_once: BlueSky_Helpers.php, BlueSky_Account_Manager.php, BlueSky_API_Handler.php
   - Do NOT require WordPress core files or wp-load.php

4. Create `phpunit.xml` at project root:
   - Bootstrap: tests/bootstrap.php
   - Test suite "Unit" pointing to tests/unit directory
   - Coverage include: classes/ directory with .php suffix
   - Colors enabled

5. Create `tests/unit/.gitkeep` (empty placeholder)

6. Update `.gitignore` to add:
   - `phpunit.phar`
   - `tests/vendor/`
   - `.phpunit.result.cache`

7. Create a smoke test `tests/unit/SmokeTest.php` that extends TestCase, calls Monkey\setUp() in setUp() and Monkey\tearDown() in tearDown(), and has one test that asserts true === true. This validates the infrastructure works.

8. Run `./phpunit.phar --configuration phpunit.xml` to verify the smoke test passes.
  </action>
  <verify>Run `./phpunit.phar --configuration phpunit.xml` from project root. Output shows "OK (1 test, 1 assertion)".</verify>
  <done>PHPUnit runs successfully with Brain Monkey loaded, smoke test passes, no WordPress install required.</done>
</task>

<task type="auto">
  <name>Task 2: Move normalize_bluesky_handle to BlueSky_Helpers as public static</name>
  <files>classes/BlueSky_Helpers.php, classes/BlueSky_Plugin_Setup.php</files>
  <action>
1. Read `BlueSky_Plugin_Setup.php` and find the `normalize_bluesky_handle($handle)` method (around line 495-511). Copy its logic.

2. Add to `BlueSky_Helpers.php` a new public static method:
   ```php
   public static function normalize_handle($handle) {
       // Paste logic from Plugin_Setup::normalize_bluesky_handle
       // Keep exact same behavior: email passthrough, bare username gets .bsky.social suffix
   }
   ```

3. In `BlueSky_Plugin_Setup.php`, replace the private `normalize_bluesky_handle()` method body with a delegation to the static helper:
   ```php
   private function normalize_bluesky_handle($handle) {
       return BlueSky_Helpers::normalize_handle($handle);
   }
   ```
   Keep the private method as a thin wrapper for now (it will be removed when Plugin_Setup is refactored in Plan 02). This avoids breaking any internal calls during this plan.

4. Search for any other call sites of normalize_bluesky_handle across the codebase (grep for "normalize_bluesky_handle" and "normalize_handle"). Update any direct calls outside Plugin_Setup to use `BlueSky_Helpers::normalize_handle()`.

5. Verify no PHP syntax errors: `php -l classes/BlueSky_Helpers.php && php -l classes/BlueSky_Plugin_Setup.php`
  </action>
  <verify>Run `php -l classes/BlueSky_Helpers.php` and `php -l classes/BlueSky_Plugin_Setup.php` -- both report no syntax errors. Grep for `normalize_handle` in classes/ confirms the static method exists in Helpers.</verify>
  <done>normalize_handle is a public static method on BlueSky_Helpers. Plugin_Setup delegates to it. No other call sites are broken.</done>
</task>

</tasks>

<verification>
- `./phpunit.phar --configuration phpunit.xml` passes with 1 test
- `php -l classes/BlueSky_Helpers.php` reports no errors
- `php -l classes/BlueSky_Plugin_Setup.php` reports no errors
- `grep -r "normalize_handle" classes/` shows Helpers has the static method
</verification>

<success_criteria>
PHPUnit + Brain Monkey infrastructure is operational. normalize_bluesky_handle lives in Helpers as a reusable static method. Plugin still loads without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-refactoring/02-01-SUMMARY.md`
</output>
