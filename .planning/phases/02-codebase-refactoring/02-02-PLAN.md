---
phase: 02-codebase-refactoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - classes/BlueSky_Settings_Service.php
  - classes/BlueSky_Syndication_Service.php
  - classes/BlueSky_AJAX_Service.php
  - classes/BlueSky_Assets_Service.php
  - classes/BlueSky_Blocks_Service.php
  - classes/BlueSky_Plugin_Setup.php
  - social-integration-for-bluesky.php
autonomous: true
must_haves:
  truths:
    - "Plugin_Setup is a thin coordinator with only init_hooks() and constructor"
    - "Settings_Service handles all settings registration, field rendering, and admin page rendering"
    - "AJAX_Service handles all AJAX endpoints"
    - "Syndication_Service handles post syndication and activation hook"
    - "Assets_Service handles script and style enqueuing"
    - "Blocks_Service handles block registration, widget registration, and textdomain"
    - "Plugin loads and all features work identically to before"
  artifacts:
    - path: "classes/BlueSky_Settings_Service.php"
      provides: "Settings registration, field renders, admin page"
      contains: "class BlueSky_Settings_Service"
    - path: "classes/BlueSky_Syndication_Service.php"
      provides: "Syndication logic"
      contains: "class BlueSky_Syndication_Service"
    - path: "classes/BlueSky_AJAX_Service.php"
      provides: "All AJAX handlers"
      contains: "class BlueSky_AJAX_Service"
    - path: "classes/BlueSky_Assets_Service.php"
      provides: "Script/style enqueuing"
      contains: "class BlueSky_Assets_Service"
    - path: "classes/BlueSky_Blocks_Service.php"
      provides: "Blocks, widgets, textdomain"
      contains: "class BlueSky_Blocks_Service"
    - path: "classes/BlueSky_Plugin_Setup.php"
      provides: "Thin coordinator with hook registration only"
      min_lines: 50
    - path: "social-integration-for-bluesky.php"
      provides: "Updated require_once and instantiation"
      contains: "BlueSky_Settings_Service"
  key_links:
    - from: "classes/BlueSky_Plugin_Setup.php"
      to: "classes/BlueSky_Settings_Service.php"
      via: "constructor instantiation + hook delegation"
      pattern: "new BlueSky_Settings_Service"
    - from: "classes/BlueSky_Plugin_Setup.php"
      to: "classes/BlueSky_AJAX_Service.php"
      via: "constructor instantiation + hook delegation"
      pattern: "new BlueSky_AJAX_Service"
    - from: "social-integration-for-bluesky.php"
      to: "classes/BlueSky_Settings_Service.php"
      via: "require_once"
      pattern: "require_once.*BlueSky_Settings_Service"
---

<objective>
Extract 5 service classes from BlueSky_Plugin_Setup and rewrite it as a thin coordinator.

Purpose: This is the core decomposition. Plugin_Setup (3421 lines) becomes ~100 lines of hook registration delegating to focused service classes. Each service receives dependencies via constructor injection.
Output: 5 new service classes + thin Plugin_Setup + updated main plugin file.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-codebase-refactoring/02-RESEARCH.md
@classes/BlueSky_Plugin_Setup.php
@social-integration-for-bluesky.php
@classes/BlueSky_Helpers.php
@classes/BlueSky_API_Handler.php
@classes/BlueSky_Account_Manager.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 5 service classes by extracting methods from Plugin_Setup</name>
  <files>classes/BlueSky_Settings_Service.php, classes/BlueSky_Syndication_Service.php, classes/BlueSky_AJAX_Service.php, classes/BlueSky_Assets_Service.php, classes/BlueSky_Blocks_Service.php</files>
  <action>
Read BlueSky_Plugin_Setup.php fully. Create each service class following the research extraction map exactly.

**For ALL service classes**, follow this DI pattern (per research recommendation):
```php
class BlueSky_*_Service {
    private $api_handler;
    private $account_manager;
    private $helpers;
    private $options;

    public function __construct(BlueSky_API_Handler $api_handler, BlueSky_Account_Manager $account_manager) {
        $this->api_handler = $api_handler;
        $this->account_manager = $account_manager;
        $this->helpers = new BlueSky_Helpers();
        $this->options = get_option(BLUESKY_PLUGIN_OPTIONS, []);
    }
}
```
Only include dependencies actually used by that service. Assets_Service may not need api_handler.

**BlueSky_Settings_Service.php** -- Extract these methods from Plugin_Setup:
- add_plugin_action_links, add_admin_menu
- register_settings, sanitize_settings (update normalize_bluesky_handle calls to use BlueSky_Helpers::normalize_handle())
- add_settings_fields
- settings_section_callback, customization_section_callback, discussions_section_callback
- ALL render_*_field methods (~20 methods, lines 729-1399)
- display_cache_status, get_transient_expiration_time, format_time_remaining
- handle_account_actions
- render_settings_page (the 870-line method -- copy as-is for now, template extraction happens in Plan 04)
- display_bluesky_logout_message

CRITICAL: In every extracted method, replace `$this->helpers` references with `$this->helpers`, `$this->api_handler` with `$this->api_handler`, `$this->options` with `$this->options`, `$this->account_manager` with `$this->account_manager`. These property names should match. But verify each method's $this-> references map to actual constructor-injected properties. If Plugin_Setup used `$this->render_front` or other properties not in the new class, resolve them (pass as parameter or inject via constructor).

**BlueSky_Syndication_Service.php** -- Extract:
- on_plugin_activation
- syndicate_post_to_bluesky (the transition_post_status callback)
- syndicate_post_multi_account

These methods reference $this->api_handler, $this->account_manager, $this->options, $this->helpers. Ensure constructor provides all.

**BlueSky_AJAX_Service.php** -- Extract:
- ajax_fetch_bluesky_posts (legacy, currently no nonce -- DO NOT add nonce yet, that's Plan 05)
- ajax_get_bluesky_profile (legacy, currently no nonce -- DO NOT add nonce yet)
- ajax_async_posts
- ajax_async_profile
- ajax_async_auth
- clear_content_transients

These reference $this->api_handler, $this->account_manager, $this->options, $this->helpers.

**BlueSky_Assets_Service.php** -- Extract:
- admin_enqueue_scripts
- frontend_enqueue_scripts

These reference $this->options and WordPress enqueue functions. Constructor needs only options (no api_handler/account_manager unless referenced). Check if admin_enqueue_scripts references $this->account_manager for multi-account data -- if so, inject it.

**BlueSky_Blocks_Service.php** -- Extract:
- load_plugin_textdomain
- register_gutenberg_blocks
- register_widgets
- bluesky_profile_block_render
- bluesky_posts_block_render

Block render callbacks use $this->render_front or call Render_Front methods. The Blocks_Service needs a reference to BlueSky_Render_Front. Add it as a constructor parameter.

After creating each file, run `php -l classes/BlueSky_*_Service.php` to check for syntax errors.
  </action>
  <verify>Run `php -l` on each new service file. All report "No syntax errors detected".</verify>
  <done>Five service classes exist with all methods extracted from Plugin_Setup. Each has proper constructor DI. No syntax errors.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite Plugin_Setup as thin coordinator and update main plugin file</name>
  <files>classes/BlueSky_Plugin_Setup.php, social-integration-for-bluesky.php</files>
  <action>
**Rewrite BlueSky_Plugin_Setup.php:**

1. Remove ALL extracted methods (everything except constructor and init_hooks).

2. Rewrite constructor to instantiate service classes:
```php
class BlueSky_Plugin_Setup {
    private $settings;
    private $ajax;
    private $syndication;
    private $assets;
    private $blocks;
    private $render_front;

    public function __construct(
        BlueSky_API_Handler $api_handler,
        BlueSky_Account_Manager $account_manager
    ) {
        $this->render_front = new BlueSky_Render_Front($api_handler);
        $this->settings     = new BlueSky_Settings_Service($api_handler, $account_manager);
        $this->ajax         = new BlueSky_AJAX_Service($api_handler, $account_manager);
        $this->syndication  = new BlueSky_Syndication_Service($api_handler, $account_manager);
        $this->assets       = new BlueSky_Assets_Service(/* deps as needed */);
        $this->blocks       = new BlueSky_Blocks_Service($api_handler, $account_manager, $this->render_front);
        $this->init_hooks();
    }
```

3. Rewrite init_hooks() following the exact pattern from research (02-RESEARCH.md "Thin Coordinator Hook Registration" code example). Map every existing add_action/add_filter call to the appropriate service. Preserve exact hook names, priorities, and argument counts. Do NOT change any hook registration -- only change the callback target from `[$this, 'method']` to `[$this->service, 'method']`.

CRITICAL: Compare the NEW init_hooks against the OLD init_hooks line by line. Every hook in the old version must appear in the new version with the same priority and accepted_args. Missing a hook = broken feature.

4. The final Plugin_Setup.php should be ~100-150 lines total.

**Update social-integration-for-bluesky.php:**

1. Add require_once lines for all 5 new service classes BEFORE the Plugin_Setup require:
```php
require_once "classes/BlueSky_Settings_Service.php";
require_once "classes/BlueSky_Syndication_Service.php";
require_once "classes/BlueSky_AJAX_Service.php";
require_once "classes/BlueSky_Assets_Service.php";
require_once "classes/BlueSky_Blocks_Service.php";
```

2. Remove the separate `$bluesky_render_front = new BlueSky_Render_Front($bluesky_api_handler);` line since Plugin_Setup now creates Render_Front internally. BUT check if $bluesky_render_front is used elsewhere in the file or referenced globally -- if so, keep it or expose it from Plugin_Setup.

3. Run `php -l` on both files.

4. Verify no method is left behind in Plugin_Setup that should have been extracted (grep for function declarations -- should only find __construct and init_hooks).
  </action>
  <verify>
Run `php -l classes/BlueSky_Plugin_Setup.php && php -l social-integration-for-bluesky.php` -- no syntax errors.
Run `grep "function " classes/BlueSky_Plugin_Setup.php` -- should show only __construct and init_hooks.
Count lines: `wc -l classes/BlueSky_Plugin_Setup.php` -- should be under 200 lines.
  </verify>
  <done>Plugin_Setup is a thin coordinator under 200 lines with only __construct and init_hooks. Main plugin file loads all service classes. All hook registrations preserved exactly.</done>
</task>

</tasks>

<verification>
- All 5 service files pass `php -l`
- Plugin_Setup.php passes `php -l` and contains only __construct + init_hooks
- social-integration-for-bluesky.php passes `php -l`
- `grep -c "add_action\|add_filter\|add_shortcode\|register_activation_hook" classes/BlueSky_Plugin_Setup.php` matches the count from the original
- No extracted method remains in Plugin_Setup (grep confirms only __construct, init_hooks)
</verification>

<success_criteria>
Plugin_Setup is under 200 lines. Five service classes contain all extracted business logic. Main plugin file loads everything correctly. PHP syntax is valid across all modified files.
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-refactoring/02-02-SUMMARY.md`
</output>
