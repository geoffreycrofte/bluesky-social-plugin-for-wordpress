---
phase: 02-codebase-refactoring
plan: 06
type: execute
wave: 4
depends_on: ["02-01", "02-02", "02-03", "02-05"]
files_modified:
  - tests/unit/BlueSky_AJAX_Service_Test.php
  - tests/unit/BlueSky_Syndication_Service_Test.php
  - tests/unit/BlueSky_API_Handler_Test.php
  - tests/unit/BlueSky_Settings_Service_Test.php
  - tests/unit/BlueSky_Helpers_Test.php
  - tests/bootstrap.php
autonomous: true
must_haves:
  truths:
    - "PHPUnit tests pass for AJAX nonce verification and auth checks"
    - "PHPUnit tests pass for syndication post status guards and sanitization"
    - "PHPUnit tests pass for API Handler authentication and factory method"
    - "PHPUnit tests pass for settings sanitization and handle normalization"
    - "PHPUnit tests pass for Helpers utility methods"
  artifacts:
    - path: "tests/unit/BlueSky_AJAX_Service_Test.php"
      provides: "AJAX security and handler tests"
      contains: "check_ajax_referer"
    - path: "tests/unit/BlueSky_Syndication_Service_Test.php"
      provides: "Syndication guard and logic tests"
      contains: "syndicate_post_to_bluesky"
    - path: "tests/unit/BlueSky_API_Handler_Test.php"
      provides: "API Handler authentication and factory tests"
      contains: "create_for_account"
    - path: "tests/unit/BlueSky_Settings_Service_Test.php"
      provides: "Settings sanitization tests"
      contains: "sanitize_settings"
    - path: "tests/unit/BlueSky_Helpers_Test.php"
      provides: "Helpers utility tests"
      contains: "normalize_handle"
  key_links:
    - from: "tests/unit/BlueSky_AJAX_Service_Test.php"
      to: "classes/BlueSky_AJAX_Service.php"
      via: "instantiates and tests methods"
      pattern: "new BlueSky_AJAX_Service"
    - from: "tests/bootstrap.php"
      to: "classes/"
      via: "require_once for all classes under test"
      pattern: "require_once.*classes/"
---

<objective>
Write PHPUnit tests for the 5 highest-priority areas: AJAX security, API Handler, syndication logic, settings sanitization, and Helpers utilities.

Purpose: Test coverage for critical paths ensures the refactoring preserved correct behavior and security fixes are verified. Priority order per research: AJAX (security) > API Handler (core) > Syndication (business value) > Settings (user input) > Helpers (utilities).
Output: Test suite with 20-30 tests covering critical paths.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-codebase-refactoring/02-RESEARCH.md
@.planning/phases/02-codebase-refactoring/02-01-SUMMARY.md
@.planning/phases/02-codebase-refactoring/02-02-SUMMARY.md
@.planning/phases/02-codebase-refactoring/02-05-SUMMARY.md
@classes/BlueSky_AJAX_Service.php
@classes/BlueSky_Syndication_Service.php
@classes/BlueSky_Settings_Service.php
@classes/BlueSky_Helpers.php
@tests/bootstrap.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write AJAX, API Handler, and Syndication service tests</name>
  <files>tests/unit/BlueSky_AJAX_Service_Test.php, tests/unit/BlueSky_API_Handler_Test.php, tests/unit/BlueSky_Syndication_Service_Test.php, tests/bootstrap.php</files>
  <action>
First, update `tests/bootstrap.php` to require ALL service classes needed for testing:
- BlueSky_AJAX_Service.php
- BlueSky_Syndication_Service.php
- BlueSky_Settings_Service.php
(In addition to Helpers, Account_Manager, API_Handler already required from Plan 01.)

**BlueSky_AJAX_Service_Test.php** -- Follow the Brain Monkey test pattern from research. Each test class:
- extends PHPUnit\Framework\TestCase
- calls Monkey\setUp() in setUp(), Monkey\tearDown() in tearDown()
- creates mock $api_handler and $account_manager via $this->createMock()

Tests to write (minimum 6):
1. `test_ajax_fetch_bluesky_posts_verifies_nonce` -- Expect check_ajax_referer called with 'bluesky_async_nonce', 'nonce'
2. `test_ajax_get_bluesky_profile_verifies_nonce` -- Same nonce check
3. `test_ajax_async_auth_rejects_non_admin` -- current_user_can('manage_options') returns false, expect wp_send_json_error
4. `test_ajax_async_auth_allows_admin` -- current_user_can returns true, verify it proceeds (mock remaining dependencies)
5. `test_ajax_async_posts_verifies_nonce` -- Existing nonce check still works
6. `test_clear_content_transients_deletes_caches` -- Verify delete_transient called

Use Brain Monkey Functions\expect() to stub WP functions. Set $_POST values as needed for test inputs.

**BlueSky_API_Handler_Test.php** -- Tests (minimum 4):
1. `test_create_for_account_sets_account_id` -- Call BlueSky_API_Handler::create_for_account() with account data, verify returned instance has correct account_id property
2. `test_create_for_account_sets_credentials` -- Verify returned instance has handle and decrypted app_password from account data
3. `test_authenticate_caches_token_in_transient` -- After successful authenticate(), verify set_transient is called with token data
4. `test_authenticate_uses_cached_token` -- When get_transient returns valid token, verify no HTTP request is made (wp_remote_post not called)

For API Handler tests, mock wp_remote_post to simulate Bluesky API responses. Mock get_transient/set_transient for token caching. Use a mock account array with handle, app_password, and id fields.

**BlueSky_Syndication_Service_Test.php** -- Tests (minimum 5):
1. `test_syndicate_skips_non_publish_transition` -- Call with 'draft' to 'draft', verify no API call
2. `test_syndicate_skips_when_dont_syndicate_set` -- Set $_POST['bluesky_dont_syndicate'] = '1', verify return
3. `test_syndicate_checks_user_capability` -- current_user_can('edit_post', id) returns false, verify return
4. `test_syndicate_skips_already_syndicated` -- get_post_meta returns truthy _bluesky_syndicated, verify skip
5. `test_syndicate_sanitizes_post_data` -- Verify sanitize_text_field and wp_unslash are called on POST data

For syndication tests, you'll need to mock:
- Functions\expect('get_post_meta'), Functions\expect('update_post_meta')
- Functions\expect('current_user_can')
- Functions\expect('sanitize_text_field')->andReturnFirstArg()
- Functions\expect('wp_unslash')->andReturnFirstArg()
- The $post object (use stdClass with ID, post_title, post_content, post_excerpt properties)

Run `./phpunit.phar --configuration phpunit.xml` after creating both test files.
  </action>
  <verify>Run `./phpunit.phar --configuration phpunit.xml` -- all tests pass (15+ tests, 0 failures). If any fail, fix the test or the code issue.</verify>
  <done>AJAX service tests verify nonce checks on all endpoints and auth gating. API Handler tests verify factory method and token caching. Syndication tests verify post status guards, capability checks, and sanitization. All pass.</done>
</task>

<task type="auto">
  <name>Task 2: Write Settings sanitization and Helpers utility tests</name>
  <files>tests/unit/BlueSky_Settings_Service_Test.php, tests/unit/BlueSky_Helpers_Test.php</files>
  <action>
**BlueSky_Settings_Service_Test.php** -- Tests (minimum 5):
1. `test_sanitize_settings_normalizes_handle_email` -- Input email address, verify it passes through unchanged (BlueSky_Helpers::normalize_handle)
2. `test_sanitize_settings_normalizes_bare_username` -- Input "alice", verify ".bsky.social" appended
3. `test_sanitize_settings_normalizes_full_handle` -- Input "alice.bsky.social", verify unchanged
4. `test_sanitize_settings_validates_cache_duration` -- Test various cache_duration inputs are sanitized to valid values
5. `test_sanitize_settings_preserves_encrypted_password` -- When no new password provided, existing encrypted value preserved

For Settings tests, mock get_option, sanitize_text_field, wp_unslash, absint as needed. The sanitize_settings method takes an array input and returns a sanitized array -- test the input/output contract.

**BlueSky_Helpers_Test.php** -- Tests (minimum 4):
1. `test_normalize_handle_email_passthrough` -- "user@example.com" returns "user@example.com"
2. `test_normalize_handle_bare_username_gets_suffix` -- "alice" returns "alice.bsky.social"
3. `test_normalize_handle_full_handle_unchanged` -- "alice.bsky.social" returns "alice.bsky.social"
4. `test_normalize_handle_custom_domain` -- "alice.example.com" returns "alice.example.com" (has dot, no suffix)

Additional Helpers tests if time:
5. `test_encrypt_decrypt_roundtrip` -- Encrypt a value, decrypt it, verify match (mock wp_salt if needed)
6. `test_get_transient_key_includes_account_id` -- Verify transient key construction

Run `./phpunit.phar --configuration phpunit.xml` after adding these tests.
  </action>
  <verify>Run `./phpunit.phar --configuration phpunit.xml` -- ALL tests pass (20+ total, 0 failures). Output shows both new test files executed.</verify>
  <done>Settings sanitization tests verify handle normalization, cache validation, and password preservation. Helpers tests verify normalize_handle behavior and encryption. Full suite passes.</done>
</task>

</tasks>

<verification>
- `./phpunit.phar --configuration phpunit.xml` shows 24+ tests, 0 failures
- Test coverage hits AJAX, API Handler, Syndication, Settings sanitize, Helpers (the 5 research priorities)
- No test requires a real WordPress installation or database
- All tests use Brain Monkey for WP function mocking
</verification>

<success_criteria>
PHPUnit test suite covers the 5 highest-priority areas with 24+ passing tests. Security fixes (nonce, capability, sanitization) are verified by tests. No WordPress install required to run tests.
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-refactoring/02-06-SUMMARY.md`
</output>
