---
phase: 02-codebase-refactoring
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - classes/BlueSky_AJAX_Service.php
  - classes/BlueSky_Syndication_Service.php
  - classes/BlueSky_Settings_Service.php
  - classes/BlueSky_Discussion_Metabox.php
  - classes/BlueSky_Post_Metabox.php
  - classes/BlueSky_Assets_Service.php
  - assets/js/bluesky-async-loader.js
autonomous: true
must_haves:
  truths:
    - "Legacy AJAX endpoints verify nonce via check_ajax_referer"
    - "godmode debug sidebar requires manage_options capability"
    - "Syndication POST data is sanitized with sanitize_text_field(wp_unslash())"
    - "Syndication checks current_user_can('edit_post', $post_id)"
    - "All PHP user-facing strings wrapped in __() or esc_html__()"
    - "All JS user-facing strings use blueskyAsync.i18n.* references"
  artifacts:
    - path: "classes/BlueSky_AJAX_Service.php"
      provides: "Nonce-protected AJAX handlers"
      contains: "check_ajax_referer"
    - path: "assets/js/bluesky-async-loader.js"
      provides: "Externalized i18n strings"
      contains: "blueskyAsync.i18n"
  key_links:
    - from: "classes/BlueSky_Assets_Service.php"
      to: "assets/js/bluesky-async-loader.js"
      via: "wp_localize_script i18n sub-object"
      pattern: "i18n.*=>"
    - from: "assets/js/bluesky-async-loader.js"
      to: "classes/BlueSky_Assets_Service.php"
      via: "reads blueskyAsync.i18n properties"
      pattern: "blueskyAsync\\.i18n\\."
---

<objective>
Apply security fixes and internationalization to all extracted service classes and JS files.

Purpose: Fix 3 identified security vulnerabilities (legacy AJAX nonce, godmode auth, POST sanitization) and ensure all user-facing strings are translatable (9 PHP strings, 13 JS strings). Text domain: 'social-integration-for-bluesky'.
Output: Hardened services with complete i18n coverage.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-codebase-refactoring/02-RESEARCH.md
@.planning/phases/02-codebase-refactoring/02-02-SUMMARY.md
@.planning/phases/02-codebase-refactoring/02-03-SUMMARY.md
@classes/BlueSky_AJAX_Service.php
@classes/BlueSky_Syndication_Service.php
@classes/BlueSky_Settings_Service.php
@classes/BlueSky_Assets_Service.php
@classes/BlueSky_Post_Metabox.php
@assets/js/bluesky-async-loader.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply security fixes to AJAX, Syndication, and Settings services</name>
  <files>classes/BlueSky_AJAX_Service.php, classes/BlueSky_Syndication_Service.php, classes/BlueSky_Settings_Service.php</files>
  <action>
**Security Fix 1 -- Legacy AJAX nonce (BlueSky_AJAX_Service.php):**

Add `check_ajax_referer('bluesky_async_nonce', 'nonce');` as the FIRST line in:
- `ajax_fetch_bluesky_posts()` -- currently has NO nonce check
- `ajax_get_bluesky_profile()` -- currently has NO nonce check

These endpoints are registered as nopriv (public visitors use them). The nonce is already localized to frontend via `blueskyAsync.nonce` in the existing wp_localize_script call. The newer async variants already use this exact nonce. Adding it to legacy endpoints makes them consistent.

IMPORTANT: Verify that the frontend JS that calls these legacy endpoints sends the nonce. Search `assets/js/` for `fetch_bluesky_posts` and `get_bluesky_profile` action strings. If the JS does NOT send a nonce with these requests, update the JS to include `nonce: blueskyAsync.nonce` in the AJAX data. If no JS calls these legacy endpoints (superseded by async variants), they may be dead code -- still add the nonce check for safety but note in a comment that these may be deprecated.

**Security Fix 2 -- godmode debug sidebar (BlueSky_Settings_Service.php):**

Find the godmode conditional in render_settings_page (or in the settings-page.php template if already extracted). Change from:
```php
if (isset($_GET["godmode"]) || defined("WP_DEBUG") || defined("WP_DEBUG_DISPLAY")) {
```
To:
```php
if (
    (isset($_GET["godmode"]) && current_user_can("manage_options")) ||
    defined("WP_DEBUG") ||
    defined("WP_DEBUG_DISPLAY")
) {
```
This is in the template file if Plan 04 already ran. Check both locations.

**Security Fix 3 -- Syndication POST data (BlueSky_Syndication_Service.php):**

In `syndicate_post_to_bluesky()`, find the `$_POST["bluesky_dont_syndicate"]` check. Replace with:
```php
$dont_syndicate_post = isset($_POST["bluesky_dont_syndicate"])
    ? sanitize_text_field(wp_unslash($_POST["bluesky_dont_syndicate"]))
    : "0";
```

Also add capability check early in the method:
```php
if (!current_user_can('edit_post', $post->ID)) {
    return;
}
```
Place this after the post status checks but before any syndication logic.

Similarly, sanitize any other raw `$_POST` access in the syndication methods (check `$_POST["bluesky_syndication_accounts"]` in syndicate_post_multi_account).

Run `php -l` on all modified files.
  </action>
  <verify>
Grep for `check_ajax_referer` in BlueSky_AJAX_Service.php -- should appear in ajax_fetch_bluesky_posts and ajax_get_bluesky_profile.
Grep for `current_user_can.*manage_options` in settings template or Settings_Service -- should appear near godmode.
Grep for `sanitize_text_field.*wp_unslash` in BlueSky_Syndication_Service.php -- should appear.
Grep for `current_user_can.*edit_post` in BlueSky_Syndication_Service.php -- should appear.
All files pass `php -l`.
  </verify>
  <done>Three security vulnerabilities fixed: legacy AJAX has nonce checks, godmode requires manage_options, syndication POST data is sanitized with capability check.</done>
</task>

<task type="auto">
  <name>Task 2: Wrap all user-facing strings in i18n functions (PHP + JS)</name>
  <files>classes/BlueSky_AJAX_Service.php, classes/BlueSky_Discussion_Metabox.php, classes/BlueSky_Post_Metabox.php, classes/BlueSky_Assets_Service.php, assets/js/bluesky-async-loader.js</files>
  <action>
**PHP i18n fixes -- wrap strings in __('string', 'social-integration-for-bluesky'):**

Per research i18n audit, fix these specific strings (they may now be in different files due to extraction):

1. "Could not fetch posts" -- now in BlueSky_AJAX_Service.php (was Plugin_Setup:2732)
2. "Could not fetch profile" -- now in BlueSky_AJAX_Service.php (was Plugin_Setup:2747)
3. "Unauthorized" -- now in BlueSky_AJAX_Service.php (was Plugin_Setup:2836)
4. "Invalid permissions" -- now in BlueSky_Discussion_Metabox.php (was Discussion_Display:653)
5. "No Bluesky post information found" -- now in BlueSky_Discussion_Metabox.php (was Discussion_Display:659)
6. "Invalid permissions" (second instance) -- now in BlueSky_Discussion_Metabox.php (was Discussion_Display:685)
7. "Invalid Bluesky post data." -- now in BlueSky_Discussion_Metabox.php or Renderer (was Discussion_Display:210)
8. "Invalid nonce" -- in BlueSky_Post_Metabox.php:355
9. "Invalid nonce" -- in BlueSky_Post_Metabox.php:386

For each, wrap in `__('string', 'social-integration-for-bluesky')`. For strings passed to wp_send_json_error(), use: `wp_send_json_error(__('string', 'social-integration-for-bluesky'))`.

Also scan ALL new service classes for any other unwrapped user-facing strings that may have been introduced. Common patterns: strings in wp_send_json_error(), admin notices, error messages.

**JS i18n -- externalize hardcoded strings in bluesky-async-loader.js:**

1. In `BlueSky_Assets_Service.php` (or wherever wp_localize_script for 'bluesky-async-loader' now lives), add an `i18n` sub-array to the existing `blueskyAsync` localization object. Include ALL 13 strings from the research i18n audit:
   ```php
   'i18n' => [
       'connectionFailed'      => __('Connection to BlueSky failed. Please check your credentials.', 'social-integration-for-bluesky'),
       'missingCredentials'    => __('Handle or app password is not configured.', 'social-integration-for-bluesky'),
       'networkError'          => __('Could not reach BlueSky servers:', 'social-integration-for-bluesky'),
       'rateLimitExceeded'     => __('BlueSky rate limit exceeded. Please wait a few minutes before trying again.', 'social-integration-for-bluesky'),
       'rateLimitResetsAt'     => __('Resets at', 'social-integration-for-bluesky'),
       'authFactorRequired'    => __('BlueSky requires email 2FA verification. Use an App Password instead to bypass 2FA.', 'social-integration-for-bluesky'),
       'accountTakedown'       => __('This BlueSky account has been taken down.', 'social-integration-for-bluesky'),
       'invalidCredentials'    => __('Invalid handle or password. Please check your credentials.', 'social-integration-for-bluesky'),
       'connectionSuccess'     => __('Connection to BlueSky successful!', 'social-integration-for-bluesky'),
       'logoutLink'            => __('Log out from this account', 'social-integration-for-bluesky'),
       'connectionCheckFailed' => __('Could not check connection status.', 'social-integration-for-bluesky'),
       'contentLoadFailed'     => __('Unable to load Bluesky content.', 'social-integration-for-bluesky'),
       'connectionFallback'    => __('Connection failed:', 'social-integration-for-bluesky'),
   ],
   ```

   IMPORTANT: The wp_localize_script call may appear in BOTH admin_enqueue_scripts and frontend_enqueue_scripts. Check which one localizes 'bluesky-async-loader'. The i18n sub-object should be added to whichever call(s) localize this script handle. If both do, add to both (or refactor to a shared method).

2. In `assets/js/bluesky-async-loader.js`, replace each hardcoded English string with its `blueskyAsync.i18n.*` equivalent:
   - `"Connection to BlueSky failed..."` --> `blueskyAsync.i18n.connectionFailed`
   - `"Handle or app password is not configured."` --> `blueskyAsync.i18n.missingCredentials`
   - And so on for all 13 strings

   For strings with dynamic parts (like "Could not reach BlueSky servers: " + error), use concatenation: `blueskyAsync.i18n.networkError + ' ' + errorMessage`

   For "Resets at " + time, use: `blueskyAsync.i18n.rateLimitResetsAt + ' ' + resetTime`

3. Run `php -l` on all modified PHP files.
  </action>
  <verify>
Grep for bare English strings in BlueSky_AJAX_Service.php that should be translated -- should find none (all wrapped in __()).
Grep for `blueskyAsync.i18n` in bluesky-async-loader.js -- should find 13+ references.
Grep for hardcoded "Connection to BlueSky" in bluesky-async-loader.js -- should find zero.
All PHP files pass `php -l`.
  </verify>
  <done>All 9 PHP strings wrapped in i18n functions. All 13 JS strings externalized via blueskyAsync.i18n. Text domain 'social-integration-for-bluesky' used consistently.</done>
</task>

</tasks>

<verification>
- Security: Legacy AJAX has nonce, godmode gated, POST sanitized
- i18n PHP: All 9 identified strings wrapped in __()
- i18n JS: All 13 identified strings use blueskyAsync.i18n.*
- All modified files pass `php -l`
- No hardcoded English strings remain in AJAX error responses
</verification>

<success_criteria>
All 3 security vulnerabilities patched. All user-facing strings in PHP and JS are translatable using text domain 'social-integration-for-bluesky'. No .pot regeneration performed (per locked decision).
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-refactoring/02-05-SUMMARY.md`
</output>
