---
phase: 02-codebase-refactoring
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - templates/admin/settings-page.php
  - templates/frontend/posts-list.php
  - templates/frontend/profile-card.php
  - classes/BlueSky_Settings_Service.php
  - classes/BlueSky_Render_Front.php
autonomous: true
must_haves:
  truths:
    - "Settings page renders identically using template partials"
    - "Posts list renders identically using template partial"
    - "Profile card renders identically using template partial"
  artifacts:
    - path: "templates/admin/settings-page.php"
      provides: "Settings page HTML partial"
      min_lines: 100
    - path: "templates/frontend/posts-list.php"
      provides: "Posts list HTML partial"
      min_lines: 50
    - path: "templates/frontend/profile-card.php"
      provides: "Profile card HTML partial"
      min_lines: 50
  key_links:
    - from: "classes/BlueSky_Settings_Service.php"
      to: "templates/admin/settings-page.php"
      via: "ob_start + include + ob_get_clean"
      pattern: "include.*templates/admin"
    - from: "classes/BlueSky_Render_Front.php"
      to: "templates/frontend/posts-list.php"
      via: "ob_start + include + ob_get_clean"
      pattern: "include.*templates/frontend"
---

<objective>
Extract large HTML blocks from Settings_Service and Render_Front into PHP template partials.

Purpose: render_settings_page (870+ lines of inline HTML), render_bluesky_posts_list (~550 lines), and render_bluesky_profile_card (~200 lines) are the largest maintainability burdens. Extracting to templates makes them editable independently and structures the code for future theme overrides.
Output: Template directory with admin and frontend partials. Methods become thin orchestrators.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-codebase-refactoring/02-RESEARCH.md
@.planning/phases/02-codebase-refactoring/02-02-SUMMARY.md
@classes/BlueSky_Settings_Service.php
@classes/BlueSky_Render_Front.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Settings_Service render_settings_page into template partial</name>
  <files>templates/admin/settings-page.php, classes/BlueSky_Settings_Service.php</files>
  <action>
1. Create `templates/` and `templates/admin/` directories.

2. Read `BlueSky_Settings_Service::render_settings_page()` (the 870+ line method).

3. Extract the HTML body into `templates/admin/settings-page.php`:
   - The template receives variables via the method scope. Before the include, set local variables the template needs:
     ```php
     $options = $this->options;
     $account_manager = $this->account_manager;
     $api_handler = $this->api_handler;
     // ... any other variables the HTML references
     ```
   - The template file is plain PHP/HTML -- it uses `$options`, `$account_manager`, etc. directly (they're in scope from the including method).
   - Move ALL the HTML/PHP output from render_settings_page into the template.
   - Keep any pre-render logic (like handle_account_actions() call, data preparation) in the method.

4. Rewrite render_settings_page() as a thin orchestrator:
   ```php
   public function render_settings_page() {
       $this->handle_account_actions();
       $options = $this->options;
       $account_manager = $this->account_manager;
       $api_handler = $this->api_handler;
       $helpers = $this->helpers;
       // ... any other variables the template uses
       ob_start();
       include BLUESKY_PLUGIN_DIRECTORY . 'templates/admin/settings-page.php';
       echo ob_get_clean();
   }
   ```
   NOTE: Check what constant provides the plugin directory PATH (not URL). It might be `plugin_dir_path(BLUESKY_PLUGIN_FILE)` rather than BLUESKY_PLUGIN_DIRECTORY. The existing constant BLUESKY_PLUGIN_FOLDER is a URL. You may need to define a helper or use `plugin_dir_path(BLUESKY_PLUGIN_FILE)` directly.

5. IMPORTANT: The template must reference `$this` for method calls like `$this->display_cache_status()`. Since $this is not available inside an included file called from a method, you need to either:
   - Use `$service = $this;` before include, then `$service->method()` in template
   - OR keep method calls in the orchestrator and pass their results as variables
   - The cleanest approach: keep $this available (it IS available in included files when include is called from within a method -- PHP scoping rules). Test this.

6. Run `php -l templates/admin/settings-page.php && php -l classes/BlueSky_Settings_Service.php`
  </action>
  <verify>Run `php -l` on both files -- no syntax errors. Verify the method is now under 30 lines. Verify the template file contains the settings page HTML.</verify>
  <done>render_settings_page is a thin orchestrator. All HTML lives in templates/admin/settings-page.php.</done>
</task>

<task type="auto">
  <name>Task 2: Extract Render_Front posts list and profile card into template partials</name>
  <files>templates/frontend/posts-list.php, templates/frontend/profile-card.php, classes/BlueSky_Render_Front.php</files>
  <action>
1. Create `templates/frontend/` directory.

2. Read `BlueSky_Render_Front::render_bluesky_posts_list()` (~550 lines of HTML). Extract the HTML body into `templates/frontend/posts-list.php`:
   - Keep data preparation logic (API calls, filtering, option reading) in the method
   - Move the HTML generation loop into the template
   - Set local variables the template needs before include
   - Use `ob_start()` + `include` + `ob_get_clean()` pattern, returning the result

3. Read `BlueSky_Render_Front::render_bluesky_profile_card()` (~200 lines). Extract HTML into `templates/frontend/profile-card.php`:
   - Same pattern: data prep in method, HTML in template
   - Return ob_get_clean() result

4. For both methods, ensure the refactored versions:
   - Prepare all data variables before the include
   - Do NOT change the method signatures (same parameters, same return type)
   - Do NOT change CSS class names (locked decision: bluesky-social-integration-* preserved)
   - Template files use the same variables the inline HTML used

5. Run `php -l` on all modified/created files.

6. Verify CSS class names are preserved: grep for "bluesky-social-integration" in the new template files -- should find the same classes as the original methods.
  </action>
  <verify>
Run `php -l` on templates/frontend/posts-list.php, templates/frontend/profile-card.php, and classes/BlueSky_Render_Front.php -- no syntax errors.
Grep for "bluesky-social-integration" in template files confirms CSS classes preserved.
  </verify>
  <done>Posts list and profile card HTML extracted to template partials. Render_Front methods are thin orchestrators. CSS class names preserved.</done>
</task>

</tasks>

<verification>
- All template files pass `php -l`
- BlueSky_Settings_Service.php and BlueSky_Render_Front.php pass `php -l`
- render_settings_page is under 30 lines
- render_bluesky_posts_list is under 50 lines
- render_bluesky_profile_card is under 30 lines
- CSS class names "bluesky-social-integration-*" appear in templates (not lost)
- Template directory structure: templates/admin/, templates/frontend/
</verification>

<success_criteria>
Three large HTML blocks extracted to template partials. Methods are thin orchestrators using ob_start/include/ob_get_clean. CSS class names preserved. Templates are plugin-internal only (per locked decision).
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-refactoring/02-04-SUMMARY.md`
</output>
