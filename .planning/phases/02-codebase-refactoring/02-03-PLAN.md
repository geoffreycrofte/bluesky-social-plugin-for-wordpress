---
phase: 02-codebase-refactoring
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - classes/BlueSky_Discussion_Metabox.php
  - classes/BlueSky_Discussion_Renderer.php
  - classes/BlueSky_Discussion_Frontend.php
  - classes/BlueSky_Discussion_Display.php
  - social-integration-for-bluesky.php
  - classes/BlueSky_Plugin_Setup.php
autonomous: true
must_haves:
  truths:
    - "Discussion_Display is replaced by 3 focused classes"
    - "Admin metabox functionality works (add, render, AJAX refresh/unlink)"
    - "Frontend discussion injection works (appends to post content)"
    - "Discussion rendering produces identical HTML output"
  artifacts:
    - path: "classes/BlueSky_Discussion_Metabox.php"
      provides: "Admin metabox + admin AJAX"
      contains: "class BlueSky_Discussion_Metabox"
    - path: "classes/BlueSky_Discussion_Renderer.php"
      provides: "Pure HTML rendering for discussions"
      contains: "class BlueSky_Discussion_Renderer"
    - path: "classes/BlueSky_Discussion_Frontend.php"
      provides: "Frontend injection + scripts"
      contains: "class BlueSky_Discussion_Frontend"
  key_links:
    - from: "classes/BlueSky_Discussion_Frontend.php"
      to: "classes/BlueSky_Discussion_Renderer.php"
      via: "calls renderer methods for HTML generation"
      pattern: "renderer->render"
    - from: "social-integration-for-bluesky.php"
      to: "classes/BlueSky_Discussion_Metabox.php"
      via: "require_once and instantiation"
      pattern: "require_once.*Discussion_Metabox"
---

<objective>
Decompose BlueSky_Discussion_Display (1416 lines) into 3 focused classes: Metabox, Renderer, Frontend.

Purpose: Discussion_Display mixes admin metabox, HTML rendering, and frontend injection concerns. Splitting enables independent testing and clearer responsibility boundaries.
Output: 3 new classes replacing Discussion_Display.
</objective>

<execution_context>
@/Users/CRG/.claude/get-shit-done/workflows/execute-plan.md
@/Users/CRG/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-codebase-refactoring/02-RESEARCH.md
@.planning/phases/02-codebase-refactoring/02-02-SUMMARY.md
@classes/BlueSky_Discussion_Display.php
@social-integration-for-bluesky.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 3 Discussion classes by splitting Discussion_Display</name>
  <files>classes/BlueSky_Discussion_Metabox.php, classes/BlueSky_Discussion_Renderer.php, classes/BlueSky_Discussion_Frontend.php</files>
  <action>
Read BlueSky_Discussion_Display.php fully. Split into 3 classes per the research extraction map.

**BlueSky_Discussion_Renderer.php** (~400 lines, create FIRST -- other classes depend on it):
- Pure rendering, no side effects, no WordPress hooks
- Constructor: receives BlueSky_API_Handler (needed for fetch_and_render_discussion)
- Extract methods: render_post_stats, render_discussion_thread, render_reply, render_reply_media, time_ago, fetch_and_render_discussion, get_discussion_html
- This class is stateless rendering -- methods take data in, return HTML strings
- Properties needed: $api_handler

**BlueSky_Discussion_Metabox.php** (~350 lines):
- Admin metabox registration, rendering, and admin AJAX handlers
- Constructor: receives BlueSky_API_Handler, BlueSky_Account_Manager, BlueSky_Discussion_Renderer (DI, not internal `new`)
- Extract methods: add_discussion_metabox, render_discussion_metabox, enqueue_admin_scripts, ajax_refresh_discussion, ajax_unlink_discussion
- IMPORTANT: The current Discussion_Display constructor does `$this->account_manager = new BlueSky_Account_Manager()`. The new Metabox class must accept it via constructor parameter instead (per research Pitfall 5).
- Properties needed: $api_handler, $account_manager, $renderer, $options

**BlueSky_Discussion_Frontend.php** (~350 lines):
- Frontend content injection and frontend-specific rendering
- Constructor: receives BlueSky_API_Handler, BlueSky_Account_Manager, BlueSky_Discussion_Renderer
- Extract methods: add_discussion_to_content, build_frontend_discussion, render_frontend_discussion, get_frontend_discussion_html, render_frontend_thread, render_frontend_reply, enqueue_frontend_scripts, clear_discussion_caches
- Properties needed: $api_handler, $account_manager, $renderer, $options

For ALL three classes:
- Follow same DI pattern as Plan 02 services
- Replace `$this->account_manager = new BlueSky_Account_Manager()` with constructor injection
- Update all internal method calls: if Metabox calls a render method that now lives in Renderer, use `$this->renderer->method_name()`
- Verify all $this-> references resolve to properties defined in the new class constructor

Run `php -l` on each new file after creation.
  </action>
  <verify>Run `php -l` on all 3 new files -- no syntax errors. Grep for `new BlueSky_Account_Manager()` in the new files -- should find zero results (DI enforced).</verify>
  <done>Three focused Discussion classes exist with proper DI. No internal instantiation of Account_Manager.</done>
</task>

<task type="auto">
  <name>Task 2: Remove Discussion_Display and update plugin wiring</name>
  <files>classes/BlueSky_Discussion_Display.php, social-integration-for-bluesky.php, classes/BlueSky_Plugin_Setup.php</files>
  <action>
1. **Delete or empty BlueSky_Discussion_Display.php:**
   Replace its contents with a comment noting it was decomposed:
   ```php
   <?php
   // BlueSky_Discussion_Display has been decomposed into:
   // - BlueSky_Discussion_Metabox (admin metabox + admin AJAX)
   // - BlueSky_Discussion_Renderer (pure HTML rendering)
   // - BlueSky_Discussion_Frontend (frontend injection + scripts)
   // This file is kept for reference. It can be deleted.
   ```

2. **Update social-integration-for-bluesky.php:**
   - Add require_once for the 3 new classes (before the old Discussion_Display require)
   - Remove or comment out the old Discussion_Display require_once
   - Remove `new BlueSky_Discussion_Display($bluesky_api_handler);`
   - Add instantiation of the 3 new classes:
     ```php
     $bluesky_discussion_renderer = new BlueSky_Discussion_Renderer($bluesky_api_handler);
     $bluesky_discussion_metabox = new BlueSky_Discussion_Metabox($bluesky_api_handler, $bluesky_account_manager, $bluesky_discussion_renderer);
     $bluesky_discussion_frontend = new BlueSky_Discussion_Frontend($bluesky_api_handler, $bluesky_account_manager, $bluesky_discussion_renderer);
     ```

3. **Check if Discussion_Display registered its own hooks in its constructor.**
   Read the original Discussion_Display constructor -- it likely has add_action/add_filter calls. These hook registrations need to move:
   - Option A (preferred): Move them to BlueSky_Plugin_Setup::init_hooks(), delegating to the appropriate new class (Metabox for admin hooks, Frontend for frontend hooks)
   - Option B: Keep them in the new class constructors IF they are self-contained and don't interact with Plugin_Setup's hook order

   Check the original constructor carefully. If it registers hooks like add_action('add_meta_boxes', ...), add_action('the_content', ...), add_action('wp_ajax_*', ...) -- decide where each goes based on the pattern.

4. Run `php -l social-integration-for-bluesky.php && php -l classes/BlueSky_Plugin_Setup.php`
  </action>
  <verify>
Run `php -l social-integration-for-bluesky.php` -- no syntax errors.
Grep for "Discussion_Display" in social-integration-for-bluesky.php -- should not find active instantiation.
Grep for "add_action\|add_filter" across the 3 new Discussion files and Plugin_Setup to verify all hooks are registered.
  </verify>
  <done>Discussion_Display is replaced. Three new classes are loaded and instantiated. All discussion hooks are registered. Plugin file has no syntax errors.</done>
</task>

</tasks>

<verification>
- All 3 new Discussion class files pass `php -l`
- social-integration-for-bluesky.php passes `php -l`
- Plugin_Setup passes `php -l`
- No `new BlueSky_Account_Manager()` inside any Discussion class (DI enforced)
- Old Discussion_Display is emptied/stubbed
- All original discussion hooks are registered somewhere (no lost hooks)
</verification>

<success_criteria>
Discussion_Display is decomposed into 3 classes. Metabox handles admin, Renderer handles HTML, Frontend handles content injection. All receive dependencies via constructor. Plugin loads without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-refactoring/02-03-SUMMARY.md`
</output>
